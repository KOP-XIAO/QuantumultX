/** 
â˜‘ï¸ èµ„æºè§£æå™¨ Â©ğ’ğ¡ğšğ°ğ§  âŸ¦2024-03-14 12:00âŸ§
----------------------------------------------------------
ğŸ›  å‘ç° ğğ”ğ† è¯·åé¦ˆ: https://t.me/Shawn_Parser_Bot
â›³ï¸ å…³æ³¨ ğŸ†ƒğŸ…¶ ç›¸å…³é¢‘é“: https://t.me/QuanX_API
ğŸ“– ä½¿ç”¨ æ•™ç¨‹: https://tinyurl.com/2jyygfom
ğŸ—£ ğŸ†ƒğŸ„·ğŸ„°ğŸ„½ğŸ„ºğŸ…‚ ğŸ†ƒğŸ„¾  @Jamie CHIEN, @M**F**, @c0lada, @Peng-YM, @vinewx, @love4taylor, @shadowdogy 

ğŸ¤– ä¸»è¦åŠŸèƒ½: 
â¶ å°†å…¶å®ƒæ ¼å¼çš„âŸ¦æœåŠ¡å™¨è®¢é˜…âŸ§è§£ææˆ ğğ®ğšğ§ğ­ğ®ğ¦ğ®ğ¥ğ­ ğ— æ ¼å¼
â˜‘ï¸ æ”¯æŒ ğ•2ğ«ğšğ²ğ/ğ—¦ğ—¦(ğ—¥/ğ——)/ğ—›ğ—§ğ—§ğ—£(ğ—¦)/ğ—§ğ—¿ğ—¼ğ—·ğ—®ğ—»/ğ•ğ‹ğ—²ğ¬ğ¬/ğ—¤ğ˜‚ğ—®ğ—»ğ˜ğ˜‚ğ—ºğ˜‚ğ—¹ğ˜(ğ—«)/ğ—¦ğ˜‚ğ—¿ğ—´ğ—²/ğ‚ğ¥ğšğ¬ğ¡/ğ’ğ¡ğšğğ¨ğ°ğ«ğ¨ğœğ¤ğğ­/ğ‹ğ¨ğ¨ğ§ æ ¼å¼
â˜‘ï¸ æä¾›è¯´æ˜ 1âƒ£ï¸ ä¸­çš„å¯é€‰ä¸ªæ€§åŒ–å‚æ•°(ç­›é€‰ã€é‡å‘½å ç­‰)
â· ğ—¿ğ—²ğ˜„ğ—¿ğ—¶ğ˜ğ—²(é‡å†™) & ğ—³ğ—¶ğ—¹ğ˜ğ—²ğ—¿(åˆ†æµ) çš„ è½¬æ¢ & ç­›é€‰ 
â˜‘ï¸ ç”¨äºç¦ç”¨/ä¿®æ”¹è¿œç¨‹å¼•ç”¨ä¸­æŸ(å‡ )é¡¹ ğ—¿ğ—²ğ˜„ğ—¿ğ—¶ğ˜ğ—²/ğ—µğ—¼ğ˜€ğ˜ğ—»ğ—®ğ—ºğ—²/ğ—³ğ—¶ğ—¹ğ˜ğ—²ğ—¿
â˜‘ï¸ ğ’ğ®ğ«ğ ğ/ğ‚ğ¥ğšğ¬ğ¡ ç±»å‹è§„åˆ™ ğ—¹ğ—¶ğ˜€ğ˜ ä¸ æ¨¡å— ğ¦ğ¨ğğ®ğ¥ğ çš„è§£æä½¿ç”¨
----------------------------------------------------------
0ï¸âƒ£ åœ¨ âŸ¦è®¢é˜…é“¾æ¥âŸ§ ååŠ  "#" ä½¿ç”¨, ä¸åŒå‚æ•°ç”¨ "&" è¿æ¥ 
âš ï¸ â˜ "ä½ çš„è®¢é˜…è¿æ¥#emoji=1&tfo=1&in=é¦™æ¸¯+å°æ¹¾"
â– æœ¬åœ°èµ„æºç‰‡æ®µå¼•ç”¨, è¯·å°†å‚æ•°å¦‚ "#in=xxx&out=yyy" å¡«å…¥èµ„æºç‰‡æ®µçš„ç¬¬ â‘  è¡Œ
â– ğŸš¦ æ”¯æŒä¸­æ–‡, "æ“ä½œ" ä»¥ä¸‹ç‰¹æ®Šå­—ç¬¦æ—¶è¯·å…ˆæ›¿æ¢(URL-Encode) ğŸš¦
  âˆ "+"â‡’"%2B", ç©ºæ ¼â‡’"%20", "@"â‡’"%40", "&"â‡’"%26", "."â‡’"\.", ","â‡’"%2C"

1ï¸âƒ£ âŸ¦ğ¬ğğ«ğ¯ğğ« èŠ‚ç‚¹âŸ§ â  å‚æ•°è¯´æ˜:
â¦¿ emoji=1(å›½è¡Œè®¾å¤‡ç”¨2)/-1, æ·»åŠ /åˆ é™¤èŠ‚ç‚¹åå†…åœ°åŒºæ——å¸œ;
â¦¿ udp=1/-1, tfo=1/-1, åˆ†åˆ«å¼ºåˆ¶å¼€å¯(å…³é—­) ğ®ğğ©-ğ«ğğ¥ğšğ²/ğŸğšğ¬ğ­-ğ¨ğ©ğğ§;
â¦¿ uot=1, å¼€å¯ udp-over-tcp=trueé€‰é¡¹ï¼ˆä»…é™SS(R)ï¼‰
â¦¿ cert=1/-1, åˆ†åˆ«å¼€å¯/å…³é—­ ğ­ğ¥ğ¬ è¯ä¹¦éªŒè¯(é»˜è®¤å…³é—­);
  â– csha/psha, tls-cert-sha256 ä»¥åŠ tls-pubkey-sha256 å‚æ•°
  â– alpn, æŒ‡å®šover-tlsç±»å‹èŠ‚ç‚¹çš„alpnå‚æ•°
â¦¿ in, out, regex, regout åˆ†åˆ«ä¸º ä¿ç•™ã€åˆ é™¤ã€æ­£åˆ™ä¿ç•™ã€æ­£åˆ™åˆ é™¤ èŠ‚ç‚¹;
  â– in/out ä»…å¯¹èŠ‚ç‚¹ååŒ¹é…ç”Ÿæ•ˆ, å¤šå‚æ•°(é€»è¾‘"æˆ–")ç”¨ "+", é€»è¾‘"ä¸"ç”¨ "." è¡¨ç¤º;
  â– regex/regout å¯¹èŠ‚ç‚¹çš„å®Œæ•´ä¿¡æ¯è¿›è¡ŒåŒ¹é…(ç±»å‹ã€ç«¯å£ã€åŠ å¯†ç­‰);
  â– ç¤ºèŒƒ: "in=é¦™æ¸¯.0\.2å€ç‡+å°æ¹¾&out=BGP&regex=iplc"
â¦¿ rename é‡å‘½å, "æ—§å@æ–°å", "å‰ç¼€@", "@åç¼€", ç”¨ "+" è¿æ¥å¤šä¸ªå‚æ•°;
  â– åˆ é™¤å­—æ®µ: "å­—æ®µ1.å­—æ®µ2â˜ ï¸", æƒ³åˆ é™¤ "." æ—¶ç”¨ "\." æ›¿ä»£
  â– ç¤ºèŒƒ: "rename=é¦™æ¸¯@ğ‡ğŠ+[ğ’ğ’]@+@[1ğ—]+æµé‡.0\.2â˜ ï¸"
  â– é»˜è®¤ emoji å…ˆç”Ÿæ•ˆ, å¦‚æƒ³è°ƒæ¢é¡ºåº, è¯·ç”¨ rrname å‚æ•°
â¦¿ replace æ­£åˆ™æ›¿æ¢èŠ‚ç‚¹ä¸­å­—æ®µ, å¯ç”¨äºé‡å‘½å/æ›´æ”¹åŠ å¯†æ–¹å¼ç­‰
  â– replace=regex1@ğ˜€ğ˜ğ—¿1+regex2@ğ˜€ğ˜ğ—¿2
â¦¿ ptn/npt=1-8, å°†èŠ‚ç‚¹åè‹±æ–‡/æ•°å­—æ›¿æ¢æˆæ ·å¼ â‡’ ğŸ…°/ğŸ„°/ğ€/ğ—®/ğ”¸/ğ•’/áµƒ/á´¬, â‘ \â¶\â“µ\ğŸ™\Â¹\â‚\ğŸ\ğŸ·
â¦¿ delreg, åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥åˆ é™¤ "èŠ‚ç‚¹å" ä¸­çš„å­—æ®µ(âš ï¸ æ…ç”¨)
â¦¿ aead=-1, å…³é—­ Vmess çš„ AEAD å‚æ•°
â¦¿ host=xxx, ä¿®æ”¹å·²æœ‰ host , å¦‚è¦å¢åŠ hostï¼Œè¯·ç”¨â˜ ï¸ç»“å°¾
â¦¿ obfs=vhttp/shttp, æŒ‡å®š obfs=shadowsocks-http æˆ– obfs=vmess-http çš„ç‰¹æ®Šéœ€æ±‚
â¦¿ tsession=0/1/2, 0/1 ä»£è¡¨å…³é—­ tls-session-ticket/reuseï¼Œ2 è¡¨ç¤ºå…¨éƒ¨å…³é—­
â¦¿ checkurl=xxx , æŒ‡å®š server_check_url å‚æ•°
â¦¿ sort=1/-1/x/å‚æ•°è§„åˆ™, æŒ‰èŠ‚ç‚¹å æ­£/é€†/éšæœº/å‚æ•°è§„åˆ™ æ’åº
  â– å‚æ•°è§„åˆ™æ˜¯æ­£åˆ™è¡¨è¾¾å¼æˆ–ç®€å•å…³é”®è¯, ç”¨"<" æˆ– ">" è¿æ¥
  â– sort=ğŸ‡­ğŸ‡°>ğŸ‡¸ğŸ‡¬>ğŸ‡¯ğŸ‡µ>ğŸ‡ºğŸ‡¸ , é å‰æ’åº
  â– sort=IEPL<IPLC<BGP , é åæ’åº
â¦¿ info=1, å¼€å¯é€šçŸ¥æç¤ºæœºåœº âœˆï¸ æµé‡ä¿¡æ¯(å¦‚æœ‰æä¾›);
â¦¿ flow=2022-06-02:1000:54, è®¢é˜…åˆ°æœŸæ—¶é—´:æ€»æµé‡:å·²ç”¨æµé‡
â¦¿ å ä½ç¬¦ï¼Œå¯ç”¨äº rename/replace ç­‰æ“ä½œ
  â– $type0/1/2/3/4/5/6/7 å ä½ç¬¦ï¼Œå°†èŠ‚ç‚¹ç±»å‹(ss/ssr/vmess ç­‰)ä½œä¸ºå¯æ“ä½œå‚æ•°ï¼Œå¦‚
    âˆ rename=@|$type2
    âˆ æ ·å¼åˆ†åˆ«ä¸º "ğ¬ğ¬","ğ’ğ’","ğŸ…¢ğŸ…¢","ğŸ†‚ğŸ†‚","â“¢â“¢","ğŸ…‚ğŸ…‚","ğ•Šğ•Š","Ë¢Ë¢"
  â– $index0/1/2/3/4/5/6/7/8 å ä½ç¬¦ï¼Œå°†èŠ‚ç‚¹çš„åºå·ä½œä¸ºå¯æ“ä½œå‚æ•°ï¼Œå¦‚
    âˆ rename=@ã€Œ$index1ã€
    âˆ æ ·å¼åˆ†åˆ«ä¸º 1\â‘ \â¶\â“µ\ğŸ™\Â¹\â‚\ğŸ\ğŸ·
  â– $emoji1/2 å ä½ç¬¦, å°†emoji(ğŸ‡­ğŸ‡° ç­‰)ä½œä¸ºå¯æ“ä½œå‚æ•°
    âˆ rename=@ã€Œ$emoji1ã€
  â– $tag å ä½ç¬¦ï¼Œå°†è®¢é˜…çš„ tag ä½œä¸ºå¯æ“ä½œå‚æ•°ï¼Œå¦‚
    âˆ å¯æ¥æ•°å­—ä»¥å•ç‹¬ç»™ tag æ·»åŠ å­—æ¯/æ•°å­—æ ·å¼
    âˆ rename=@ã€Œ$tag34ã€, æ ·å¼åŒä¸‹è¾¹çš„ ptn/npt
â¦¿ âŸ¦è¿›é˜¶å‚æ•°âŸ§: ğ˜€ğ—³ğ—¶ğ—¹ğ˜ğ—²ğ—¿/ğ˜€ğ—¿ğ—²ğ—»ğ—®ğ—ºğ—², ä¼ å…¥ä¸€æ®µ base64 ç¼–ç çš„è„šæœ¬, å¯ç”¨äºæ›´ä¸ºå¤æ‚çš„[è¿‡æ»¤/é‡å‘½å] éœ€æ±‚
  â– è¯´æ˜: https://github.com/KOP-XIAO/QuantumultX/pull/9

2âƒ£ï¸ âŸ¦ğ«ğğ°ğ«ğ¢ğ­ğ é‡å†™âŸ§/âŸ¦ğŸğ¢ğ¥ğ­ğğ« åˆ†æµâŸ§ â  å‚æ•°è¯´æ˜:
â¦¿ in, out, æ ¹æ®å…³é”®è¯ ä¿ç•™/ç¦ç”¨ ç›¸å…³åˆ†æµã€é‡å†™è§„åˆ™;
â¦¿ inhn, outhn, â€œä¿ç•™/åˆ é™¤â€ä¸»æœºå(ğ’‰ğ’ğ’”ğ’•ğ’ğ’‚ğ’ğ’†);
  â– ç¤ºèŒƒ: ç¦ç”¨ "æ·˜å®æ¯”ä»·" åŠ "weibo" çš„ js åŒä¸»æœºå
  ğ¡ğ­ğ­ğ©ğ¬://ğ¦ğ²ğ¥ğ¢ğ¬ğ­#out=tb_price.js+wb_ad.js&outhn=weibo
â¦¿ regex/regout, æ­£åˆ™ä¿ç•™/åˆ é™¤, è¯·è‡ªè¡ŒæŠ˜è…¾æ­£åˆ™è¡¨è¾¾å¼;
  â– å¯ä¸ in(hn)/out(hn) ä¸€èµ·ä½¿ç”¨ï¼Œin(hn)/out(hn) ä¼šä¼˜å…ˆæ‰§è¡Œ;
  â– å¯¹ ğ’‰ğ’ğ’”ğ’•ğ’ğ’‚ğ’ğ’† & ğ«ğğ°ğ«ğ¢ğ­ğ/ğŸğ¢ğ¥ğ­ğğ« åŒæ—¶ç”Ÿæ•ˆ(âš ï¸ æ…ç”¨)
â¦¿ policy å‚æ•°, ç”¨äºç›´æ¥æŒ‡å®šç­–ç•¥ç»„ï¼Œæˆ–ä¸º ğ’ğ®ğ«ğ ğ ç±»å‹ ğ—¿ğ˜‚ğ—¹ğ—²-ğ˜€ğ—²ğ˜ ç”Ÿæˆç­–ç•¥ç»„(é»˜è®¤"ğ’ğ¡ğšğ°ğ§"ç­–ç•¥ç»„);
â¦¿ pset=regex1@policy1+regex2@policy2, ä¸ºåŒä¸€åˆ†æµè§„åˆ™ä¸­ä¸åŒå…³é”®è¯(å…è®¸æ­£åˆ™è¡¨è¾¾å¼)æŒ‡å®šä¸åŒç­–ç•¥ç»„;
â¦¿ replace å‚æ•°, æ­£åˆ™æ›¿æ¢ ğŸğ¢ğ¥ğ­ğğ«/ğ«ğğ°ğ«ğ¢ğ­ğ å†…å®¹, regex@newregex;
  â– å°†æ·˜å®æ¯”ä»·ä¸­è„šæœ¬æ›¿æ¢æˆ lite ç‰ˆæœ¬(å¦‚æœ‰æ­¤ç‰ˆæœ¬çš„è„šæœ¬)
    âˆ replace=(price)(.*)@$1_lite$2
â¦¿ dst=rewrite/filterï¼Œåˆ†åˆ«ä¸ºå°† ğ¦ğ¨ğğ®ğ¥ğ&ğ—¿ğ˜‚ğ—¹ğ—²-ğ˜€ğ—²ğ˜ è½¬æ¢æˆ é‡å†™/åˆ†æµ;
  â– âš ï¸ é»˜è®¤å°† ğ¦ğ¨ğğ®ğ¥ğ è½¬æ¢åˆ°é‡å†™, ğ—¿ğ˜‚ğ—¹ğ—²-ğ˜€ğ—²ğ˜ è½¬æˆåˆ†æµ
  â– âš ï¸ æŠŠ ğ—¿ğ˜‚ğ—¹ğ—²-ğ˜€ğ—²ğ˜ ä¸­ url-regex è½¬æˆé‡å†™æ—¶, å¿…é¡»è¦åŠ  dst=rewrite;
  â– âš ï¸ æŠŠ ğ¦ğ¨ğğ®ğ¥ğ ä¸­çš„åˆ†æµè§„åˆ™è½¬æ¢æ—¶, å¿…é¡»è¦åŠ  dst=filter
â¦¿ cdn=1, å°† github è„šæœ¬çš„åœ°å€è½¬æ¢æˆå…ç¿»å¢™ fastly.jsdelivr.net/gh
â¦¿ fcr=1/2/3, ä¸ºåˆ†æµè§„åˆ™æ·»åŠ  force-cellular/multi-interface/multi-interface-balance å‚æ•°ï¼Œå¼ºåˆ¶ç§»åŠ¨æ•°æ®/æ··åˆæ•°æ®/è´Ÿè½½å‡è¡¡
â¦¿ via=æ¥å£, ä¸ºåˆ†æµè§„åˆ™æ·»åŠ  via-interface å‚æ•°, 0 è¡¨ç¤º via-interface=%TUN%
â¦¿ relay=ç›®æ ‡ç­–ç•¥å, æ‰¹é‡å°†èŠ‚ç‚¹è®¢é˜…è½¬æ¢ä¸ºip/hostè§„åˆ™ï¼Œç”¨äºå®ç°ä»£ç†é“¾

3âƒ£ï¸ å…¶ä»–å‚æ•°
â¦¿ é€šçŸ¥å‚æ•° ntf=0/1, ç”¨äº å…³é—­/æ‰“å¼€ èµ„æºè§£æå™¨çš„æç¤ºé€šçŸ¥
  â– ğ—¿ğ—²ğ˜„ğ—¿ğ—¶ğ˜ğ—²/ğ—³ğ—¶ğ—¹ğ˜ğ—²ğ—¿ é»˜è®¤â€œå¼€å¯â€é€šçŸ¥æç¤º, ä»¥é˜²è§„åˆ™è¯¯åˆ é™¤
  â– ğ˜€ğ—²ğ—¿ğ˜ƒğ—²ğ—¿ èµ„æºè§£æåˆ™é»˜è®¤â€å…³é—­â€œé€šçŸ¥æç¤º
â¦¿ ç±»å‹å‚æ•° type=domain-set/rule/module/list/nodes
  â– å½“è§£æå™¨æœªèƒ½æ­£ç¡®è¯†åˆ«ç±»å‹æ—¶, å¯å°è¯•ä½¿ç”¨æ­¤å‚æ•°å¼ºåˆ¶æŒ‡å®š
â¦¿ éšè—å‚æ•° hide=0, ç¦ç”¨ç­›é™¤çš„åˆ†æµ/é‡å†™ï¼Œé»˜è®¤æ–¹å¼ä¸ºåˆ é™¤
â¦¿ profile=111 , URL-Scheme æ·»åŠ  QuanX ç±»å‹é…ç½®ä¸­è¿œç¨‹èµ„æº
----------------------------------------------------------
*/

/**
* ä½¿ç”¨è¯´æ˜ï¼Œ
0ï¸âƒ£ åœ¨QuantumultX é…ç½®æ–‡ä»¶ä¸­[general] éƒ¨åˆ†ï¼ŒåŠ å…¥ 
resource_parser_url = https://raw.githubusercontent.com/KOP-XIAO/QuantumultX/master/Scripts/resource-parser.js
âš ï¸âš ï¸å¦‚æç¤º"æ²¡æœ‰è‡ªå®šä¹‰è§£æå™¨"ï¼Œè¯·é•¿æŒ‰å³ä¸‹è§’å›¾æ ‡åç‚¹å‡»å·¦ä¾§åˆ·æ–°æŒ‰é’®ï¼Œæ›´æ–°èµ„æºï¼Œåå°é€€å‡º appï¼Œç›´åˆ°å‡ºç°è§£æå™¨è¯´æ˜

------------------------------
*/

//beginning è§£æå™¨æ­£å¸¸ä½¿ç”¨ï¼Œèª¿è©¦è¨»é‡‹æ­¤éƒ¨åˆ†

let [link0, content0, subinfo] = [$resource.link, $resource.content, $resource.info]
let version = typeof $environment != "undefined" ? Number($environment.version.split("build")[1]): 0 // ç‰ˆæœ¬å·
let Perror = 0 //é”™è¯¯ç±»å‹

const subtag = typeof $resource.tag != "undefined" ? $resource.tag : "";
////// é raw é“¾æ¥çš„æ²™é›•æƒ…å½¢
content0 = content0.indexOf("DOCTYPE html") != -1 && link0.indexOf("github.com") != -1 ? ToRaw(content0) : content0 ;
//ends æ­£å¸¸ä½¿ç”¨éƒ¨åˆ†ï¼Œèª¿è©¦è¨»é‡‹æ­¤éƒ¨åˆ†


var para = /^(http|https)\:\/\//.test(link0) ? link0 : content0.split("\n")[0];
var para1 = para.slice(para.indexOf("#") + 1).replace(/\$type/g,"node_type_para_prefix").replace(/\$emoji/g,"node_emoji_flag_prefix").replace(/\$tag/g,"node_tag_prefix").replace(/\$index/g,"node_index_prefix") //é˜²æ­¢å‚æ•°ä¸­å…¶å®ƒä½ç½®ä¹Ÿå­˜åœ¨"#"
var mark0 = para.indexOf("#") != -1 ? true : false; //æ˜¯å¦æœ‰åƒæ•¸éœ€è¦è§£æ
var Pinfo = mark0 && para1.indexOf("info=") != -1 ? para1.split("info=")[1].split("&")[0] : 0;
var ntf_flow = 0;
//å¸¸ç”¨é‡
const Base64 = new Base64Code();
const escapeRegExp = str => str.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&'); //å¤„ç†ç‰¹æ®Šç¬¦å·ä»¥ä¾¿æ­£åˆ™åŒ¹é…ä½¿ç”¨
var link1 = link0.split("#")[0]
const qxpng = "https://raw.githubusercontent.com/crossutility/Quantumult-X/master/quantumult-x.png" // server sub-info link
const subinfo_link = { "open-url": "https://t.me/QuanX_API", "media-url": "https://shrtm.nu/ebAr" };
const subinfo_link1 = { "open-url": link1, "media-url": "https://shrtm.nu/uo13" } // server sub-info link(fake-nodes)
const rwrite_link = { "open-url": link1, "media-url": "https://shrtm.nu/x3o2" } // rewrite filter link
const rwhost_link = { "open-url": link1, "media-url": "https://shrtm.nu/0n5J" } // hostname filter link
const rule_link = { "open-url": link1, "media-url": "https://shrtm.nu/cpHD" } // rule filter link
const nan_link = { "open-url": link1, "media-url": qxpng } // nan error link
const bug_link = { "open-url": "https://t.me/Shawn_Parser_Bot", "media-url": "https://shrtm.nu/obcB" } // bug link
const sub_link = { "open-url": link1, "media-url": "https://shrtm.nu/ebAr" } // server link
const update_link = {"open-url" : "https://apps.apple.com/us/app/quantumult-x/id1443988620", "media-url": qxpng}
const plink0 = {"open-url" : link0, "media-url": qxpng} // è·³è½¬è®¢é˜…é“¾æ¥

if(version == 0) { $notify("âš ï¸ è¯·æ›´æ–° Quantumult X è‡³æœ€æ–°å•†åº—ç‰ˆæœ¬\n","ğŸš¦ å½“å‰ç‰ˆæœ¬å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨éƒ¨åˆ†åŠŸèƒ½","\nğŸ‘‰ ç‚¹å‡»è·³è½¬å•†åº—é“¾æ¥æ›´æ–°",update_link) }

const ADDRes = `quantumult-x:///add-resource?remote-resource=url-encoded-json`
var RLink0 = {
  "filter_remote": [],
  "rewrite_remote": [],
  "server_remote": [],
}
const Field = {
  "filter" : "filter_remote",
  "rewrite": "rewrite_remote",
  "server" : "server_remote"
}  


SubFlow() //æµé‡é€šçŸ¥


// å‚æ•°è·å–
var Pin0 = mark0 && para1.indexOf("in=") != -1 ? (para1.split("in=")[1].split("&")[0].split("+")).map(decodeURIComponent) : null;
var Pout0 = mark0 && (para.indexOf("#out=") != -1 || para.indexOf("&out=") != -1)? ((para.indexOf("#out=")!=-1? para.split("#out="): para.split("&out="))[1].split("&")[0].split("+")).map(decodeURIComponent) : null;
var Psfilter = mark0 && para1.indexOf("sfilter=") != -1 ? Base64.decode(para1.split("sfilter=")[1].split("&")[0]) : null; // script filter
var Preg = mark0 && para1.indexOf("regex=") != -1 ? decodeURIComponent(para1.split("regex=")[1].split("&")[0]).replace(/\ï¼Œ/g,",") : null; //serveræ­£åˆ™è¿‡æ»¤å‚æ•°
var Pregout = mark0 && para1.indexOf("regout=") != -1 ? decodeURIComponent(para1.split("regout=")[1].split("&")[0]).replace(/\ï¼Œ/g,",") : null; //serveræ­£åˆ™åˆ é™¤å‚æ•°
var Pregdel = mark0 && para1.indexOf("delreg=") != -1 ? decodeURIComponent(para1.split("delreg=")[1].split("&")[0]).replace(/\ï¼Œ/g,",") : null; // æ­£åˆ™åˆ é™¤å‚æ•°
var Phin0 = mark0 && para1.indexOf("inhn=") != -1 ? (para1.split("inhn=")[1].split("&")[0].split("+")).map(decodeURIComponent) : null; //hostname 
var Phout0 = mark0 && para1.indexOf("outhn=") != -1 ? (para1.split("outhn=")[1].split("&")[0].split("+")).map(decodeURIComponent) : null; //hostname
var Preplace = mark0 && para1.indexOf("replace=") != -1 ? para1.split("replace=")[1].split("&")[0] : null; //filter/rewrite æ­£åˆ™æ›¿æ¢
var Pemoji = mark0 && para1.indexOf("emoji=") != -1 ? para1.split("emoji=")[1].split("&")[0] : null;
var Pdbg = mark0 && para1.indexOf("dbg=") != -1 ? para1.split("dbg=")[1].split("&")[0] : null;
var Pudp0 = mark0 && para1.indexOf("udp=") != -1 ? para1.split("udp=")[1].split("&")[0] : 0;
var Ptfo0 = mark0 && para1.indexOf("tfo=") != -1 ? para1.split("tfo=")[1].split("&")[0] : 0;
//var Prname = mark0 && para1.indexOf("rename=") != -1 ? para1.split("rename=")[1].split("&")[0].split("+") : null;
var Prname = mark0 && /(^|\&)rename=/.test(para1) ? para1.split(/(^|\&)rename\=/)[2].split("&")[0].split("+") : null;
var Psrename = mark0 && para1.indexOf("srename=") != -1 ? Base64.decode(para1.split("srename=")[1].split("&")[0]) : null; // script rename
var Prrname = mark0 && para1.indexOf("rrname=") != -1 ? para1.split("rrname=")[1].split("&")[0].split("+") : null;
var Psuffix = mark0 && para1.indexOf("suffix=") != -1 ? para1.split("suffix=")[1].split("&")[0] : 0;
var Ppolicy = mark0 && para1.indexOf("policy=") != -1 ? decodeURIComponent(para1.split("policy=")[1].split("&")[0]) : "Shawn";
var Ppolicyset = mark0 && para1.indexOf("pset=") != -1 ? decodeURIComponent(para1.split("pset=")[1].split("&")[0]) : "";
var Pcert0 = mark0 && para1.indexOf("cert=") != -1 ? para1.split("cert=")[1].split("&")[0] : 0;
var Psort0 = mark0 && para1.indexOf("sort=") != -1 ? para1.split("sort=")[1].split("&")[0] : 0;
var PsortX = mark0 && para1.indexOf("sortx=") != -1 ? para1.split("sortx=")[1].split("&")[0] : 0;
var PTls13 = mark0 && para1.indexOf("tls13=") != -1 ? para1.split("tls13=")[1].split("&")[0] : 0;
var Pntf0 = mark0 && para1.indexOf("ntf=") != -1 ? para1.split("ntf=")[1].split("&")[0] : 2;
var Phide = mark0 && para1.indexOf("hide=") != -1 ? para1.split("hide=")[1].split("&")[0] : 1;
var Pb64 = mark0 && para1.indexOf("b64=") != -1 ? para1.split("b64=")[1].split("&")[0] : 0;
var emojino = [" 0ï¸âƒ£ ", " 1âƒ£ï¸ ", " 2âƒ£ï¸ ", " 3âƒ£ï¸ ", " 4âƒ£ï¸ ", " 5âƒ£ï¸ ", " 6âƒ£ï¸ ", " 7âƒ£ï¸ ", " 8âƒ£ï¸ ", " 9âƒ£ï¸ ", " ğŸ”Ÿ "]
var pfi = mark0 &&Pin0 ? "in=" + Pin0.join(", ") + ",  " : ""
var pfo = mark0 &&Pout0 ? "out=" + Pout0.join(", ") : ""
var pfihn = mark0 &&Phin0 ? "inhn=" + Phin0.join(", ") + ",  " : ""
var pfohn = mark0 &&Phout0 ? "outhn=" + Phout0.join(", ") : ""
var Pcnt =  mark0 &&para1.indexOf("cnt=") != -1 ? para1.split("cnt=")[1].split("&")[0] : 0;
var Pcap = mark0 &&para1.indexOf("cap=") != -1 ? para1.split("cap=")[1].split("&")[0] : "";
var Pptn = mark0 &&para1.indexOf("ptn=") != -1 ? para1.split("ptn=")[1].split("&")[0] : ""; //èŠ±å¼è‹±æ–‡å­—ç¬¦
var Pnptn = mark0 &&para1.indexOf("npt=") != -1 ? para1.split("npt=")[1].split("&")[0] : ""; //èŠ±å¼æ•°å­—
var Pcdn = mark0 &&para1.indexOf("cdn=") != -1 ? para1.split("cdn=")[1].split("&")[0] : "";
let [flow, exptime, errornode, total] = "";
var Pdel = mark0 && para1.indexOf("del=") != -1 ? para1.split("del=")[1].split("&")[0] : 0; //åˆ é™¤é‡å¤èŠ‚ç‚¹
var typeU = mark0 && para1.indexOf("type=") != -1 ? para1.split("type=")[1].split("&")[0] : "";
var Pfcr = mark0 && para1.indexOf("fcr=") != -1 ? para1.split("fcr=")[1].split("&")[0] : ""; // force-cellular ç­‰å‚æ•°
var Pvia = mark0 && para1.indexOf("via=") != -1 ? para1.split("via=")[1].split("&")[0] : ""; // via-interface å‚æ•°
var Paead = mark0 && para1.indexOf("aead=") != -1 ? para1.split("aead=")[1].split("&")[0] : ""; // vmess aead å‚æ•°
var Phost = mark0 && ( para.indexOf("#host=") != -1 || para.indexOf("&host=") != -1) ? (para.indexOf("#host=")!=-1? para.split("#host="): para.split("&host="))[1].split("&")[0] : ""; // host æ··æ·†å‚æ•°
var Pcsha256 = mark0 && para1.indexOf("csha=") != -1 && version >= 646? para1.split("csha=")[1].split("&")[0] : ""; // cert-sha256 æ··æ·†å‚æ•°
var Ppsha256 = mark0 && para1.indexOf("psha=") != -1 && version >= 646? para1.split("psha=")[1].split("&")[0] : ""; // pubkey-sha256 æ··æ·†å‚æ•°
var typeQ = $resource.type? $resource.type:"unsupported"   //è¿”å› field ç±»å‹å‚æ•°
var PRelay =mark0 && para1.indexOf("relay=") != -1 ? decodeURIComponent(para1.split("relay=")[1].split("&")[0]) : ""; // èŠ‚ç‚¹ relay å‚æ•°, ç”¨äºå®ç°ä»£ç†é“¾åŠŸèƒ½
var PUOT = mark0 && para1.indexOf("uot=") != -1 && version >= 665? para1.split("uot=")[1].split("&")[0] : ""; // èŠ‚ç‚¹ udp-over-tcp å¼€å¯
var PcheckU = mark0 && para1.indexOf("checkurl=") != -1 ? decodeURIComponent(para1.split("checkurl=")[1].split("&")[0]) : ""; // èŠ‚ç‚¹ server_check_url å‚æ•°
typeQ = PRelay!=""? "server":typeQ
var typec="" //check result type
var Pflow=mark0 && para1.indexOf("flow=") != -1 ? para1.split("flow=")[1].split("&")[0] : 0; // æµé‡æ—¶é—´ç­‰å‚æ•°
var PProfile = mark0 && para1.indexOf("profile=") != -1 ? para1.split("profile=")[1].split("&")[0] : 0; // é€šè¿‡URL-Schemeå¯¼å…¥å®Œæ•´é…ç½®å‚æ•°
var Palpn = mark0 && para1.indexOf("alpn=") != -1 && version >= 712? para1.split("alpn=")[1].split("&")[0] : ""; // over-tls ç±»å‹ï¼Œalpnå‚æ•°
var Pobfs = mark0 && para1.indexOf("obfs=") != -1 && version >= 770? para1.split("obfs=")[1].split("&")[0] : ""; // æŒ‡å®šç‰¹æ®Šæƒ…å†µä¸‹çš„ obfs=xx-http ç±»å‹
var Psession =  mark0 && para1.indexOf("tsession=") != -1 && version >= 771? para1.split("tsession=")[1].split("&")[0] : "";//tls-no-session-ticket and tls-no-session-reuse
// 0/1 ä»£è¡¨å…³é—­ session-ticket/reuseï¼Œ2 è¡¨ç¤ºå…¨éƒ¨å…³é—­ã€‚

var RegoutList= [] ;//ç”¨äº regoutå‚æ•°åˆ é€‰æé†’
// URL-Scheme å¢åŠ é…ç½®
var ADDres = `quantumult-x:///add-resource?remote-resource=url-encoded-json`
var RLink = `{
  "server_remote": [
    sremoteposition
  ],
  "filter_remote": [
    fremoteposition
  ],
  "rewrite_remote": [
    rremoteposition
  ]
}`

var ProfileInfo = {
  "server":"",
  "filter":"",
  "rewrite":""
}

function VCheck(cnt) {
  cnts=cnt.split("\n").filter(Boolean).map(item=>item.trim()).filter(item => /^http/.test(item)).map(item=>"\""+item+"\"")
  cnts=cnts.join(",\n")
  //console.log(cnts)
  return  cnts
  }

function Profile_Handle() {
  let a = content0
  PProfile= PProfile==1? "001":PProfile
  PProfile= PProfile==8? "010": PProfile
  PProfile= PProfile==9? "011": PProfile
  srm = a.split("[server_remote]")[1] && String(PProfile)[0]=="1"? VCheck(a.split("[server_remote]")[1].split("[")[0]) : ""
  frm = a.split("[filter_remote]")[1] && String(PProfile)[1]=="1"? VCheck(a.split("[filter_remote]")[1].split("[")[0]) : ""
  rrm = a.split("[rewrite_remote]")[1] && String(PProfile)[2]=="1"? VCheck(a.split("[rewrite_remote]")[1].split("[")[0]) : ""
  RLink=RLink.replace("sremoteposition",srm).replace("fremoteposition",frm).replace("rremoteposition",rrm)
  ADDres=ADDres.replace("url-encoded-json",encodeURIComponent(RLink))
}

//
//æµé‡ä¿¡æ¯
//{bytes_used: 1073741824, bytes_remaining: 2147483648, expire_date: 1653193966}}
var Finfo={}
if (Pflow!=0) {
  Pflow = Pflow.split(":")
  var Bdate=Date.parse(new Date(Pflow[0]))/1000
  var Btotal=Pflow[1]? Pflow[1]*1024*1024*1024 : 0
  var Bused=Pflow[2]? Pflow[2]*1024*1024*1024 : 0
  var Bremain=Btotal !=0 ? Btotal-Bused : 1
  var BJson={bytes_used: Bused, bytes_remaining: Bremain, expire_date: Bdate}
  //$notify("Flow","",JSON.strigify(BJson))
  Finfo = BJson
}

//èŠ±æ¼¾å­— pattern
var pat=[]
pat[0] = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","k","r","s","t","u","v","w","x","y","z"]
pat[1] = ["ğŸ…°","ğŸ…±","ğŸ…²","ğŸ…³","ğŸ…´","ğŸ…µ","ğŸ…¶","ğŸ…·","ğŸ…¸","ğŸ…¹","ğŸ…º","ğŸ…»","ğŸ…¼","ğŸ…½","ğŸ…¾","ğŸ…¿","ğŸ…º","ğŸ†","ğŸ†‚","ğŸ†ƒ","ğŸ†„","ğŸ†…","ğŸ††","ğŸ†‡","ğŸ†ˆ","ğŸ†‰"]
pat[2] = ["ğŸ„°","ğŸ„±","ğŸ„²","ğŸ„³","ğŸ„´","ğŸ„µ","ğŸ„¶","ğŸ„·","ğŸ„¸","ğŸ„¹","ğŸ„º","ğŸ„»","ğŸ„¼","ğŸ„½","ğŸ„¾","ğŸ„¿","ğŸ„º","ğŸ…","ğŸ…‚","ğŸ…ƒ","ğŸ…„","ğŸ……","ğŸ…†","ğŸ…‡","ğŸ…ˆ","ğŸ…‰"]
pat[3] = ["ğ€","ğ","ğ‚","ğƒ","ğ„","ğ…","ğ†","ğ‡","ğˆ","ğ‰","ğŠ","ğ‹","ğŒ","ğ","ğ","ğ","ğŠ","ğ‘","ğ’","ğ“","ğ”","ğ•","ğ–","ğ—","ğ˜","ğ™"]
pat[4] = ["ğ—®","ğ—¯","ğ—°","ğ—±","ğ—²","ğ—³","ğ—´","ğ—µ","i","ğ—·","ğ—¸","ğ—¹","ğ—º","ğ—»","ğ—¼","ğ—½","ğ—¸","ğ—¿","ğ˜€","ğ­","ğ˜‚","ğ˜ƒ","ğ˜„","ğ˜…","ğ˜†","ğ˜‡"]
pat[5] = ["ğ”¸","ğ”¹","â„‚","ğ”»","ğ”¼","ğ”½","ğ”¾","â„","ğ•€","ğ•","ğ•‚","ğ•ƒ","ğ•„","â„•","ğ•†","â„™","ğ•‚","â„","ğ•Š","ğ•‹","ğ•Œ","ğ•","ğ•","ğ•","ğ•","â„¤"]
pat[6] = ["ğ•’","ğ•“","ğ•”","ğ••","ğ•–","ğ•—","ğ•˜","ğ•™","ğ•š","ğ•›","ğ•œ","ğ•","ğ•","ğ•Ÿ","ğ• ","ğ•¡","ğ•œ","ğ•£","ğ•¤","ğ•¥","ğ•¦","ğ•§","ğ•¨","ğ•©","ğ•ª","ğ•«"]
pat[7] = ["áµƒ","áµ‡","á¶œ","áµˆ","áµ‰","á¶ ","áµ","Ê°","â±","Ê²","áµ","Ë¡","áµ","â¿","áµ’","áµ–","áµ’âƒ’","Ê³","Ë¢","áµ—","áµ˜","áµ›","Ê·","Ë£","Ê¸","á™†"]
pat[8] = ["á´¬","á´®","á’¼","á´°","á´±","á¶ ","á´³","á´´","á´µ","á´¶","á´·","á´¸","á´¹","á´º","á´¼","á´¾","á´¼Ì´","á´¿","Ë¢","áµ€","áµ","áµ›","áµ‚","Ë£","Ê¸","á™†"]

// èŠ±å¼æ•°å­—
var patn=[]
patn[0] = ["0","1","2","3","4","5","6","7","8","9"]
patn[1] = [ 'â“ª', 'â‘ ', 'â‘¡', 'â‘¢', 'â‘£', 'â‘¤', 'â‘¥', 'â‘¦', 'â‘§', 'â‘¨' ]
patn[2] = [ 'â“ª', 'â¶', 'â·', 'â¸', 'â¹', 'âº', 'â»', 'â¼', 'â½', 'â¾' ]
patn[3] = [ 'â“ª', 'â“µ', 'â“¶', 'â“·', 'â“¸', 'â“¹', 'â“º', 'â“¼', 'â“»', 'â“½' ]
patn[4] = [ 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ', 'ğŸŸ', 'ğŸ ', 'ğŸ¡' ]
patn[5] = [ 'â°', 'Â¹', 'Â²', 'Â³', 'â´', 'âµ', 'â¶', 'â·', 'â¸', 'â¹' ]
patn[6] = [ 'â‚€', 'â‚', 'â‚‚', 'â‚ƒ', 'â‚„', 'â‚…', 'â‚†', 'â‚‡', 'â‚ˆ', 'â‚‰' ]
patn[7] = ["ğŸ","ğŸ","ğŸ","ğŸ‘","ğŸ’","ğŸ“","ğŸ”","ğŸ³","ğŸ–","ğŸ—"]
patn[8] = ["ğŸ¶","ğŸ·","ğŸ¸","ğŸ¹","ğŸº","ğŸ»","ğŸ¼","ğŸ½","ğŸ¾","ğŸ¿"]

//é¿å…json undefinedé”™è¯¯çš„ å‡½æ•°
const getValue = (fn, defaultVaule) => {
  try {
    return fn();
  } catch (error) {
    return defaultVaule;
  }
};

var type0=""
//flag=1,2,3åˆ†åˆ«ä¸º serverã€rewriteã€rule ç±»å‹
var flag = 1

function Parser() {
  type0 = Type_Check(content0); //  ç±»å‹åˆ¤æ–­
  //$notify(type0)
  if (type0 != "web" && type0 != "wrong-field" && type0 != "JS-0"){
    try {
      //$notify(type0,"hh")
      if (Pdbg){
        $notify(link0,type0,content0)
      }
      total = ResourceParse();
      
    } catch (err) {
      if(Perror == 0) {
      $notify("âŒ è§£æå‡ºç°é”™è¯¯", "âš ï¸ è¯·ç‚¹å‡»é€šçŸ¥ï¼Œå‘é€è®¢é˜…é“¾æ¥è¿›è¡Œåé¦ˆ", err, bug_link);
    }
    }
  } else if (type0 == "wrong-field"){
    if (version >= 670 && typec!="") { //å°è¯•è·³è½¬åˆ°æ­£ç¡®ç±»å‹
      RLink0[Field[typec]].push($resource.link+", opt-parser=true, tag=ä¸‹æ¬¡æ·»åŠ èµ„æºğŸ‰‘ï¸é•¿ç‚¹â¤ï¸8âƒ£ï¸") //  è·³è½¬URI-Scheme
      var flink = ADDRes.replace(/url-encoded-json/,encodeURIComponent(JSON.stringify(RLink0)))
      const bug_linkx = { "open-url": flink, "media-url": "https://shrtm.nu/obcB" } // bug linkx
    $notify( "âš ï¸ è¯·ç‚¹å‡»é€šçŸ¥è·³è½¬å°è¯•æ·»åŠ åˆ°æ­£ç¡®ç±»å‹ä¸­","âŒ æ£€æµ‹ç±»å‹["+typec+"]"+"ä¸å¡«å…¥ç±»å‹"+"["+typeQ+"]å†²çª", "å¦‚æœè·³è½¬æ·»åŠ ä»æ—§å¤±è´¥ï¼Œè¯·å‘é€é“¾æ¥åé¦ˆè§£æå™¨bot\n"+$resource.link, bug_linkx)
    } else {//æ—§ç‰ˆæœ¬
    $notify("âŒ æ£€æµ‹ç±»å‹ã€Œ"+typec+" ã€"+"ä¸ç›®æ ‡ç±»å‹"+" ã€Œ"+typeQ+" ã€å†²çª", "âš ï¸ è¯·è‡ªè¡Œæ£€æŸ¥é“¾æ¥å†…å®¹ï¼Œæˆ–ç‚¹å‡»é€šçŸ¥å‘é€é“¾æ¥è¿›è¡Œåé¦ˆ", $resource.link, bug_link)
    }
    total=""
  } else {
    total=""
  }
    $done({ content: total });
}

if (typeof($resource)!=="undefined" && PProfile == 0) {
  Parser()
  $done({ content: total, info: Finfo })
} else if (PProfile != 0) {
  try {
    Profile_Handle()
  } catch (err) {
    if(Perror == 0) {
      $notify("âŒ è§£æå‡ºç°é”™è¯¯", "âš ï¸ è¯·ç‚¹å‡»é€šçŸ¥ï¼Œå‘é€è®¢é˜…é“¾æ¥è¿›è¡Œåé¦ˆ", err, bug_link);
    }
    }
  openlink = {"open-url": ADDres}
  $notify("âš ï¸è¯·å¿½ç•¥æŠ¥é”™æç¤º, ç‚¹å‡»æ­¤é€šçŸ¥è·³è½¬", "æ·»åŠ é…ç½®ä¸­çš„æœ‰æ•ˆè¿œç¨‹èµ„æºğŸ‘‡ ["+ PProfile+"]", ADDres,openlink)
  total = ProfileInfo[typeQ]
  $done({content:total})
}


/**
# ä»¥ä¸‹ä¸ºå…·ä½“çš„ function

*/

function ParseUnknown(cnt){
  try {
    cnt = JSON.parse(cnt)
    if(cnt) {
      $notify("âš ï¸ é“¾æ¥è¿”å›å†…å®¹å¹¶éæœ‰æ•ˆè®¢é˜…"+ "âŸ¦" + subtag + "âŸ§","â‰ï¸ è¯·è‡ªè¡Œæ£€æŸ¥åŸå§‹é“¾æ¥ï¼Œè¿”å›å†…å®¹ ğŸ‘‡ï¸ğŸ‘‡ï¸",JSON.stringify(cnt), bug_link)
    }
    
  } catch(err) {
    if (!/error|block|invalid|support/.test(cnt.toLowerCase())) {
    $notify("ğŸ˜­ æœªèƒ½è¯†åˆ«è®¢é˜… " + "âŸ¦" + subtag + "âŸ§ çš„å†…å®¹",  "âš ï¸ å°†å°è¯•ç›´æ¥å¯¼å…¥Quantumult X \n å¦‚è®¤ä¸ºæ˜¯ BUG, è¯·ç‚¹é€šçŸ¥è·³è½¬å¹¶ [å‘é€é“¾æ¥] åé¦ˆ", "è®¢é˜…è¿”å›å†…å®¹: ğŸ‘‡ \n"+cnt, bug_link);
  } else {
    $notify("ğŸ’¢ âŸ¦" + subtag + "âŸ§ è¿”å›å†…å®¹æ— æ•ˆ",  "ğŸ˜  è¯·è‡ªè¡Œæ£€æŸ¥è®¢é˜…ï¼Œä¸è¦è·‘æ¥åé¦ˆ", "è®¢é˜…è¿”å›å†…å®¹: ğŸ‘‡ \n"+cnt, plink0);
  }
}
}


function ResourceParse() {
  //é¢„å¤„ç†ï¼Œåˆ†æµ/é‡å†™ç­‰å¤„ç†å®Œæˆ
  if (type0 == "Subs-B64Encode") { // subs2QX è´Ÿè´£æ‰€æœ‰èŠ‚ç‚¹çš„è½¬æ¢
    if (Pdbg) {$notify("original content", "node-b64", content0)}
    total = Subs2QX(Base64.decode(content0), Pudp0, Ptfo0, Pcert0, PTls13);
  } else if (type0 == "Subs") {
    //$notify("subs","",content0+Pudp0+Ptfo0+Pcert0+PTls13)
    total = Subs2QX(content0, Pudp0, Ptfo0, Pcert0, PTls13);
  } else if (type0 == "QuanX" || type0 == "Clash" || type0 == "Surge") {
    total = Subs2QX(isQuanX(content0).join("\n"), Pudp0, Ptfo0, Pcert0, PTls13);
  } else if (type0 == "sgmodule") { // surge module æ¨¡å—/å« url-regex çš„ rule-set
    //2023-03-06 è€ƒè™‘æ¨¡å—é‡å†™ä¸quanxç±»å‹é‡å†™çš„æ··æ­
    flag = 2 
    //total = SGMD2QX(content0) // è½¬æ¢ 
    total = Rewrite_Filter(isQuanXRewrite(content0.split("\n")), Pin0, Pout0,Preg,Pregout);//Rewrite_Filter(total, Pin0, Pout0,Preg,Pregout); // ç­›é€‰è¿‡æ»¤
    if (Preplace) { total = ReplaceReg(total, Preplace) }
    total = total.filter( (ele,pos)=>total.indexOf(ele) == pos); //é‡å†™é‡å¤æ£€æŸ¥
    if (Pcdn) {total = CDN(total)
    } else { total = total.join("\n")}
  } else if (type0 == "rewrite") { // rewrite ç±»å‹
    flag = 2;
    total = Rewrite_Filter(isQuanXRewrite(content0.split("\n")), Pin0, Pout0,Preg,Pregout);
    if (Preplace) { total = ReplaceReg(total, Preplace) }
    // rewriteé‡å¤æ£€æµ‹
    total = total.filter( (ele,pos)=>total.indexOf(ele) == pos);
    if (Pcdn) {total = CDN(total)
    } else {total = total.join("\n")}
  } else if (type0 == "Rule") {  // rule ç±»å‹, å·²å¤„ç†å®Œæ¯•
    flag = 3;
    total = Rule_Handle(content0.split("\n").map(item=>item.trim()).filter(Boolean), Pout0, Pin0).filter(Boolean);
    if (Preg && total.length!=0) { // æ­£åˆ™ç­›é€‰è§„åˆ™ filter
    total = total.map(Regex).filter(Boolean) 
    RegCheck(total, "åˆ†æµå¼•ç”¨", "regex", Preg)
  } 
    if (Pregout && total.length!=0) { // æ­£åˆ™åˆ é™¤è§„åˆ™ filter
    total = total.map(RegexOut).filter(Boolean)
    RegCheck(total, "åˆ†æµå¼•ç”¨", "regout", Pregout)
  }
    if (Preplace) { total = ReplaceReg(total, Preplace) }
    if (Ppolicyset) {total = policy_sets(total, Ppolicyset)}
      // filter é‡å¤æ£€æµ‹
    total = total.length<100? total.filter( (ele,pos)=>total.indexOf(ele) == pos) : total
    total = total.join("\n")
  } else if (content0.trim() == "") {
    $notify("â€¼ï¸ å¼•ç”¨" + "âŸ¦" + subtag + "âŸ§" + " è¿”å›å…§å®¹ä¸ºç©º", "â‰ï¸ ç‚¹é€šçŸ¥è·³è½¬ä»¥ç¡®è®¤é“¾æ¥æ˜¯å¦å¤±æ•ˆ", para.split("#")[0], nan_link);
    flag = 0;
  } else if (type0 == "sub-http") {
    let url = VCheck(String(Base64.decode(content0.split("sub://")[1].split("#")[0])+", opt-parser=true, tag="+(new Date()).getTime()))
     RLink = RLink.replace("sremoteposition",url).replace("fremoteposition","").replace("rremoteposition","")
    let ADDres0 = ADDres.replace("url-encoded-json",encodeURIComponent(RLink))
    openlink = {"open-url": ADDres0}
    $notify("âš ï¸ è¯¥é“¾æ¥ä¸ºèŠ‚ç‚¹è®¢é˜…, è¯·ç‚¹å‡»æ­¤é€šçŸ¥è·³è½¬æ·»åŠ ", url, ADDres0,openlink)
    flag = -1
    total = ""
  } else if (type0 == "unknown") {
    ParseUnknown(content0)
    flag = -1;
  } else if (type0 == "profile") {
    PProfile = "111" //é»˜è®¤æ·»åŠ æ‰€æœ‰éƒ¨åˆ†
    Profile_Handle()
    openlink = {"open-url": ADDres}
    $notify("âš ï¸ è¯¥é“¾æ¥ä¸ºå®Œæ•´é…ç½®æ–‡ä»¶, è¯·ç‚¹å‡»æ­¤é€šçŸ¥è·³è½¬", "æ·»åŠ é…ç½®ä¸­çš„æœ‰æ•ˆè¿œç¨‹èµ„æºğŸ‘‡ ["+ PProfile+"]", ADDres, openlink)
    flag = -1;
    total = ""
  } else if (type0 == "JS-0") {
    total = ""
  }

  //å¼€å§‹å¤„ç†
  if (flag == 1) { //server ç±»å‹ç»Ÿä¸€å¤„ç†
    total = isQuanX(total.filter(Boolean).join("\n"))
    if (Pinfo == 1 && ntf_flow == 0) { //å‡èŠ‚ç‚¹ç±»å‹çš„æµé‡é€šçŸ¥
      flowcheck(total)
    }
    if (Pin0 || Pout0) { total = Filter(total, Pin0, Pout0) } // in & out 
    if (Preg) { total = total.map(Regex).filter(Boolean)  // regex
      RegCheck(total, "èŠ‚ç‚¹è®¢é˜…", "regex", Preg)} 
    if (Pregout) { total = total.map(RegexOut).filter(Boolean)  // regex out
      RegCheck(total, "èŠ‚ç‚¹è®¢é˜…", "regout", Pregout)} 
    if (Psfilter) { total = FilterScript(total, Psfilter) }
    if (Prrname) {
      Prn = Prrname;
      total = total.map(Rename);
    }
    //if (Pemoji) { total = emoji_handle(total, Pemoji); }
    if (Pregdel) {
      delreg = Pregdel
      total = total.map(DelReg)
    }
    //script rename ç½®äºå…¶å®ƒå‚æ•°ä¹‹å‰
    if (Psrename) { total = RenameScript(total, Psrename) }
    if (Preplace) { // server ç±»å‹ä¹Ÿå¯ç”¨ replace å‚æ•°è¿›è¡Œé‡å‘½åæ“ä½œ
      total = ReplaceReg(total, Preplace)
    }
    if (Prname) {
      Prn = Prname;
      total = total.map(Rename);
      if(Pdbg==1) {$notify("rename","content",total)}
    }
    //2023-07-10 è°ƒæ•´emojiæ“ä½œé¡ºåº
    if (Pemoji) { total = emoji_handle(total, Pemoji); }
    if (total.length > 0){
      if (Psuffix==1 || Psuffix==-1) {total = Psuffix == 1? total.map(type_suffix):total.map(type_prefix)
      }
      total = total.map(type_handle).map(emoji_prefix_handle).map(tag_handle) //å„ç±»èŠ‚ç‚¹åæ“ä½œ
      if (Psort0) { //æ’åºæ“ä½œ
        total = QXSort(total, Psort0);
      }
      total = para1.indexOf("node_index_prefix")!=-1 ?index_handle(total):total // èŠ‚ç‚¹åºå·æ“ä½œ
      //$notify("before","haha",total)
      total = TagCheck_QX(total).join("\n") //èŠ‚ç‚¹åæ£€æŸ¥
      if (PUOT==1) { total = total.split("\n").map(UOT).join("\n")}
      if (Pcnt == 1) {$notify("âŸ¦" + subtag + "âŸ§"+"è§£æåæœ€ç»ˆè¿”å›å†…å®¹" , "èŠ‚ç‚¹æ•°é‡: " +total.split("\n").length, total)}
      total = PRelay==""? Base64.encode(total) : ServerRelay(total.split("\n"),PRelay) //å¼ºåˆ¶èŠ‚ç‚¹ç±»å‹ base64 åŠ å¯†åå†å¯¼å…¥ Quantumult X, å¦‚æœæ˜¯relayï¼Œåˆ™è½¬æ¢æˆåˆ†æµç±»å‹
      if(Pflow==1) {
        //$notify("æ·»åŠ æµé‡ä¿¡æ¯","xxx","xxxx")
        $done({ content: total, info: {bytes_used: 3073741824, bytes_remaining: 2147483648, expire_date: 1854193966}});
      //$notify("done?","strange")
      } else { $done({ content: total });}
    } else {
      if(Perror == 0) {
      $notify("â“â“ å‹æƒ…æç¤º âŸ "+ "âŸ¦" + subtag + "âŸ§", "âš ï¸âš ï¸ è§£æåæ— æœ‰æ•ˆå†…å®¹", "ğŸš¥ğŸš¥ è¯·è‡ªè¡Œæ£€æŸ¥ç›¸å…³å‚æ•°, æˆ–è€…ç‚¹å‡»é€šçŸ¥è·³è½¬å¹¶å‘é€é“¾æ¥åé¦ˆ", bug_link)
    }
      total = errornode
      $done({ content: errornode })
    }
  } else if (flag == 0){ //ç©º/é”™è¯¯ç±»å‹
    total = errornode
    $done({ content: errornode })
  } else if (flag == -1){ //æœªçŸ¥ç±»å‹
    total = content0
    $done({ content: content0 })
  } 
  if (Pcnt == 1 && flag !=1) {$notify("è§£æåæœ€ç»ˆè¿”å›å†…å®¹" , "æ€»æ•°é‡ï¼š " +total.split("\n").length, total)}
  return total
  
}

//å“åº”å¤´æµé‡å¤„ç†éƒ¨åˆ†
function SubFlow() {
  if (Pinfo == 1 && subinfo) {
    var sinfo = subinfo.replace(/ /g, "").toLowerCase();
    var total = "æ€»æµé‡: " + (parseFloat(sinfo.split("total=")[1].split(",")[0]) / (1024 ** 3)).toFixed(2) + "GB";
    var usd = "å·²ç”¨æµé‡: " + ((parseFloat(sinfo.indexOf("upload")!=-1?sinfo.split("upload=")[1].split(",")[0]:"0") + parseFloat(sinfo.split("download=")[1].split(",")[0])) / (1024 ** 3)).toFixed(2) + "GB"
    var left = "å‰©ä½™æµé‡: " + ((parseFloat(sinfo.split("total=")[1].split(",")[0]) / (1024 ** 3)) - ((parseFloat(sinfo.indexOf("upload")!=-1?sinfo.split("upload=")[1].split(",")[0]:"0") + parseFloat(sinfo.split("download=")[1].split(",")[0])) / (1024 ** 3))).toFixed(2) + "GB"
    if (sinfo.indexOf("expire=") != -1) {
      var epr = new Date(parseFloat(sinfo.split("expire=")[1].split(",")[0]) * 1000);
      var year = epr.getFullYear();  // è·å–å®Œæ•´çš„å¹´ä»½(4ä½,1970)
      var mth = epr.getMonth() + 1 < 10 ? '0' + (epr.getMonth() + 1) : (epr.getMonth() + 1);  // è·å–æœˆä»½(0-11,0ä»£è¡¨1æœˆ,ç”¨çš„æ—¶å€™è®°å¾—åŠ ä¸Š1)
      var day = epr.getDate() < 10 ? "0" + (epr.getDate()) : epr.getDate();
      epr = "è¿‡æœŸæ—¶é—´: " + year + "-" + mth + "-" + day
    } else {
      epr = ""; //"è¿‡æœŸæ—¶é—´: âœˆï¸ æœªæä¾›è©²ä¿¡æ¯" //æ²¡è¿‡æœŸæ—¶é—´çš„æ˜¾ç¤ºè®¢é˜…é“¾æ¥
    }
    var message = total + "\n" + usd + ", " + left;
    ntf_flow = 1;
    $notify("æµé‡ä¿¡æ¯: âŸ¦" + subtag + "âŸ§", epr, message, subinfo_link)
  }
//  } else if (Pinfo ==1){
//    $notify("æµé‡ä¿¡æ¯: âŸ¦" + subtag + "âŸ§", "", "âš ï¸ è¯¥è®¢é˜…é“¾æ¥æœªè¿”å›ä»»ä½•æµé‡ä¿¡æ¯", subinfo_link)
//  }
}

//flowcheck-fake-server
function flowcheck(cnt) {
    for (var i = 0; i < cnt.length; i++) {
        var item = cnt[i];
        var nl = item.slice(item.indexOf("tag"))
        var nm = nl.slice(nl.indexOf("=") + 1)
        if (item.indexOf("å‰©ä½™æµé‡") != -1) {
            flow = nm
        } else if (item.indexOf("æœŸæ—¶é—´") != -1) {
            exptime = nm
        }
    }
  flow = flow? flow:"âš ï¸ è¯¥è®¢é˜…æœªè¿”å›ä»»ä½•æµé‡ä¿¡æ¯"
  exptime = exptime? exptime:"âš ï¸ è¯¥è®¢é˜…æœªè¿”å›å¥—é¤æ—¶é—´ä¿¡æ¯"
    if (flow != "") { $notify("æµé‡ä¿¡æ¯: âŸ¦" + subtag + "âŸ§", flow, exptime, subinfo_link1) }
}

// regex åçš„æ£€æŸ¥
function RegCheck(total, typen, paraname,regpara) {
  if(total.length == 0){ 
    $notify("â€¼ï¸ " + typen + "  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç­›é€‰æ­£åˆ™: " + paraname + "=" + regpara, "âš ï¸ ç­›é€‰åå‰©ä½™é¡¹ä¸º 0ï¸âƒ£ , è¯·æ£€æŸ¥æ­£åˆ™å‚æ•°åŠåŸå§‹é“¾æ¥", nan_link)
  }else if((typen != "èŠ‚ç‚¹è®¢é˜…" && Pntf0 !=0) || (typen == "èŠ‚ç‚¹è®¢é˜…" && Pntf0 ==1)){
    var nolist = total.length <= 10 ? emojino[total.length] : total.length
    $notify("ğŸ¤– " + typen + "  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç­›é€‰æ­£åˆ™: " + paraname + "=" + regpara, "âš ï¸ ç­›é€‰åå‰©ä½™ä»¥ä¸‹" + nolist + "ä¸ªåŒ¹é…é¡¹ \n â¨· " + total.join("\n â¨· "), sub_link)
  }
}
//åˆ¤æ–­è®¢é˜…ç±»å‹
function Type_Check(subs) {
    var type = "unknown"
    var RuleK = ["host,", "-suffix,", "domain,", "-keyword,", "ip-cidr,", "ip-cidr6,",  "geoip,", "user-agent,", "ip6-cidr,", "ip-asn"];
    var DomainK = ["domain-set,"]
    var QuanXK = ["shadowsocks=", "trojan=", "vmess=", "http=", "socks5="];
    var SurgeK = ["=ss,", "=vmess,", "=trojan,", "=http,", "=custom,", "=https,", "=shadowsocks", "=shadowsocksr", "=sock5", "=sock5-tls"];
    var ClashK = ["proxies:"]
    var SubK = ["dm1lc3M", "c3NyOi8v", "CnNzOi8", "dHJvamFu", "c3M6Ly", "c3NkOi8v", "c2hhZG93", "aHR0cDovLw", "aHR0cHM6L", "CnRyb2phbjo", "aHR0cD0", "aHR0cCA","U1RBVFVT"];
    var RewriteK = [" url 302", " url 307", " url reject", " url script", " url req", " url res", " url echo", " url-and-header 302", " url-and-header 307", " url-and-header reject", " url-and-header script", " url-and-header req", " url-and-header res", " url-and-header echo"] // quantumult X ç±»å‹ rewrite
    var SubK2 = ["ss://", "vmess://", "ssr://", "trojan://", "ssd://", "\nhttps://", "\nhttp://","socks://","ssocks://","vless://"];
    var ModuleK = ["[Script]", "[Rule]", "[URL Rewrite]", "[Map Local]", "\nhttp-r", "script-path"]
    var QXProfile = ["[filter_local]","[filter_remote]","[server_local]","[server_remote]"]
    var html = "DOCTYPE html"
    var subi = subs.replace(/ /g, "")
    const RuleCheck = (item) => subi.toLowerCase().indexOf(item) != -1;
    const NodeCheck = (item) => subi.toLowerCase().indexOf(item.toLowerCase()) != -1;
    const NodeCheck1 = (item) => subi.toLowerCase().indexOf(item.toLowerCase()) != -1; //b64åŠ å¯†çš„è®¢é˜…ç±»å‹
    const NodeCheck2 = (item) => subi.toLowerCase().indexOf(item.toLowerCase()) != -1; //URI ç±»å‹
    const RewriteCheck = (item) => subs.indexOf(item) != -1 ; // quanx é‡å†™åˆ¤å®š
    const ProfileCheck = (item) => subs.indexOf(item) != -1; //æ˜¯å¦ä¸ºquanxé…ç½®æ–‡ä»¶
    var subsn = subs.split("\n")
    if ( (subs.indexOf(html) != -1 || subs.indexOf("doctype html") != -1) && link0.indexOf("github.com" == -1)) {
      $notify("â€¼ï¸ è¯¥é“¾æ¥è¿”å›ä¸ºæ— æ•ˆç½‘é¡µå†…å®¹"+ " âŸ " + "âŸ¦" + subtag + "âŸ§", "â‰ï¸ ç‚¹é€šçŸ¥è·³è½¬ä»¥ç¡®è®¤é“¾æ¥æ˜¯å¦å¤±æ•ˆ\n"+link0, "è¿”å›å†…å®¹å¦‚ä¸‹â¬‡ï¸ï¼š\n"+subs, nan_link);
      type = "web";
    } else if (typeU == "nodes" && typeQ=="server") { //æŒ‡å®šä¸ºèŠ‚ç‚¹ç±»å‹
      type = (typeQ == "unsupported" || typeQ =="server")? "Subs":"wrong-field"
    } else if (ClashK.some(NodeCheck) || typeU == "clash"){ // Clash ç±»å‹èŠ‚ç‚¹è½¬æ¢
      type = (typeQ == "unsupported" || typeQ =="server")? "Clash":"wrong-field";
      typec = "server"
      content0 = Clash2QX(subs)
    } else if ( (((ModuleK.some(RewriteCheck) || para1.indexOf("dst=rewrite") != -1) && (para1.indexOf("dst=filter") == -1) && subs.indexOf("[Proxy]") == -1) || typeU == "module") && typeU != "nodes" && typeU != "rule" && typeQ !="filter") { // Surge ç±»å‹ module /rule-set(å«url-regex) ç±»å‹
      typec="rewrite"
      type = (typeQ == "unsupported" || typeQ =="rewrite")? "sgmodule" : "wrong-field"
    } else if ((/(^hostname|\nhostname)\s*\=/.test(subi) || RewriteK.some(RewriteCheck))  && para1.indexOf("dst=filter")==-1 && subi.indexOf("securehostname") == -1 && !/module|nodes|rule/.test(typeU) && !(RuleK.some(RuleCheck) && typeQ == "filter") && !(typeQ!= "rewrite" && QXProfile.some(ProfileCheck))) {
      // 2022-07-20 remove constrain && !/\[(Proxy|filter_local)\]/.test(subs)
      typec = "rewrite"
      type = (typeQ == "unsupported" || typeQ =="rewrite")? "rewrite":"wrong-field" //Quantumult X ç±»å‹ rewrite/ Surge Script/
    } else if (((RuleK.some(RuleCheck) && subs.indexOf(html) == -1 ) || typeU == "rule" || para1.indexOf("dst=filter")!=-1) && typeU != "nodes" && !(typeQ == "server" && (QuanXK.some(NodeCheck) || SurgeK.some(NodeCheck))) ) {
      // rule/filterç±»å‹
      // 2022-07-20 remove constrain && !/\[(Proxy|server_local)\]/.test(subs) adter html
      typec = "filter"
      type = (typeQ == "unsupported" || typeQ =="filter")? "Rule":"wrong-field";
    } else if (typeU == "domain-set") {// ä»…é™ç”¨æˆ·æŒ‡å®šä¸º domain-setï¼›((DomainK.some(RuleCheck) || typeU == "domain-set") && subs.indexOf("[Proxy]") == -1 && typeU != "nodes") {
      typec = "filter-domain-set"
      type = (typeQ == "unsupported" || typeQ =="filter")? "Rule":"wrong-field";
      content0 = Domain2Rule(content0) // è½¬æ¢ domain-set
    } else if (typeQ == "filter" && subs.indexOf("payload:")==-1) { // çº¯ listç±»å‹ï¼Ÿ
      typec = "filter-list"
      type = (typeQ == "unsupported" || typeQ =="filter")? "Rule":"wrong-field";
      content0 = content0.split("\n").map(rule_list_handle).join("\n")
    } else if (subi.indexOf("sub://") == 0) { // sub:// ç±»å‹
      typec = "sub-http"
      type = "sub-http"
    } else if (typeQ == "filter" && subs.indexOf("payload:")!=-1) { // clash-provider ç±»å‹ï¼Ÿ
      typec = "Clash-Provider"
      type = (typeQ == "unsupported" || typeQ =="filter")? "Rule":"wrong-field";
    } else if (subsn.length >= 1 && SubK2.some(NodeCheck2) && !/\[(Proxy|filter_local)\]/.test(subs)) { //æœªb64åŠ å¯†çš„å¤šè¡ŒURI ç»„åˆè®¢é˜…
      typec = "server-uri"
      type= (typeQ == "unsupported" || typeQ =="server" || typeQ =="uri") ? "Subs":"wrong-field"
    } else if ((subi.indexOf("tag=") != -1 && QuanXK.some(NodeCheck) && !/\[(Proxy|filter_local)\]/.test(subs)) || typeU =="list") {
      typec = "server-quanx"
      type = (typeQ == "unsupported" || typeQ =="server" || typeQ =="uri")? "Subs":"wrong-field" // QuanX list
    } else if (subs.indexOf("[Proxy]") != -1) {
      typec= "server-surge"
      type = (typeQ == "unsupported" || typeQ =="server" || typeQ =="uri")? "Surge":"wrong-field"; // Surge Profiles
      content0 = Surge2QX(content0).join("\n");
    } else if ((SurgeK.some(NodeCheck)  && !/\[(Proxy|filter_local)\]/.test(subs)) || typeU == "list") {
      typec="server-surge"
      type = (typeQ == "unsupported" || typeQ =="server" || typeQ =="uri")? "Subs":"wrong-field" // Surge proxy list
    } else if (subs.indexOf("[server_local]") != -1 && QuanXK.some(NodeCheck)) {
      //type = "QuanX"  // QuanX Profile
      typec="server-quanx"
      type = (typeQ == "unsupported" || typeQ =="server"|| typeQ =="uri")? "Subs":"wrong-field"
    } else if (content0.indexOf("server") !=-1 && content0.indexOf("server_port") !=-1) { //SIP008
      //type = "QuanX"
      typec= "server-sip008"
      type = (typeQ == "unsupported" || typeQ =="server")? "Subs":"wrong-field"
      content0 = SIP2QuanX(content0)
    } else if (SubK.some(NodeCheck1)) {  //b64åŠ å¯†çš„è®¢é˜…ç±»å‹
      typec="server-b64"
      type = (typeQ == "unsupported" || typeQ =="server")? "Subs-B64Encode":"wrong-field"
      if (content0.split("\n").length >= 2) { //  local snippet and first line remarks
        let tmp = content0.split("\n")[1]
        if (Pdbg) {$notify("local", "node", "\ntmp:\n"+tmp)}
        if (SubK.some((item) => tmp.toLowerCase().indexOf(item.toLowerCase()) != -1))
        content0 = tmp
      }
    } else if (QXProfile.every(ProfileCheck)) {
      typec = "profile"
      type = "profile"  //é»˜è®¤é…ç½®ç±»å‹
    }else if (/\.js/.test(link0)) { // xjbæ·»åŠ jsè„šæœ¬çš„è¡Œä¸º
      Perror = 1 ; // æ— éœ€åé¦ˆ
      $notify("âš ï¸ ä½ å¯¼å…¥çš„é“¾æ¥å†…å®¹ä¸º JS è„šæœ¬","ğŸš¥ è„šæœ¬å†…æœªæœ‰é‡å†™è§„åˆ™ï¼Œæ— æ³•è§£æä½¿ç”¨", " è¯·âš ï¸ä¸è¦âš ï¸è·‘æ¥è§£æå™¨ğŸ¤–ï¸åé¦ˆ \n"+link0)
      type = "JS-0"
    } else if (typeQ =="server" && subs.length>100) { // ä¸€äº›æœªçŸ¥çš„b64 encode server case
      typec="server-b64-unknown"
      type = (typeQ == "unsupported" || typeQ =="server")? "Subs-B64Encode":"wrong-field"
    } //else if (typeQ == "URI")
  // ç”¨äºé€šçŸ¥åˆ¤æ–­ç±»å‹ï¼Œdebug
  if(typeU == "X"){
    $notify("è¯¥é“¾æ¥åˆ¤å®šç±»å‹",type+" : " +typec, subs)
  }
  //$notify(type)
    return type
}

// æ£€æŸ¥èŠ‚ç‚¹åå­—(é‡å¤ä»¥åŠç©ºå)ç­‰QuanX ä¸å…è®¸çš„æƒ…å½¢ï¼Œä»¥åŠå¤šä¸ªç©ºæ ¼ç­‰â€œä¸è§„èŒƒâ€æ–¹å¼
function TagCheck_QX(content) {
  typefix = {"shadowsocks":["ğ¬ğ¬","ğ’ğ’","ğŸ…¢ğŸ…¢","ğŸ†‚ğŸ†‚","â“¢â“¢","ğŸ…‚ğŸ…‚","SS"],"shadowsocksr":["ğ¬ğ¬ğ«","ğ’ğ’ğ‘","ğŸ…¢ğŸ…¢ğŸ…¡","ğŸ†‚ğŸ†‚ğŸ†","â“¢â“¢â“¡","ğŸ…‚ğŸ…‚ğŸ…","SSR"],"vmess":["ğ¯ğ¦ğğ¬ğ¬","ğ•ğŒğ„ğ’ğ’","ğŸ…¥ğŸ…œğŸ…”ğŸ…¢ğŸ…¢","ğŸ†…ğŸ…¼ğŸ…´ğŸ†‚ğŸ†‚","â“¥â“œâ“”â“¢â“¢","ğŸ……ğŸ„¼ğŸ„´ğŸ…‚ğŸ…‚","VMESS"],"trojan":["ğ­ğ«ğ¨ğ£ğšğ§","ğ“ğ‘ğğ‰ğ€ğ","ğŸ…£ğŸ…¡ğŸ…ğŸ…™ğŸ…ğŸ…","ğŸ†ƒğŸ†ğŸ…¾ğŸ…¹ğŸ…°ğŸ…½","â“£â“¡â“â“™â“â“","ğŸ…ƒğŸ…ğŸ„¾ğŸ„¹ğŸ„°ğŸ„½","TROJAN"],"http":["ğ¡ğ­ğ­ğ©","ğ‡ğ“ğ“ğ","ğŸ…—ğŸ…£ğŸ…£ğŸ…Ÿ","ğŸ…·ğŸ†ƒğŸ†ƒğŸ…¿","â“—â“£â“£â“Ÿ","ğŸ„·ğŸ…ƒğŸ…ƒğŸ„¿","HTTP"],"socks5":["ğ¬ğ¨ğ—°ğ—¸ğ¬","ğ’ğğ‚ğŠğ’","ğŸ…¢ğŸ…ğŸ…’ğŸ…šğŸ…¢","ğŸ†‚ğŸ…¾ğŸ…²ğŸ…ºğŸ†‚","â“¢â“„â’¸â“€â“¢","ğŸ…‚ğŸ„¾ğŸ„²ğŸ„ºğŸ…‚","SOCKS"],"vless":["ğ¯ğ¥ğğ¬ğ¬","ğ•ğ‹ğ„ğ’ğ’","ğŸ…¥ğŸ…›ğŸ…”ğŸ…¢ğŸ…¢","ğŸ†…ğŸ…»ğŸ…´ğŸ†‚ğŸ†‚","â“¥â“›â“”â“¢â“¢","ğŸ……ğŸ„»ğŸ„´ğŸ…‚ğŸ…‚","VLESS"]}
  console.log(content)
    var Olist = content.map(item =>item.trim())//.replace(/\s{2,}/g," "))
    //$notify("","",Olist)
    var [Nlist, nmlist] = [ [], [] ]
    var [nulllist,duplist] = [ [], [] ]; //è®°å½•ç©ºåå­—èŠ‚ç‚¹&é‡åèŠ‚ç‚¹
    var no=0 ;
    for (var i = 0; i < Olist.length; i++) {
        var item = Olist[i] ? Olist[i] : ""
        typefix["shadowsocks"]=item.indexOf("ssr-protocol")!=-1? typefix["shadowsocksr"] : typefix["shadowsocks"]
        if (item.replace(/ /gm, "").indexOf("tag=") != -1) {
            var nl = item.slice(item.indexOf("tag"))
            var nm = nl.slice(nl.indexOf("=") + 1)
            if (nm == "") { //ç©ºå
                tp = typefix[item.split("=")[0].trim()][3]
                nm = tp + " | " + item.split("=")[1].split(",")[0].split(":")[0]
                item = item.split("tag")[0] + "tag=" + nm.replace("shadowsocks", "ss")
                nulllist.push(nm.replace("shadowsocks", "ss"))
            }
            var ni = 0
            while (nmlist.indexOf(nm) != -1) { //é‡åæƒ…å½¢
              //$notify("é‡å",nm,nmlist)
                nm = ni==0? nm+ NoReplace(ni+1):nm.split(" ").slice(0,nm.split(" ").length-2).join(" ") + NoReplace(ni+1)
                item = Pdel != 1 ? item.split("tag")[0] + "tag=" + nm : ""
                ni = ni + 1
            }
            if (ni != 0) { duplist.push(nm) }
            nmlist.push(nm)
          if (Pcap) { 
            item = Capitalize(item,Pcap)
            console.log(item)
          }
          if (Pptn || Pnptn) { 
            item = Pattern(item,Pptn,Pnptn)
            console.log(item)
          }
            ni = 0
            if (item) {
            Nlist.push(item)
          }
        }// if "tag="
    } // for
    // å¢åŠ  server_check_url å‚æ•°
    if (PcheckU != "") {
      Nlist = Nlist.map(Add_URL)
    }
    if (nulllist.length >= 1) {
        no = nulllist.length <= 10 ? emojino[nulllist.length] : nulllist.length;
        $notify("âš ï¸ å¼•ç”¨" + "âŸ¦" + subtag + "âŸ§" + " å†…æœ‰" + no + "ä¸ªç©ºèŠ‚ç‚¹å ", "âœ… å·²å°†èŠ‚ç‚¹â€œç±»å‹+IPâ€è®¾ä¸ºèŠ‚ç‚¹å", " â¨ " + nulllist.join("\n â¨ "), nan_link)
    }
    if (duplist.length >= 1) {
        no = duplist.length <= 10 ? emojino[duplist.length] : duplist.length;
      if (Pdel!=1 && Pntf0 != 0){
        $notify("âš ï¸ å¼•ç”¨" + "âŸ¦" + subtag + "âŸ§" + " å†…æœ‰" + no + "ä¸ªåå­—é‡å¤çš„èŠ‚ç‚¹ ", "âœ… å·²æ·»åŠ æ•°å­—åŒºåˆ†, åˆ é™¤è¯·æ·»åŠ å‚æ•° del=1:", " â¨ " + duplist.join("\n â¨ "), nan_link)
      } else if (Pdel ==1 && Pntf0 != 0) {
        $notify("âš ï¸ å¼•ç”¨" + "âŸ¦" + subtag + "âŸ§" + " å†…æœ‰" + no + "ä¸ªåå­—é‡å¤çš„èŠ‚ç‚¹ ", "âŒï¸ å·²å…¨éƒ¨åˆ é™¤ï¼Œå¦‚éœ€ä¿ç•™è¯·å»é™¤å‚æ•° del=1:", " â¨ " + duplist.join("\n â¨ "), nan_link)
      }
    }
    return Nlist
}

// ä¸ºèŠ‚ç‚¹æ·»åŠ  server-check-urlå‚æ•°
function Add_URL(cnt) {
  if (cnt) {
    cnt = cnt +", server_check_url="+PcheckU
  }
  return cnt
}

//èŠ‚ç‚¹åé‡åæ—¶æ·»åŠ æ•°å­—åºå·æ›¿æ¢
function NoReplace(cnt) {
  if(cnt){
    for (var i=0;i<10;i++) {
      cnt = cnt.toString().replace(new RegExp(patn[0][i], "gmi"),patn[5][i])
    }
    return " " + cnt + " "
  }
}


// å¯¹èŠ‚ç‚¹åpatternåŒ–æ“ä½œ
function PatternN(cnt, para,npara) {
  if(cnt){
    if(para!=""){//å­—ç¬¦
      for (var i=0;i<26;i++) {
        cnt = cnt.toLowerCase()
        cnt = cnt.replace(new RegExp(pat[0][i], "gmi"),pat[para][i])
      }
    }
    if(npara!=""){ //æ•°å­—
      for (var i=0;i<10;i++) {
        cnt = cnt.replace(new RegExp(patn[0][i], "gmi"),patn[npara][i])
      }
    }
    console.log(cnt)
    return cnt
  }
}


function Pattern(cnt,para,npara) {
  if (para != "" || npara != "") {
    cnt = cnt.split("tag=")[0] +"tag="+ PatternN(cnt.split("tag=")[1],para,npara)
  }
  return cnt 
}


//å¤§å°å†™
function Capitalize(cnt,para) {
  if (para == 1) {
    cnt = cnt.split("tag=")[0] +"tag="+ cnt.split("tag=")[1].toUpperCase()
  } else if (para == -1) {
    cnt = cnt.split("tag=")[0] +"tag="+ cnt.split("tag=")[1].toLowerCase()
  } else if (para == 0) {
    cnt =cnt.split("tag=")[0] +"tag="+titleCase(cnt.split("tag=")[1])
  }
  return cnt
}

function titleCase(str) {
  var newStr = str.split(" ");
  for(var i = 0; i<newStr.length; i++){
    newStr[i] = newStr[i].slice(0,1).toUpperCase() + newStr[i].slice(1).toLowerCase();
  }    return newStr.join(" ");
}


// ç±»å‹å‰ç¼€/åç¼€
function type_prefix(item) {
  if(item.trim()!="") {
    typefix = {"shadowsocks":"ã€Œğ¬ğ¬ã€","vmess":"ã€Œğ¯ğ¦ğğ¬ğ¬ã€","trojan":"ã€Œğ­ğ«ğ¨ğ£ğšğ§ã€","http":"ã€Œğ¡ğ­ğ­ğ©ã€","socks5":"ã€Œğ¬ğ¨ğ—°ğ—¸ğ¬ã€","vless":"ã€Œğ¯ğ¥ğğ¬ğ¬ã€"}
    typefix["shadowsocks"]=item.indexOf("ssr-protocol")!=-1? "ã€Œğ¬ğ¬ğ«ã€" : "ã€Œğ¬ğ¬ã€"
    tp = typefix[item.split("=")[0].trim()]
    return [[item.split("tag=")[0]+
      "tag=", tp, item.split("tag=")[1]].join(" ")].join(" ")
  }
}
function type_suffix(item) {
  if(item.trim()!=""){
    typefix={"shadowsocks":"ã€Œğ¬ğ¬ã€","vmess":"ã€Œğ¯ğ¦ğğ¬ğ¬ã€","trojan":"ã€Œğ­ğ«ğ¨ğ£ğšğ§ã€","http":"ã€Œğ¡ğ­ğ­ğ©ã€","vless":"ã€Œğ¯ğ¥ğğ¬ğ¬ã€"}
    typefix["shadowsocks"]=item.indexOf("ssr-protocol")!=-1? "ã€Œğ¬ğ¬ğ«ã€" : "ã€Œğ¬ğ¬ã€"
    tp = typefix[item.split("=")[0].trim()]
    return [item, tp].join(" ")
  }
}

//è·å–ç±»å‹
function getnode_type(item,ind) {
  if(item.trim()!="" && item.indexOf("tag=")!=-1) {
    ind = !/^(0|1|2|3|4|5|6|7)$/.test(ind) ? 8 : ind
    typefix = {"shadowsocks":["ğ¬ğ¬","ğ’ğ’","ğŸ…¢ğŸ…¢","ğŸ†‚ğŸ†‚","â“¢â“¢","ğŸ…‚ğŸ…‚","ğ•Šğ•Š","Ë¢Ë¢","SS"],"shadowsocksr":["ğ¬ğ¬ğ«","ğ’ğ’ğ‘","ğŸ…¢ğŸ…¢ğŸ…¡","ğŸ†‚ğŸ†‚ğŸ†","â“¢â“¢â“¡","ğŸ…‚ğŸ…‚ğŸ…","ğ•Šğ•Šâ„","Ë¢Ë¢Ê³","SSR"],"vmess":["ğ¯ğ¦ğğ¬ğ¬","ğ•ğŒğ„ğ’ğ’","ğŸ…¥ğŸ…œğŸ…”ğŸ…¢ğŸ…¢","ğŸ†…ğŸ…¼ğŸ…´ğŸ†‚ğŸ†‚","â“¥â“œâ“”â“¢â“¢","ğŸ……ğŸ„¼ğŸ„´ğŸ…‚ğŸ…‚","ğ•ğ•ğ•–ğ•¤ğ•¤","áµ›áµáµ‰Ë¢Ë¢","VMESS"],"trojan":["ğ­ğ«ğ¨ğ£ğšğ§","ğ“ğ‘ğğ‰ğ€ğ","ğŸ…£ğŸ…¡ğŸ…ğŸ…™ğŸ…ğŸ…","ğŸ†ƒğŸ†ğŸ…¾ğŸ…¹ğŸ…°ğŸ…½","â“£â“¡â“â“™â“â“","ğŸ…ƒğŸ…ğŸ„¾ğŸ„¹ğŸ„°ğŸ„½","ğ•‹ğ•£ğ• ğ•›ğ•’ğ•Ÿ","áµ€Ê³áµ’Ê²áµƒâ¿","TROJAN"],"http":["ğ¡ğ­ğ­ğ©","ğ‡ğ“ğ“ğ","ğŸ…—ğŸ…£ğŸ…£ğŸ…Ÿ","ğŸ…·ğŸ†ƒğŸ†ƒğŸ…¿","â“—â“£â“£â“Ÿ","ğŸ„·ğŸ…ƒğŸ…ƒğŸ„¿","ğ•™ğ•¥ğ•¥ğ•¡","Ê°áµ—áµ—áµ–","HTTP"],"socks5":["ğ¬ğ¨ğ—°ğ—¸ğ¬","ğ’ğğ‚ğŠğ’","ğŸ…¢ğŸ…ğŸ…’ğŸ…šğŸ…¢","ğŸ†‚ğŸ…¾ğŸ…²ğŸ…ºğŸ†‚","â“¢â“â“’â“šâ“¢","ğŸ…‚ğŸ„¾ğŸ„²ğŸ„ºğŸ…‚","ğ•¤ğ• ğ•”ğ•œğ•¤","Ë¢áµ’á¶œáµË¢","SOCKS"],"vless":["ğ¯ğ¥ğğ¬ğ¬","ğ•ğ‹ğ„ğ’ğ’","ğŸ…¥ğŸ…›ğŸ…”ğŸ…¢ğŸ…¢","ğŸ†…ğŸ…»ğŸ…´ğŸ†‚ğŸ†‚","â“¥â“›â“”â“¢â“¢","ğŸ……ğŸ„»ğŸ„´ğŸ…‚ğŸ…‚","ğ•ğ•ğ•–ğ•¤ğ•¤","áµ›Ë¡áµ‰Ë¢Ë¢","VLESS"]}
    typefix["shadowsocks"]=item.indexOf("ssr-protocol")!=-1? typefix["shadowsocksr"] : typefix["shadowsocks"]
    tp = typefix[item.split("=")[0].trim()][ind]
    return tp
  }
}


// æ“ä½œç¯€é»é¡å‹ä½”ä½ç¬¦
function type_handle(item) {
  if(item.indexOf("node_type_para_prefix")!=-1) {
    item = item.replace(/node_type_para_prefix(\d{0,1})/g,getnode_type(item,item.split("node_type_para_prefix")[1][0]))
  }
  return item
}

// èŠ‚ç‚¹åºå·å ä½ç¬¦å¤„ç†
function index_handle(item) {
  items = item.map(item=>item.trim()).filter(Boolean)
  let b=Array.from(new Array(items.length),(val,index)=>index+1);
  //console.log(b[0])
  for (var i=0; i< items.length;i++){
    //$notify("rename"+i,Prname,items[i])
    if (items[i].indexOf("node_index_prefix") != -1) { // ä»¥å…å ä½ç¬¦è¢«é”™è¯¯åœ°replace
    ind = items[i].split("node_index_prefix")[1][0]
    ind = !/^(0|1|2|3|4|5|6|7|8)$/.test(ind) ? 0 : ind
    console.log("handle index"+ind)
    items[i] = items[i].replace(/node_index_prefix(\d{0,1})/g,PatternN((i+1).toString(),"",ind))
  }
  }
  console.log(items)
  return items
}


// æ“ä½œemojiå ä½ç¬¦
function emoji_prefix_handle(item) {
  if(item.indexOf("node_emoji_flag_prefix")!=-1) {
    item = item.replace(/node_emoji_flag_prefix\d{0,1}/g,getnode_emoji(item,item.split("node_emoji_flag_prefix")[1][0]))
    //console.log(item)
  }
  return item
}

// è·å–emoji
function getnode_emoji(item,ind){
  ind = !/^(1|2)$/.test(ind) ? 2 : ind
  if(item.indexOf("tag=")!=-1) {
    return get_emoji(ind,item.split("tag=")[1])[1]
  }
}

// æ“ä½œè®¢é˜…çš„ tag
function tag_handle(item) {
  if(item.indexOf("node_tag_prefix")!=-1) {
    //item = item.replace(/node_tag_prefix/g,subtag)
    //console.log(item.split("node_tag_prefix")[1][1])
    ptnn = /\d/.test(item.split("node_tag_prefix")[1][0])? item.split("node_tag_prefix")[1][0]:""
    nptnn = /\d/.test(item.split("node_tag_prefix")[1][1])? item.split("node_tag_prefix")[1][1]:""
    //console.log(ptnn)
    item = item.replace(/node_tag_prefix\d{0,2}/g,PatternN(subtag,ptnn,nptnn))
  }
  return item
}

// ç”¨äºå•æ¡ URI çš„ tag å‚æ•°, ç›´æ¥æŒ‡å®šèŠ‚ç‚¹å
function URI_TAG(cnt0,tag0) {
  cnt0 = cnt0.split("tag=")[0] + "tag=" + tag0
  return cnt0
}

// æ–¹ä¾¿ä»£ç†é“¾çš„å®ç°
function ServerRelay(src,dst) {
  var rsts=[]
  for (var i=0; i<src.length; i++) {
    serverA = src[i].indexOf("-host")==-1? src[i].split("=")[1].split(":")[0].trim() : src[i].split("-host")[1].split("=")[1].split(",")[0].trim()
    type = /^[a-z]/.test(serverA) || /[a-z]$/.test(serverA)? "host":"ip"
    rst = type == "ip"? "ip-cidr,"+serverA+"/32,"+dst : "host-suffix,"+serverA+","+dst 
    rsts.push(rst)
  }
  return rsts.join("\n")
  
}

// ç”¨äºæŸäº›å¥‡è‘©ç”¨æˆ·ä¸ä½¿ç”¨ raw é“¾æ¥çš„é—®é¢˜
function rawtest(cnt) {
  var Preg0 = RegExp(".*js-file-line\".*?\<\/td\>", "i")
  if (Preg0.test(cnt)) {
    return cnt.replace(/(.*js-file-line\"\>)(.*?)(\<\/td\>)/g,"$2").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").trim()
  }
}

function ToRaw(cnt) {
  cnt = cnt.split("\n").map(rawtest).filter(Boolean).join("\n")
  var rawlink = link0.replace("github.com","raw.githubusercontent.com").replace("/blob","")
  if (cnt) {
    $notify( "âš ï¸âš ï¸ å°†å°è¯•è§£æè¯¥èµ„æº" + "âŸ¦" + subtag + "âŸ§" , "ğŸš¥ è¯·æ­£ç¡®ä½¿ç”¨GitHubçš„ raw é“¾æ¥" , "âŒ ä½ çš„é“¾æ¥ï¼š"+link0+"\nâœ… æ­£ç¡®é“¾æ¥ï¼š"+rawlink, {"open-url":rawlink})
  } else if(content0.indexOf("gridcell")!=-1) {
    $notify( "âš ï¸âš ï¸ è§£æè¯¥èµ„æº" + " âŸ¦" + subtag + "âŸ§ å¤±è´¥" , "ğŸš¥ ä½ çš„é“¾æ¥ä¼¼ä¹æ˜¯ç›®å½•ï¼Œè€Œä¸æ˜¯æ–‡ä»¶" , "âŒ ä½ çš„é“¾æ¥ï¼š"+link0, {"open-url":link0})
  }
  return cnt
}

function CDN(cnt) {
  console.log("CDN start")
  cnt = cnt.join("\n").replace(/https:\/\/raw.githubusercontent.com\/(.*?)\/(.*?)\/(.*)/gmi,"https://fastly.jsdelivr.net/gh/$1/$2@$3")
  return cnt
}

// æŒ‡å®šèŠ‚ç‚¹ host å‚æ•°
function HOST_Handle(cnt,phost) {
  phost="host="+phost+","
  if (phost.indexOf("â˜ ï¸") == -1) { //åªæ›¿æ¢å·²æœ‰hostç±»å‹
    cnt = cnt.replace(/host\s*\=(.*?)\,/,phost)
  } else { // ä¸ºå·²æœ‰çš„æ›¿æ¢ï¼Œä¸ºæ²¡æœ‰çš„å¢åŠ  obfs-host\tls-host
    phost=phost.split("â˜ ï¸")[0]
    if (/-host\s*\=/.test(cnt)) {// å¦‚å·²æœ‰ host å‚æ•°
      cnt = cnt.replace(/host\s*\=(.*?)\,/,phost+", ")
    } else if (/over-tls\s*\=\s*true/.test(cnt)) { // å¦‚æ— hostï¼Œä½†å¯ä»¥å¢åŠ 
      cnt = cnt+", tls-"+phost
    } else if (/obfs\s*\=/.test(cnt)) {
      cnt = cnt + ", obfs-"+phost
    }
  }
  return cnt
}

// æŒ‡å®šèŠ‚ç‚¹ obfs=xx-http å‚æ•°
function OBFS_Handle(cnt,pobfs) {
  if (pobfs == "shttp") {
    pobfs="obfs="+"shadowsocks-http"
  } else if (pobfs == "vhttp") {
    pobfs="obfs="+"vmess-http"
  } else { 
    pobfs="invalid"
  }
  if (/obfs\s*\=\s*http/.test(cnt) && pobfs!="invalid") { //åªæ›¿æ¢æœ‰ obfs=http å‚æ•°
    cnt = cnt.replace(/obfs\s*\=\s*http/,pobfs)
  }
  return cnt
}

// æŒ‡å®šèŠ‚ç‚¹ tls-no-session-ticket/reuse å‚æ•°
function Session_Handle(cnt,psession) {
  let st = ", tls-no-session-ticket=true"
  let sr = ", tls-no-session-reuse=true"
  if (psession == 0) {
    cnt =cnt + st
  } else if (psession == 1) {
     cnt =cnt + sr
  } else if (psession == 2){ 
    cnt =cnt + st + sr
  }
  return cnt
}

// æŒ‡å®š cert-sha256 pubkey-sha256 å‚æ•°
function SHA256_Handle(cnt,pcsha256,ppsha256) {
  if (cnt.indexOf("over-tls=true")!=-1 || cnt.indexOf("obfs=wss")!=-1) {
    cnt = cnt.replace(/tls-verification\s*\=\s*false(\s*)\,/,"") //å»é™¤ tls-verification=false
    //$notify("SHA256",cnt,Pcsha256+Ppsha256)
    cnt = pcsha256!=""? cnt.replace(/tag\s*\=/,"tls-cert-sha256="+pcsha256+", tag=") : cnt
    cnt = ppsha256!=""? cnt.replace(/tag\s*\=/,"tls-pubkey-sha256="+ppsha256+", tag=") : cnt
  }
  return cnt
}

// æŒ‡å®šalpnå‚æ•°,over-tlsç±»å‹ï¼Ÿ
function ALPN_Handle(cnt,palpn) {
  cnti = cnt.replace(/\s/gmi,"") //åˆ æ‰ç©ºæ ¼
  if (cnti.indexOf("obfs=over-tls") != -1 || cnti.indexOf("over-tls=true")!=-1) {
    cnt = cnt + ", tls-alpn="+palpn
  }
  return cnt
}

function Mock2QXReject(row, filename) {
    if (/dict/i.test(filename)) {
        return row.replace(/ /g, "").split("data=")[0] + " url " + "reject-dict"
    } else if (/array/i.test(filename)) {
        return row.replace(/ /g, "").split("data=")[0] + " url " + "reject-array"
    } else if (/(txt|html)/i.test(filename)) {
        return row.replace(/ /g, "").split("data=")[0] + " url " + "reject-200"
    } else if (/(png|jpg|gif)/i.test(filename)) {
        return row.replace(/ /g, "").split("data=")[0] + " url " + "reject-img"
    } else {
        return row.replace(/ /g, "").split("data=")[0] + " url " + "reject"
    }
}

//url-regex è½¬æ¢æˆ Quantumult X é‡å†™
function URX2QX(subs) {
    var nrw = []
    var rw = ""
    subs = subs.split("\n")
    //$notify("URX")
    var NoteK = ["//", "#", ";"];  //æ’é™¤æ³¨é‡Šé¡¹
    for (var i = 0; i < subs.length; i++) {
        const notecheck = (item) => subs[i].indexOf(item) == 0
        if (!NoteK.some(notecheck)) {
        if (subs[i].slice(0, 9) == "URL-REGEX") {  // regex ç±»å‹
          if (subs[i].indexOf("REJECT") != -1 || subs[i].split(",").length == 2 ) { // ä»…å¤„ç† reject ç±»å‹ï¼Œæˆ–è€…æ— æŒ‡å®šç­–ç•¥ç±»å‹
            if (subs[i].replace(/ /g, "").split(",REJECT")[0].split("GEX,")[1].slice(0,1) != "*") { // éƒ¨åˆ† * å¼€å¤´çš„ä¸æ”¯æŒ url-regexå½¢å¼
            rw = subs[i].replace(/ /g, "").split(",REJECT")[0].split("GEX,")[1] + " url " + "reject-200"
            nrw.push(rw)
          }
          }
        } else if (subs[i].indexOf("data=") != -1 && subs.indexOf("[Map Local]") != -1){ // Map Local ç±»å‹
            // å–subs[i]çš„æ–‡ä»¶å
            let fn = subs[i].match(/data=.+\/(.+)"/) ? subs[i].match(/data=.+\/(.+)"/)[1] : null
            if (!/header=".*content-type/i.test(subs[i]) && /blank/i.test(fn)) {
                rw = Mock2QXReject(subs[i], fn)
            } else {
                rw = subs[i].replace(/ /g, "").split("data=")[0].replace(/\"/g,"") + " url echo-response text/html echo-response " + subs[i].split("data=")[1].split(" ")[0].replace(/\"/g,"").replace(/ /g, "")//"reject-dict"
                if (subs[i].indexOf("header=")!=-1) {
                    if (subs[i].indexOf("Content-Type:") !=-1) {
                        let tpe = subs[i].split("header=")[1].split("Content-Type:")[1].split(",")[0].replace(/\"/g,"")
                        rw = rw.replace(/text\/html/g,tpe)
                    }
                }
            }
            nrw.push(rw)
        } 
    }
    }
    //$notify("URX","",nrw)
    return nrw
}

//script&rewrite è½¬æ¢æˆ Quantumult X
function SCP2QX(subs) {
  var nrw = []
  var rw = ""
  var RewriteK = [" url 302", " url 307", " url reject", " url script", " url req", " url res", " url echo", " url-and-header 302", " url-and-header 307", " url-and-header reject", " url-and-header script", " url-and-header req", " url-and-header res", " url-and-header echo"] // quantumult X ç±»å‹ rewrite
  subs = subs.split("\n").map(x => x.trim().replace(/\s+/g," "))
  //$notify("Script","",subs)
  for (var i = 0; i < subs.length; i++) {
    try {
      //$notify(i,"",subs[i])
      subs[i] = subs[i].replace("^http","http") // å»æ‰ ^ , ä»¥æ–¹ä¾¿å»é‡
      if (subs[i].slice(0, 8) == "hostname") {
        hn = subs[i].replace(/\%.*\%/g, "").replace(/\:\d*/g,"")
        nrw.push(hn)
      }
      var SC = ["type=", ".js", "pattern=", "script-path="]
      var NoteK = ["//", "#", ";"]; //æ’é™¤æ³¨é‡Šé¡¹
      const sccheck = (item) => subs[i].indexOf(item) != -1
      const notecheck = (item) => subs[i].indexOf(item) == 0
      const RewriteCheck = (item) => subs[i].indexOf(item) != -1 ; // quanx é‡å†™åˆ¤å®š
      if (!NoteK.some(notecheck) && !RewriteK.some(RewriteCheck)){
        if(Pdbg==1) {$notify("rewrite-check","",subs[i])}
        if (SC.every(sccheck)) { // surge js æ–°æ ¼å¼
          //éƒ¨åˆ†æ­£åˆ™ä¸­å«æœ‰,çš„é—®é¢˜
          ptn = subs[i].replace(/\s/gi,"").split("pattern=")[1].split(/\,[a-zA-Z]/)[0] 
          js = subs[i].replace(/\s/gi,"").split("script-path=")[1].split(",")[0]
          type = subs[i].replace(/\s/gi,"").split("type=")[1].split(",")[0].trim()
          subsi = subs[i].replace(/ /g,"").replace(/\=true/g,"=1")
          if (type == "http-response" && subsi.indexOf("requires-body=1") != -1) {
            type = "script-response-body "
          } else if (type == "http-response" && subsi.indexOf("requires-body=1") == -1) {
            type = "script-response-header "
          } else if (type == "http-request" && subsi.indexOf("requires-body=1") != -1) {
            type = "script-request-body "
          } else if (type == "http-request" && subsi.indexOf("requires-body=1") == -1) {
            type = "script-request-header "
          } else {type = "" }
          if (type != "") {
            rw = ptn + " url " + type + js
            nrw.push(rw)
          }
        } else if (/\s30(7|2)$/.test(subs[i])) { //rewrite 302&307 å¤å†™(Surge)
          //tpe = subs[i].indexOf(" 302") != -1? "302":"307"
          //$notify("307/2",subs[i])
          rw = subs[i].split(" ")[0] + " url " + subs[i].split(" ")[2] + " " + subs[i].split(" ")[1].trim()
          //if(rw.indexOf("307")!=-1) {$notify("XX",subs[i],rw.split(" "))}
          nrw.push(rw)
        } else if (/\s\-\s30(2|7)\s/.test(subs[i])) { //rewrite 302&307 å¤å†™(Shadowrocket)
          //xx - 302 $1$2$3
          rw = subs[i].replace(" - "," url ")
          nrw.push(rw)
        } else if(subs[i].split(" ")[2] == "header") { // rewrite header ç±»å‹
          var pget = subs[i].split(" ")[0].split(".com")[1]
          var pgetn = subs[i].split(" ")[1].split(".com")[1]
          rw = subs[i].split(" ")[0] + " url 302 " + subs[i].split(" ")[1]
          //rw = subs[i].split(" ")[0] + " url request-header ^GET " + pget +"(.+\\r\\n)Host:.+(\\r\\n) request-header GET " + pgetn + "$1Host: " + subs[i].split(" ")[1].split("://")[1].split(".com")[0] + ".com$2"
          nrw.push(rw)
        } else if(subs[i].split(" ")[1] == "header-replace") { // rewrite header-replace ç±»å‹
          console.log(subs[i])
          var pget = subs[i].split("header-replace")[1].split(":")[0].trim()
          var pgetn = subs[i].split("header-replace")[1].trim()
          rw = subs[i].split(" ")[0] + " url request-header " +"(.+\\r\\n)"+pget+":.+(\\r\\n) request-header " + "$1" + pgetn + "$2"
          nrw.push(rw)
        } else if(subs[i].indexOf(" _ reject") != -1) { // rewrite reject ç±»å‹(surge)
          rw = subs[i].split(" ")[0] + " url reject-200"
          nrw.push(rw)
        } else if(subs[i].indexOf(" - reject") != -1 || subs[i].indexOf(" - REJECT") != -1) { //shadowrocket reject/REJECT
          rw = subs[i].replace(" - ", " url ").toLowerCase()
          nrw.push(rw)
        } else if(subs[i].split(" ").length == 2 && (/\s(reject)$/.test(subs[i]) || /\s(reject\-)/.test(subs[i]))){ // loon ç±»å‹ï¼Ÿ http://xxx/yyy reject
          rw = subs[i].replace(" reject", " url reject")
          nrw.push(rw)
        } else if (subs[i].indexOf("script-path") != -1) { //surge js æ—§å†™æ³•
          type = subs[i].replace(/\s+/g," ").split(" ")[0]
          js = subs[i].split("script-path")[1].split("=")[1].split(",")[0]
          ptn = subs[i].replace(/\s+/g," ").split(" ")[1]
          subsi = subs[i].replace(/ /g,"").replace(/\=true/g,"=1")
          if (type == "http-response" && subsi.indexOf("requires-body=1") != -1) {
            type = "script-response-body "
          } else if (type == "http-response" && subsi.indexOf("requires-body=1") == -1) {
            type = "script-response-header "
          } else if (type == "http-request" && subsi.indexOf("requires-body=1") != -1) {
            type = "script-request-body "
          } else if (type == "http-request" && subsi.indexOf("requires-body=1") == -1) {
            type = "script-request-header "
          } else {type = "" }
          if (type != "") {
            rw = ptn + " url " + type + js
            nrw.push(rw)
          } 
        }
      } else if(RewriteK.some(RewriteCheck)) {
        nrw.push(subs[i])
      }
    } catch (err) {
      $notify("âŒï¸è§£ææ­¤æ¡æ—¶å‡ºç°é”™è¯¯ï¼Œå·²å¿½ç•¥",subs[i],err)
    }
  }
  return nrw
}

// å¦‚æœ URL-Regex è·Ÿ rewrite/script éƒ½éœ€è¦
function SGMD2QX(subs) {
    var nrw0 = URX2QX(subs)
    var nrw1 = SCP2QX(subs)
    var nrwt = [...nrw0, ...nrw1]
    return nrwt
}

//Rewriteè¿‡æ»¤ï¼Œä½¿ç”¨+è¿æ¥å¤šä¸ªå…³é”®è¯(é€»è¾‘"æˆ–"):in ä¸ºä¿ç•™ï¼Œout ä¸ºæ’é™¤
function Rewrite_Filter(subs, Pin, Pout,Preg,Pregout) {
    var Nlist = [];
    var noteK = ["//", "#", ";"];
    var hnc = 0;
    var dwrite = []
    var hostname = ""
    for (var i = 0; i < subs.length; i++) {
        subi = subs[i].trim();
        var subii = subi.replace(/ /g, "")
        if (subi != "" && (subi.indexOf(" url ")!=-1 || subi.indexOf(" url-and-header ")!=-1 || /^hostname\=/.test(subii))) {
            const notecheck = (item) => subi.indexOf(item) == 0
            if (noteK.some(notecheck)) { // æ³¨é‡Šé¡¹è·³è¿‡ 
                continue;
            } else if (hnc == 0 && subii.indexOf("hostname=") == 0) { //hostname éƒ¨åˆ†
                hostname = (Phin0 || Phout0 || Preg || Pregout) ? HostNamecheck(subi, Phin0, Phout0) : subi;//hostname éƒ¨åˆ†
            } else if (subii.indexOf("hostname=") != 0) { //rewrite éƒ¨åˆ†
                var inflag = Rcheck(subi, Pin);
                var outflag = Rcheck(subi, Pout);
                if (outflag == 1 || inflag == 0) {
                    dwrite.push(subi.replace(" url "," - ").replace(" url-and-header "," - ")); //out å‘½ä¸­
                } else if (outflag == 0 && inflag != 0) { //out æœªå‘½ä¸­ && in æœªæ’é™¤
                    Nlist.push(subi);
                } else if (outflag == 2 && inflag != 0) { //æ—  out å‚æ•° && in æœªæ’é™¤
                    Nlist.push(subi);
                }
            }
        }
    }
    if (Pntf0 != 0) {
        nowrite = dwrite.length <= 10 ? emojino[dwrite.length] : dwrite.length
        no1write = Nlist.length <= 10 ? emojino[Nlist.length] : Nlist.length
        if (Pin0 && no1write != " 0ï¸âƒ£ ") { //æœ‰ in å‚æ•°å°±é€šçŸ¥ä¿ç•™é¡¹ç›®
          if (Pout!=0) {
            $notify("ğŸ¤– " + "é‡å†™å¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç­›é€‰å‚æ•°: " + pfi + pfo, "â˜ ï¸ é‡å†™ rewrite ä¸­ä¿ç•™ä»¥ä¸‹" + no1write + "ä¸ªåŒ¹é…é¡¹:" + "\n â¨· " + Nlist.join("\n â¨· "), rwrite_link)
          }
        } else if (dwrite.length > 0) {
          if (Pout0!=0) {
            $notify("ğŸ¤– " + "é‡å†™å¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç­›é€‰å‚æ•°: " + pfi + pfo, "â˜ ï¸ é‡å†™ rewrite ä¸­å·²ç¦ç”¨ä»¥ä¸‹" + nowrite + "ä¸ªåŒ¹é…é¡¹:" + "\n â¨· " + dwrite.join("\n â¨· "), rwrite_link)
          }
        }
    }
    if (Nlist.length == 0 ) { 
      if ((Pin0 || Pout0 || Phin0 || Phout0 || Pregout || Preg)) {
        $notify("ğŸ¤– " + "é‡å†™å¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç­›é€‰å‚æ•°: " + pfi + pfo, "âš ï¸ ç­›é€‰åå‰©ä½™rewriteè§„åˆ™æ•°ä¸º 0ï¸âƒ£ æ¡, è¯·æ£€æŸ¥å‚æ•°åŠåŸå§‹é“¾æ¥", nan_link) 
      } else {
        $notify("ğŸ¤– " + "é‡å†™å¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ è§£æå rewrite è§„åˆ™æ•°ä¸º 0ï¸âƒ£ æ¡ " , "âš ï¸ è¯·æ£€æŸ¥å‚æ•°åŠåŸå§‹é“¾æ¥å†…å®¹", nan_link) 
      
      }
    }
    if(Preg){ Nlist = Nlist.map(Regex).filter(Boolean) // regex to filter rewrites
      RegCheck(Nlist, "é‡å†™å¼•ç”¨", "regex", Preg) }
    if(Pregout){ Nlist = Nlist.map(RegexOut).filter(Boolean) // regex to delete rewrites
      RegCheck(Nlist, "é‡å†™å¼•ç”¨", "regout", Pregout) }
    if (hostname != "") { Nlist.push(hostname) }
    Nlist =Phide ==1? Nlist : [...dwrite,...Nlist]
    return Nlist
}

// ä¸»æœºåå¤„ç†
function HostNamecheck(content, parain, paraout) {
    var hname = content.replace(/ /g, "").split("=")[1].split(",");
    var nname = [];
    var dname = []; //åˆ é™¤é¡¹
    for (var i = 0; i < hname.length; i++) {
        dd = hname[i]
        const excludehn = (item) => dd.indexOf(item) != -1;
        if (paraout && paraout != "") { //å­˜åœ¨ out å‚æ•°æ—¶
            if (!paraout.some(excludehn)) { //out æœªå‘½ä¸­ğŸ¯ï¸
                if (parain && parain != "") {
                    if (parain.some(excludehn)) { //Pin å‘½ä¸­ğŸ¯ï¸
                        nname.push(hname[i])
                    } else {
                        dname.push(hname[i])
                    } //Pin æœªå‘½ä¸­ğŸ¯ï¸çš„è®°å½•
                } else { nname.push(hname[i]) } //æ— in å‚æ•°    
            } else { dname.push(hname[i]) } //out å‚æ•°å‘½ä¸­
        } else if (parain && parain != "") { //ä¸å­˜åœ¨ outï¼Œä½†æœ‰ in å‚æ•°æ—¶
            if (parain.some(excludehn)) { //Pin å‘½ä¸­ğŸ¯ï¸
                nname.push(hname[i])
            } else { dname.push(hname[i]) }
        } else {
            nname.push(hname[i])
        }
    } //for j
    if (Pntf0 != 0) {
        if (paraout || parain) {
            var noname = dname.length <= 10 ? emojino[dname.length] : dname.length
            var no1name = nname.length <= 10 ? emojino[nname.length] : nname.length
            if (parain && no1name != " 0ï¸âƒ£ ") {
                $notify("ğŸ¤– " + "é‡å†™å¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç­›é€‰å‚æ•°: " + pfihn + pfohn, "â˜ ï¸ ä¸»æœºå hostname ä¸­å·²ä¿ç•™ä»¥ä¸‹" + no1name + "ä¸ªåŒ¹é…é¡¹:" + "\n â¨· " + nname.join(","), rwhost_link)
            } else if (dname.length > 0) {
                $notify("ğŸ¤– " + "é‡å†™å¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç­›é€‰å‚æ•°: " + pfihn + pfohn, "â˜ ï¸ ä¸»æœºå hostname ä¸­å·²åˆ é™¤ä»¥ä¸‹" + noname + "ä¸ªåŒ¹é…é¡¹:" + "\n â¨· " + dname.join(","), rwhost_link)
            }
        }
    }
    if (nname.length == 0) {
        $notify("ğŸ¤– " + "é‡å†™å¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç­›é€‰å‚æ•°: " + pfihn + pfohn, "âš ï¸ ä¸»æœºå hostname ä¸­å‰©ä½™ 0ï¸âƒ£ é¡¹, è¯·æ£€æŸ¥å‚æ•°åŠåŸå§‹é“¾æ¥", nan_link)
    }
    if(Preg){ nname = nname.map(Regex).filter(Boolean)
      RegCheck(nname, "ä¸»æœºåhostname","regex", Preg) }
    if(Pregout){ nname = nname.map(RegexOut).filter(Boolean)
      RegCheck(nname, "ä¸»æœºåhostname", "regout", Pregout) }
    hname = "hostname=" + nname.join(", ");
    return hname
}

//Rewrite ç­›é€‰çš„å‡½æ•°
function Rcheck(content, param) {
    name = content.toUpperCase()
    if (param) {
        var flag = 0; //æ²¡å‘½ä¸­
        const checkpara = (item) => name.indexOf(item.toUpperCase()) != -1;
        if (param.some(checkpara)) {
            flag = 1 //å‘½ä¸­
        }
        return flag
    } else { //if param
        return 2
    } //æ— å‚æ•°
}

//åˆ†æµè§„åˆ™è½¬æ¢åŠè¿‡æ»¤(in&out)ï¼Œå¯ç”¨äº surge åŠ quanx çš„ rule-list
function Rule_Handle(subs, Pout, Pin) {
    cnt = subs //.split("\n");
    Tin = Pin; //ä¿ç•™å‚æ•°
    Tout = Pout; //è¿‡æ»¤å‚æ•°
    ply = Ppolicy; //ç­–ç•¥ç»„
    var nlist = []
    var RuleK = ["//", "#", ";","[","^"]; //æ’é™¤é¡¹ç›®
    var RuleK2 = ["host,", "-suffix,", "domain,", "-keyword,", "ip-cidr,", "ip-cidr6,",  "geoip,", "user-agent,", "ip6-cidr,", "ip-asn"];
    if (Tout != "" && Tout != null) { // æœ‰ out å‚æ•°æ—¶
        var dlist = [];
        for (var i = 0; i < cnt.length; i++) {
            cc = cnt[i].replace(/^\s*\-\s/g,"").replace(/\"|\'/g,"").trim()
            //$notify("out ing", Tout, cc)
            const exclude = (item) => cc.indexOf(item) != -1; // åˆ é™¤é¡¹
            const RuleCheck = (item) => cc.toLowerCase().indexOf(item) != -1; //è§„åˆ™æ£€æŸ¥
            const CommentCheck = (item) => cc.toLowerCase().indexOf(item) == 0; //æ— è§†æ³¨é‡Šè¡Œ
            if (Tout.some(exclude) && !RuleK.some(CommentCheck) ) {
              // 2022-12-15 åˆ é™¤ && RuleK2.some(RuleCheck) åˆ¤æ–­æ¡ä»¶ï¼Œä»¥å… list/provider ä¸­å‚æ•°ä¸Šç”Ÿæ•ˆ
                dlist.push("-" + Rule_Policy(cc)) // æ³¨é‡Šæ‰æ¡ç›®
            } else if (!RuleK.some(CommentCheck) && cc ) { //if Pout.some, ä¸æ“ä½œæ³¨é‡Šé¡¹ï¼Œä¸æ“ä½œä¸è¯†åˆ«è§„åˆ™é¡¹ç›®
              // 2022-12-15 åˆ é™¤ && RuleK2.some(RuleCheck) åˆ¤æ–­æ¡ä»¶ï¼Œä»¥å… list/provider ä¸­å‚æ•°ä¸Šç”Ÿæ•ˆ
                dd = Rule_Policy(cc);
                if (Tin != "" && Tin != null) {
                    const include = (item) => dd.indexOf(item) != -1; // ä¿ç•™é¡¹
                    if (Tin.some(include)) {
                        nlist.push(dd);
                    }
                } else {
                    nlist.push(dd);
                }
            } //else if cc
        }//for cnt
        var no = dlist.length <= 10 ? emojino[dlist.length] : dlist.length
        if (dlist.length > 0) {
            if (Pntf0 != 0) { $notify("ğŸ¤– " + "åˆ†æµå¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç¦ç”¨: " + Tout, "â˜ ï¸ å·²ç¦ç”¨ä»¥ä¸‹" + no + "æ¡åŒ¹é…è§„åˆ™:" + "\n â¨· " + dlist.join("\n â¨· "), rule_link) }
        } else { $notify("ğŸ¤– " + "åˆ†æµå¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç¦ç”¨: " + Tout, "âš ï¸ æœªå‘ç°ä»»ä½•åŒ¹é…é¡¹, è¯·æ£€æŸ¥å‚æ•°æˆ–åŸå§‹é“¾æ¥", nan_link) }
        if (Tin != "" && Tin != null) {  //æœ‰ in è·Ÿ out å‚æ•°æ—¶
            if (nlist.length > 0) {
                var noin0 = nlist.length <= 10 ? emojino[nlist.length] : nlist.length
                if (Pntf0 != 0) {
                    $notify("ğŸ¤– " + "åˆ†æµå¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "âœ… ä¿ç•™:" + Tin, "ğŸ¯ å·²ä¿ç•™ä»¥ä¸‹ " + noin0 + "æ¡åŒ¹é…è§„åˆ™:" + "\n â¨ " + nlist.join("\n â¨ "), rule_link)
                }
            } else {
                $notify("ğŸ¤– " + "åˆ†æµå¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "âœ… ä¿ç•™:" + Tin + ",â›”ï¸ ç¦ç”¨: " + Tout, "âš ï¸ ç­›é€‰åå‰©ä½™è§„åˆ™æ•°ä¸º 0ï¸âƒ£ æ¡, è¯·æ£€æŸ¥å‚æ•°åŠåŸå§‹é“¾æ¥", nan_link)
            }
        } else {// if Tin (No Tin)
            if (nlist.length == 0) {
                $notify("ğŸ¤– " + "åˆ†æµå¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "â›”ï¸ ç¦ç”¨: " + Tout, "âš ï¸ ç­›é€‰åå‰©ä½™è§„åˆ™æ•°ä¸º 0ï¸âƒ£ æ¡, è¯·æ£€æŸ¥å‚æ•°åŠåŸå§‹é“¾æ¥", nan_link)
            }
        }
      nlist =Phide ==1? nlist : [...dlist,...nlist]
        //return nlist;
    } else if (Tin != "" && Tin != null) { //if Tout
        var dlist = [];
        for (var i = 0; i < cnt.length; i++) {
            cc = cnt[i].replace(/^\s*\-\s/g,"").trim()
            const RuleCheck = (item) => cc.indexOf(item) != -1; //æ— è§†æ³¨é‡Šè¡Œ
            const CommentCheck = (item) => cc.toLowerCase().indexOf(item) == 0; //æ— è§†æ³¨é‡Šè¡Œ
            if (!RuleK.some(CommentCheck) && cc) { //if Pout.some, ä¸æ“ä½œæ³¨é‡Šé¡¹
                dd = Rule_Policy(cc);
                const include = (item) => dd.indexOf(item) != -1; // ä¿ç•™é¡¹
                if (Tin.some(include)) {
                    nlist.push(dd);
                } else { dlist.push("-" + dd) }
            }
        } // for cnt
        if (nlist.length > 0) {
            var noin = nlist.length <= 10 ? emojino[nlist.length] : nlist.length
            if (Pntf0 != 0) {
                $notify("ğŸ¤– " + "åˆ†æµå¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "âœ… ä¿ç•™:" + Tin, "ğŸ¯ å·²ä¿ç•™ä»¥ä¸‹ " + noin + "æ¡åŒ¹é…è§„åˆ™:" + "\n â¨ " + nlist.join("\n â¨ "), rule_link)
            }
        } else { $notify("ğŸ¤– " + "åˆ†æµå¼•ç”¨  âŸ " + "âŸ¦" + subtag + "âŸ§", "âœ… ä¿ç•™:" + Tin, "âš ï¸ ç­›é€‰åå‰©ä½™è§„åˆ™æ•°ä¸º 0ï¸âƒ£ æ¡, è¯·æ£€æŸ¥å‚æ•°åŠåŸå§‹é“¾æ¥", nan_link) }
      nlist =Phide ==1? nlist : [...dlist,...nlist]
      //return nlist;
    } else {  //if Tin
      nlist = cnt.map(Rule_Policy)
        //return cnt.map(Rule_Policy)
    }
  nlist = Pfcr == 1? nlist.filter(Boolean).map(item => item+", force-cellular") : nlist.filter(Boolean)
  nlist = Pfcr == 2? nlist.filter(Boolean).map(item => item+", multi-interface") : nlist.filter(Boolean)
  nlist = Pfcr == 3? nlist.filter(Boolean).map(item => item+", multi-interface-balance") : nlist.filter(Boolean)

  if (Pvia!="") {
    nlist = Pvia ==0? nlist.filter(Boolean).map(item => item+", via-interface=%TUN%") : nlist.filter(Boolean).map(item => item+", via-interface="+Pvia)
  }

  nlist=nlist.map(item=>item.replace(/:\d*\s*,/g,",").replace(/(\'|\")/g,"").replace(/(\-suffix|\-SUFFIX)\s*\,\s*\./g,"$1, ")) //å»é™¤ç«¯å£å·ä»¥åŠåˆ†å·éƒ¨åˆ†, ä»¥åŠéƒ¨åˆ†suffixè§„åˆ™ä»¥. å¼€å¤´çš„é—®é¢˜
  //$notify("nlist","",nlist)
  return nlist
}

function Rule_Policy(content) { //å¢åŠ ã€æ›¿æ¢ policy
    var cnt = content.replace(/^\s*\-\s/g,"").replace(/REJECT-TINYGIF/gi,"reject").replace(/REJECT-DROP/gi,"reject").trim().split("//")[0].trim().split(",");
    var RuleK = ["//", "#", ";","[","/", "hostname","no-ipv6","no-system","<","{","}","]","^"];
    var RuleK1 = ["host", "domain", "ip-cidr", "geoip", "user-agent", "ip6-cidr", "ip-asn"];
    const RuleCheck = (item) => cnt[0].trim().toLowerCase().indexOf(item) == 0; //æ— è§†æ³¨é‡Šè¡Œ
    const RuleCheck1 = (item) => cnt[0].trim().toLowerCase().indexOf(item) == 0 ; //æ— è§† quanx ä¸æ”¯æŒçš„è§„åˆ™ç±»åˆ«&æ’é™¤ hostname
    if (RuleK1.some(RuleCheck1) && !RuleK.some(RuleCheck) ) {
        if (cnt.length == 3 && cnt.indexOf("no-resolve") == -1) {
            ply0 = Ppolicy != "Shawn" ? Ppolicy : cnt[2]
            nn = cnt[0] + ", " + cnt[1] + ", " + ply0
        } else if (cnt.length == 4 && cnt.indexOf("no-resolve") != -1) { // å¸¦no-resolveçš„quanxç±»å‹rule
          nn = cnt.join(",").replace(",no-resolve","")
        } else if (cnt.length == 2) { //Surge rule-set
            ply0 = Ppolicy != "Shawn" ? Ppolicy : "Shawn"
            nn = cnt[1].trim() !=""? cnt[0] + ", " + cnt[1] + ", " + ply0 : ""
        } else if (cnt.length == 3 && cnt[2].indexOf("no-resolve") != -1) {
            ply0 = Ppolicy != "Shawn" ? Ppolicy : "Shawn"
            nn = cnt[0] + ", " + cnt[1] + ", " + ply0 //+ ", " + cnt[2]
        } else if (cnt.length == 4 && cnt[3].indexOf("no-resolve") != -1) {
            ply0 = Ppolicy != "Shawn" ? Ppolicy : cnt[2]
            nn = cnt[0] + ", " + cnt[1] + ", " + ply0 //+ ", " + cnt[3]
        } else if (!RuleK.some(RuleCheck) && content) {
            //$notify("æœªèƒ½è§£æ" + "âŸ¦" + subtag + "âŸ§" + "å…¶ä¸­éƒ¨åˆ†è§„åˆ™:", content, nan_link);
            return ""
        } else { return "" }
        if (cnt[0].indexOf("URL-REGEX") != -1 || cnt[0].indexOf("PROCESS") != -1) {
            nn = ""
        } else { nn = nn.replace("IP-CIDR6", "ip6-cidr") }
        return nn
    } else if (cnt.length == 1 && !RuleK.some(RuleCheck) && cnt[0]!="" && cnt[0].indexOf("payload:")==-1 && cnt[0].indexOf("=")==-1 && cnt[0].trim()!="https:") { // çº¯åŸŸå/ip åˆ—è¡¨
      //$notify("LIST-HANDLE")
      return rule_list_handle(cnt[0])
    } else { 
      //$notify("Nothing")
      return "" }//if RuleK1 check 
}

// å¤„ç†çº¯åˆ—è¡¨, åŒ…å« clash-provider
function rule_list_handle(cnt) {
  var RuleK = ["//", "#", ";", "[", "!", "/"]
  const RuleCheck = (item) => cnt.trim().indexOf(item) == 0; //æ— è§†æ³¨é‡Šè¡Œ
  const nocheck = (item) => /^\d+$/.test(item) //æ£€æŸ¥æ•°å­—é¡¹
  cnt = cnt.split("#")[0].trim() // å»é™¤æ³¨é‡Šéƒ¨åˆ†
  if (cnt.trim().indexOf(" ") == -1 && cnt.trim() != "" && !RuleK.some(RuleCheck)) {
    if (cnt.indexOf("::") != -1 && cnt.indexOf("/") != -1) { // ip-v6?
      cnt = "ip6-cidr, " + cnt
      cnt = Ppolicy == "Shawn" ? cnt + ", Shawn" : cnt + ", " + Ppolicy
    } else if (cnt.split("/").length == 2) {//ip-cidr
      cnt = "ip-cidr, " + cnt
      cnt = Ppolicy == "Shawn" ? cnt + ", Shawn" : cnt + ", " + Ppolicy
    } else if (cnt.split(".").length == 4 && cnt.split(".").every(nocheck)) {  // ip ç±»è§„åˆ™
      cnt = "ip-cidr, " + cnt + "/32"
      cnt = Ppolicy == "Shawn" ? cnt + ", Shawn" : cnt + ", " + Ppolicy
    } else if (cnt.indexOf("payload:") == -1) { //host - suffix, not clash rule list
      //$notify("xxx","xxxx",cnt)
      //cnt=cnt.replace(/'|"/g,"").trim()//replace(/'|"|\+\.|\*\.|\*\.\*/g,"") 2023-04-10

      if (!/^('|")/.test(cnt)) { // not clash-provider
        if (!/\*|\+/.test(cnt[0])) {
          cnt = cnt[0] == "." ? cnt.replace(".", "") : cnt
          cnt = "host-suffix, " + cnt
        } else {
          cnt = "host-wildcard, " + cnt
        }
      } else { // clash provider
        cnt = cnt.replace(/'|"/g, "").trim()

        if (/^\.|\*\./.test(cnt) || cnt.indexOf("*") != -1) {
          //1.ä»¥.æˆ–*.å¼€å¤´ -> åŒ¹é…å­åŸŸåï¼Œwildcard,*.domain
          //2.ç›´æ¥æ›¿æ¢å¼€å¤´ï¼Œæ­£åˆ™æœªåŒ¹é… -> ä¸ä»¥*.å¼€å¤´çš„å­—ç¬¦ä¸²ä½†åŒ…å«*çš„æƒ…å†µ(wildcard,a.*.domain...)
          cnt = "host-wildcard, " + cnt.replace(/^\.|\*\./, "*.")
        } else {
          cnt = "host-suffix, " + cnt.replace(/^(\+\.)/, "")//å¦‚æœä»¥+.å¼€å¤´ = åŒ¹é…å½“å‰åŸŸååŠå…¶å­åŸŸåï¼Œé‡‡ç”¨ suffix,domainã€‚
        }
      }
      cnt = Ppolicy == "Shawn" ? cnt + ", Shawn" : cnt + ", " + Ppolicy
    }
  }
  return cnt
}

// Domain-Set
function Domain2Rule(content) {
    var cnt = content.split("\n");
    var RuleK = ["//", "#", ";","["]
    var nlist = []
    for (var i = 0; i< cnt.length; i++) {
        cc = cnt[i].trim();
        const RuleCheck = (item) => cc.indexOf(item) != -1; //æ— è§†æ³¨é‡Šè¡Œ
        if(!RuleK.some(RuleCheck) && cc) {
            if (cc[0] == "."){
                nlist.push("host-suffix, " + cc.slice(1 , cc.length) )
            } else {
                nlist.push("host, " + cc )
            }
        }
    }
    return nlist.join("\n")
}
// filter æ­£åˆ™æŒ‡å®šæ›¿æ¢ regex1@policy1+regex2@policy2
function policy_sets(cnt,para) {
  pcnt = para.split("+")
  cnt=cnt//.split("\n")
  for (i=0;i<pcnt.length;i++){
    console.log(pcnt[i])
    if (pcnt[i].indexOf("@")!=-1){
      cnt = cnt.map(item => filter_set(item, pcnt[i]))
    }
  }
  cnt=cnt.filter(Boolean)//.join("\n")
  return cnt
  console.log(cnt)
}

//ç­–ç•¥æŒ‡å®š
function filter_set(cnt,para){
  if (cnt){
    paras=[para.split("@")[0],para.slice(para.split("@")[0].length+"@".length)]
    console.log(para.split("@")[0].length+"@".length,paras)
    cnt = cnt.split(",")
    reg = RegExp(paras[0])
    console.log(paras,cnt)
    if(cnt.length == 3){
      if (reg.test(cnt[1]) || reg.test(cnt[2])) {
        cnt[2] = paras[1]
      }
    }
    return cnt.join(",")
  }
}


// æ­£åˆ™æ›¿æ¢ filter/rewrite çš„éƒ¨åˆ†
// ç”¨é€”ï¼šå¦‚ tiktok æ¢åŒº: JP -> KR ï¼Œå¦‚æ·˜å®æ¯”ä»·è„šæœ¬ -> lite æ¨ªå¹…é€šçŸ¥ç‰ˆæœ¬
function ReplaceReg(cnt, para) {
    var cnt0 = cnt//.join("\n")
    //$notify("0","",cnt0)
    var pp = para.replace(/\\\@/g,"atsymbol").replace(/\\\+/g,"plussymbol").split("+");
    for (var i = 0; i < pp.length; i++) {
        var p1 = decodeURIComponent(pp[i].split("@")[0]).replace(/atsymbol/g,"\@").replace(/plussymbol/g,"\\\+").replace(/\ï¼Œ/g,",");
        var p2 = decodeURIComponent(pp[i].split("@")[1]).replace(/atsymbol/g,"@").replace(/plussymbol/g,"+").replace(/\ï¼Œ/g,",");
        p1 = new RegExp(p1, "gmi");
        cnt0 = cnt0.map(item => item.replace(p1, p2));
        //$notify(p1,p2,cnt0)
    }
  //$notify("1","",cnt0)
    return cnt0//.split("\n")
}

//æ··åˆè®¢é˜…ç±»å‹ï¼Œç”¨äºæœªæ•´ä½“è¿›è¡Œ base64 encode ä»¥åŠå·²ç» decode åçš„ç±»å‹
function Subs2QX(subs, Pudp, Ptfo, Pcert0, PTls13) {
  if (Pdbg) {$notify("subs", "node", subs)}
    var list0 = subs.split("\n");
    var QuanXK = ["shadowsocks=", "trojan=", "vmess=", "http=","socks5="];
    var SurgeK = ["=ss,", "=vmess,", "=trojan,", "=http,", "=https,", "=custom,", "=socks5", "=socks5-tls"];
    var LoonK = ["=shadowsocks", "=shadowsocksr", "=vless"]
    var QXlist = [];
    var failedList = [];
    for (var i = 0; i < list0.length; i++) {
        var node = ""
        //if (Pdbg) {$notify(i, "node", list0[i])}
        if (list0[i].trim().length > 3 && !/\;|\/|\#/.test(list0[i][0]) && list0[i].indexOf(" url ")==-1) {
            var type = list0[i].split("://")[0].trim()
            var listi = list0[i].replace(/ /g, "")
            var tag0 = list0[i].indexOf("tag=")!=-1 ? list0[i].split(/\&*(emoji|udp|tfo|cert|rename|replace)\=/)[0].split("tag=")[1] : ""
            list0[i] = (type=="ssr") ? list0[i].split(/#|,|ï¼Œ/)[0] : list0[i] // 2023-04-18 remove type == "vmess" ||
            const NodeCheck = (item) => listi.toLowerCase().indexOf(item) != -1;
            const NodeCheck1 = (item) => listi.toLowerCase().indexOf(item) == 0;
            try {
              if (Pdbg) {$notify(i, type, list0[i])}
                if (type == "vmess" && (list0[i].indexOf("remark=") == -1 && list0[i].indexOf("remarks=") == -1) && !/(obfs|alterId|type|\@)\=/.test(list0[i])) {
                    var bnode = Base64.decode(list0[i].split("vmess://")[1])
                    if (bnode.indexOf("over-tls=") == -1) { //v2rayN
                        node = V2QX(list0[i], Pudp, Ptfo, Pcert0, PTls13)
                    } else { //quantumult ç±»å‹
                        node = VQ2QX(list0[i], Pudp, Ptfo, Pcert0, PTls13)
                    }
                  node = tag0 != "" ? URI_TAG(node, tag0) : node
                } else if (type == "vmess" && ( list0[i].indexOf("remark=") != -1 || list0[i].indexOf("remarks=") != -1 || /(obfs|alterId|type|\@)\=/.test(list0[i]))) { //shadowrocket ç±»å‹
                    node = VR2QX(list0[i], Pudp, Ptfo, Pcert0, PTls13)
                    node = tag0 != "" ? URI_TAG(node, tag0) : node
                } else if (type == "socks" && list0[i].indexOf("remarks=") != -1) { //shadowrocket socks5 ç±»å‹
                    node = S5R2QX(list0[i])
                    node = tag0 != "" ? URI_TAG(node, tag0) : node
                } else if (type == "ssocks" && list0[i].indexOf("remarks=") != -1) { //shadowrocket socks5-tls ç±»å‹
                    node = S5R2QX(list0[i],tlsp="over-tls")
                    node = tag0 != "" ? URI_TAG(node, tag0) : node
                } else if (type == "ssr") {
                    node = SSR2QX(list0[i], Pudp, Ptfo)
                    node = tag0 != "" ? URI_TAG(node, tag0) : node
                } else if (type == "ss") {
                    node = SS2QX(list0[i], Pudp, Ptfo)
                    node = tag0 != "" ? URI_TAG(node, tag0) : node
                } else if (type == "ssd") {
                    node = SSD2QX(list0[i], Pudp, Ptfo)
                } else if (type == "trojan") {
                    node = TJ2QX(list0[i], Pudp, Ptfo, Pcert0, PTls13)
                    node = tag0 != "" ? URI_TAG(node, tag0) : node
                } else if ((type == "https" || type == "http") && list0[i].indexOf(",") == -1) {
                    if (listi.indexOf("@") != -1) {
                        node = HPS2QX(list0[i], Ptfo, Pcert0, PTls13)
                        node = tag0 != "" ? URI_TAG(node, tag0) : node
                    } else { // b64 ç±»å‹ http/https
                        var listh = Base64.decode(listi.split(type+"://")[1].split("#")[0].split("?")[0])
                        listh = list0[i].replace(listi.split(type+"://")[1].split("#")[0].split("?")[0],listh) //type+"://" + listh + "#" + listi.split(type+"://")[1].split("#")[1]
                        node = HPS2QX(listh, Ptfo, Pcert0, PTls13)
                        node = tag0 != "" ? URI_TAG(node, tag0) : node
                    }
                } else if (type == "vless" && version<821) {
                  Perror = 1 ; // æ— éœ€åé¦ˆ
                  $notify("âš ï¸ ä½ çš„ Quantumult X ç‰ˆæœ¬æš‚æœªæ”¯æŒ Vless èŠ‚ç‚¹","è¯· âš ï¸ä¸è¦âš ï¸ è·‘æ¥ è§£æå™¨ğŸ¤–ï¸ åé¦ˆ",list0[i])
                } else if (type == "vless" ) { // version 150 support vless 
                  node=VL2QX(list0[i], Pudp, Ptfo, Pcert0, PTls13)
                } else if (QuanXK.some(NodeCheck1)) {
                    node = QX_TLS(isQuanX(list0[i])[0], Pcert0, PTls13)
                } else if (SurgeK.some(NodeCheck)) {
                    node = QX_TLS(Surge2QX(list0[i])[0], Pcert0, PTls13)
                } else if (LoonK.some(NodeCheck)) {
                    node = Loon2QX(list0[i])
                } 
            } catch (e) {
                failedList.push(`<<<\nContent: ${list0[i]}\nError: ${e}`)
            }
            if (Paead != "") {node = AeadVmess(node,Paead)} // vmess ç±»å‹ aead å¤„ç†
            if (Phost != "") {node = HOST_Handle(node,Phost)} // host å‚æ•°ä¿®æ”¹
            if (Pobfs != "") {node = OBFS_Handle(node,Pobfs)} // obfs å‚æ•°ä¿®æ”¹
            if (Psession != "") { node = Session_Handle(node,Psession)} // tls-session å‚æ•°
            if (Pcsha256 != "" || Ppsha256 != "") {
            node = SHA256_Handle(node,Pcsha256,Ppsha256)} // Sha256 å‚æ•°
            if (Palpn !="") { node = ALPN_Handle(node,Palpn)} // alpn å‚æ•°
            node = TLS_Check(node)
            if (node instanceof Array) {
                for (var j in node) {
                  node[j] = Pudp != 0 ? XUDP(node[j],Pudp) : node[j]
                  node[j] = Ptfo != 0 ? XTFO(node[j],Ptfo) : node[j]
                    QXlist.push(node[j])
                }
            } else if (node != ""  && node) {
              node = Pudp != 0 ? XUDP(node,Pudp) : node
              node = Ptfo != 0 ? XTFO(node,Ptfo) : node
                QXlist.push(node)
            }
        }
    }
    if (failedList.length > 0 && Pntf0 != 0) {
        $notify(`âš ï¸ æœ‰ ${failedList.length} æ¡æ•°æ®è§£æå¤±è´¥, å·²å¿½ç•¥`, "å‡ºé”™å†…å®¹ğŸ‘‡", failedList.join("\n"));
    }
    //$notify("QXList","check below content",QXlist)
    return QXlist;
}

// Vmess Aead  å…³é—­-é»˜è®¤å¼€å¯
function AeadVmess(cnt,aeadp) {
  let paead = aeadp == -1? "aead=false" : "aead=true" 
  if (/^vmess\s*\=/.test(cnt)) {
    if (/aead\s*\=/.test(cnt)) {
      cnt = cnt.replace(/aead\s*\=.*\,/,paead+",")
    } else {
      cnts = cnt.split(",")
      cnts.push(paead)
      //console.log(cnts)
      cnt=cnts.join(", ")
    }

  }
  return cnt
}

//æ–°ç‰ˆæœ¬tls çš„æ£€éªŒï¼ˆå­˜åœ¨sha256 å‚æ•°æ—¶ï¼‰
function TLS_Check(cnt) {
  cnt =cnt.indexOf("tls-cert-sha256")!=-1 || cnt.indexOf("tls-pubkey-sha256")!=-1 ? cnt.replace(/tls-verification\s*\=\s*false.*?\,/,"tls-verification=true,"): cnt // å»æ‰ tls-verification=false å¦‚æœå­˜åœ¨ sha256
  return cnt
}

// qx ç±»å‹ tls/udp éªŒè¯é—®é¢˜t
function QX_TLS(cnt,Pcert0,PTls13) {
  cnt =cnt.replace(/tag\s*\=/gm,"tag=") //
  var cert0 = Pcert0 == 1? "tls-verification=true, " : "tls-verification=false, "
  var tls13 = PTls13 == 1? "tls13=true, " : ""
  if(cnt.indexOf("tls-verification") != -1){ // å·²æœ‰tlså‚æ•°æ—¶, å¦‚ç”¨æˆ·ä¸æŒ‡å®šï¼Œåˆ™ä¸åšå¤„ç†
    cnt = (Pcert0 == -1 || Pcert0 == 1) ? cnt.replace(RegExp("tls\-verification.*?\,", "gmi"), cert0): cnt
    //cnt = Pcert0 == 1? cnt.replace(RegExp("tls\-verification.*?\,", "gmi"), cert0): cnt
  }else if(cnt.indexOf("obfs=over-tls")!=-1 || /over\-tls\s*\=\s*true/.test(cnt) || cnt.indexOf("obfs=wss")!=-1){ //æœªåŒ…å«tlså‚æ•°æ—¶
    cnt = cnt.replace(new RegExp("tag.*?\=", "gmi"), cert0+"tag=")
  }
  if (tls13 !="") {
  if(cnt.indexOf("tls13") != -1){
    cnt = cnt.replace(RegExp("tls13.*?\,", "gmi"), tls13)
  }else if(cnt.indexOf("obfs=over-tls")!=-1 || /over\-tls\s*\=\s*true/.test(cnt) || cnt.indexOf("obfs=wss")!=-1){
    cnt = cnt.replace(new RegExp("tag.*?\=", "gmi"), tls13+"tag=")
  }
  }
  if (!/^(shadowsocks|trojan|vmess)/.test(cnt.trim())) { //å…³é—­é ss/ssr/trojan/vmess ç±»å‹çš„ udp
    udp =  "udp-relay=false, "
    if(cnt.indexOf("udp-relay") != -1){
      var cnt = cnt.replace(RegExp("udp\-relay.*?\,", "gmi"), udp)
    }else{
      var cnt = cnt.replace(new RegExp("tag.*?\=", "gmi"), udp+"tag=")
    }
  }   
  return cnt
}

//å°†sip008æ ¼å¼çš„è®¢é˜…è½¬æ¢æˆquanxæ ¼å¼
function SIP2QuanX (cnt) {
  cnt = JSON.parse(cnt)
  ll =cnt.length
  nodes =[]
  for (i=0; i<ll; i++) {
    node = "shadowsocks= "
    cnti = cnt[i]
    ip = cnti.server + ":" + cnti.server_port
    mtd = "method=" + cnti.method
    pwd = "password=" + cnti.password
    obfs = cnti.plugin_opts? cnti.plugin_opts.replace(";", ", "):""
    tag = "tag="+cnti.remarks
    node = node +[ip,pwd, mtd, obfs, tag].filter(Boolean).join(", ")
    nodes.push(node)
  }
  return nodes.join("\n")
  //console.log(nodes)
}

//http=example.com:443, username=name, password=pwd, over-tls=true, tls-host=example.com, tls-verification=true, tls13=true, fast-open=false, udp-relay=false, tag=http-tls-02
//HTTPS ç±»å‹ URI è½¬æ¢æˆ QUANX æ ¼å¼
function HPS2QX(subs, Ptfo, Pcert0, PTls13) {
    var type = subs.indexOf("https://")!=-1? "https" : "http" 
    var server = subs.replace("https://", "").replace("http://", "").trim()//Base64.decode(subs.replace("https://", "")).trim().split("\u0000")[0];
    var nss = []
    if (server != "") {
      if (server.indexOf("@")!=-1) {
        var ipport = "http=" + server.split("@")[1].split("#")[0].split("/")[0].split("?")[0];
        var uname = "username=" + server.split(":")[0];
        var pwd = "password=" + server.split("@")[0].split(":")[1];
      } else {
        var ipport = server.split("#")[0].indexOf(":")==-1? "http=" + Base64.decode(server.split("#")[0].split("?")[0]) : "http=" + server.split("#")[0].split("?")[0]; // https://b64(ipport)
      }
        var tag = "tag=" + decodeURIComponent(server.split("#")[1]);
        var tls = type == "https"? "over-tls=true": "";
        var thost = subs.indexOf("peer=")!= -1? "tls-host=" + subs.split("peer=")[1].split("#")[0].split("&")[0] : "" // å­˜åœ¨peerså‚æ•°æ—¶ https://b64(ipport)?peer=xxx#server-remarks
        var cert = Pcert0 != 0 ? "tls-verification=true" : "tls-verification=false";
        var tfo = Ptfo == 1 ? "fast-open=true" : "fast-open=false";
        var tls13 = PTls13 == 1 ? "tls13=true" : "tls13=false";
        if (tls=="") {
          cert=""
          tls13=""
        }
        nss.push(ipport, uname, pwd, tls, thost, cert, tfo, tls13, tag)
    }
    var QX = nss.filter(Boolean).join(",");
    return QX
}

//quantumult æ ¼å¼çš„ vmess URI è½¬æ¢
function VQ2QX(subs, Pudp, Ptfo, Pcert0, PTls13) {
  var server = String(Base64.decode(subs.replace("vmess://", "").trim()).split("\u0000")[0])
  var node = ""
  var ip = "vmess=" + server.split(",")[1].trim() + ":" + server.split(",")[2].trim() + ", " + "method=aes-128-gcm, " + "password=" + server.split(",")[4].split("\"")[1] + ", "
  var tag = "tag=" + server.split("=")[0]
  var tfo = subs.indexOf("tfo=1") != -1 ? "fast-open=true, " : "fast-open=false, "
  var udp = Pudp == 1 ? "udp-relay=false, " : "udp-relay=false, "; // ä¸æ”¯æŒ vmess ç±»å‹ udp
  node = ip + tfo + udp
  var obfs = ""
  if (server.indexOf("obfs=") == -1) { // é ws/http ç±»å‹
    obfs = server.indexOf("over-tls=true") != -1 ? "obfs=over-tls, " : "" //over-tls
    var host = server.indexOf("tls-host") != -1 ? "obfs-host=" + server.split("tls-host=")[1].split(",")[0] + ", " : ""
    obfs = obfs + host
  } else if (server.indexOf("obfs=ws") != -1) {
    obfs = server.indexOf("over-tls=true") != -1 ? "obfs=wss, " : "obfs=ws, " //ws,wss ç±»å‹
    var uri = server.indexOf("obfs-path=") != -1 ? "obfs-uri=" + server.split("obfs-path=")[1].split("\"")[1] + ", " : "obfs-uri=/, "
    obfs = obfs + uri
    var host = server.indexOf("obfs-header=") != -1 ? "obfs-host=" + server.split("obfs-header=\"Host:")[1].split("[")[0].trim() + ", " : ""
    obfs = obfs + host
  } else if (server.indexOf("obfs=http") != -1) {
    obfs = "obfs=http, "
    var uri = server.indexOf("obfs-path=") != -1 ? "obfs-uri=" + server.split("obfs-path=")[1].split("\"")[1] + ", " : "obfs-uri=/, "
    obfs = obfs + uri
    var host = server.indexOf("obfs-header=") != -1 ? "obfs-host=" + server.split("obfs-header=\"Host:")[1].split("[")[0].trim() + ", " : ""
    obfs = obfs + host
  }
  if (obfs.indexOf("obfs=over-tls") != -1 || obfs.indexOf("obfs=wss") != -1) {
    var cert = Pcert0 != 0 || subs.indexOf("allowInsecure=1") != -1 ? "tls-verification=false, " : "tls-verification=true, "
    var tls13 = PTls13 == 1 ? "tls13=true, " : ""
    obfs = obfs + cert + tls13
  }
  node = node + obfs + tag
  return node
}


//Shadowrocket æ ¼å¼çš„ vmess URI è½¬æ¢
function VR2QX(subs, Pudp, Ptfo, Pcert0, PTls13) {
  var server = String(Base64.decode(subs.replace("vmess://", "").split("?remark")[0].split("&remark")[0].split("?")[0]).trim()).split("\u0000")[0]
  if(Pdbg==1) {$notify("Shadowrocket-Vmess-URI","..",subs+"\n\n"+server)}
  if (server.indexOf("@")==-1 && subs.indexOf("@")!=-1) { server = subs.replace("vmess://", "").split("?")[0]}
  var node = ""
  var ip = "vmess=" + server.split("@")[1] + ", " + "method=aes-128-gcm, " 
  var pwd =  server.split("@")[0].split(":")[1]? "password=" + server.split("@")[0].split(":")[1] + ", " : "password=" + server.split("@")[0]+ ", "
  if (subs.indexOf("#")==-1) {
    tag = /remarks*=/.test(subs)? "tag=" + decodeURIComponent(subs.split(/remarks*=/)[1].split("&")[0]) : "tag="+server.split("@")[1] //éƒ¨åˆ†æ— èŠ‚ç‚¹åçš„æƒ…å†µ
  } else {
    tag = "tag=" + subs.split("#")[1]
  }
  var tfo = subs.indexOf("tfo=1") != -1 ? "fast-open=true, " : "fast-open=false, "
  var udp = Pudp == 1 ? "udp-relay=false, " : "udp-relay=false, ";
  var pdrop = 0
  node = ip + pwd+ tfo + udp
  var obfs = subs.indexOf("obfs=")!=-1 ? subs.split("obfs=")[1].split("&")[0].trim() : "none"
  if (obfs == "none") { //
    obfs = subs.indexOf("tls=1") != -1 ? "obfs=over-tls, " : "" //over-tls
  } else if (obfs == "websocket" || obfs == "http") {
    obfs = obfs == "http" ? "obfs=http, " : "obfs=ws, " // http ç±»å‹
    obfs = subs.indexOf("tls=1") != -1 ? "obfs=wss, " : obfs //ws,wss ç±»å‹
    var ouri = subs.indexOf("&path=") != -1 ? decodeURIComponent(subs.split("&path=")[1].split("&")[0]) : "/" //ws,wss ç±»å‹
    obfs = obfs + "obfs-uri=" + ouri + ", "
    var host = subs.indexOf("&obfsParam=") != -1 ? decodeURIComponent(subs.split("&obfsParam=")[1].split("&")[0].split("\n")[0]).split("\n")[0].trim() : ""
    if (host.indexOf("\"Host\"")!=-1 && host.indexOf("{")!=-1) {
      host = JSON.parse(host)["Host"]
    }
    host = host!="{}" && host ? "obfs-host=" + host + ", " : ""
    obfs = obfs + host
  } else if (obfs=="grpc" || obfs =="h2") {
    Perror = 1 // ä¸éœ€è¦åé¦ˆçš„ç±»å‹
    if (Pntf0!=0) {
    $notify( "âš ï¸ Quantumult X æš‚ä¸æ”¯æŒè¯¥ç±»å‹èŠ‚ç‚¹", "å·²å¿½ç•¥ä»¥ä¸‹ grpc|h2 vmess èŠ‚ç‚¹",subs)
  }
    pdrop = 1
  }
  if (obfs.indexOf("obfs=over-tls") != -1 || obfs.indexOf("obfs=wss") != -1) {
    var cert = Pcert0 != 0 || subs.indexOf("allowInsecure=1") != -1 ? "tls-verification=false, " : "tls-verification=true, "
    var tls13 = PTls13 == 1 ? "tls13=true, " : ""
    obfs = obfs + cert + tls13
  }
  caead="aead=false, "
  if (subs.indexOf("alterId=") != -1) {
    caead = Number(subs.split("alterId=")[1].split("&")[0]) != 0 ? "aead=false, " : ""
  }
  node = pdrop==0? node + obfs +caead+ tag : ""
  //$notify(node)
  return node
}

//Shadowrocket æ ¼å¼çš„ socks URI è½¬æ¢
function S5R2QX(cnt,tlsp="false") {
  var listh = Base64.decode(cnt.split("socks://")[1].split("#")[0].split("?")[0])
  server=listh+"#"+cnt.split("?")[1]
  var nss = []
  if (server != "") {
      var ipport = "socks5=" + server.split("@")[1].split("#")[0].split("/")[0];
      var uname = "username=" + server.split(":")[0];
      var pwd = "password=" + server.split("@")[0].split(":")[1];
      var tag = "tag=" + decodeURIComponent(server.split("remarks=")[1].split("&")[0]);
      var tls = tlsp=="false"? "":"over-tls=true"
      var cert = Pcert0 != 0 ? "tls-verification=true" : "tls-verification=false";
      cert = tls == ""? "":cert
      var tfo = Ptfo0 == 1 ? "fast-open=true" : "fast-open=false";
      nss.push(ipport, uname, pwd, tls, cert, tfo, tag)
  }
  var QX = nss.filter(Boolean).join(",");
  return QX
}
 


//V2RayN uri è½¬æ¢æˆ QUANX æ ¼å¼
function V2QX(subs, Pudp, Ptfo, Pcert0, PTls13) {
  //console.log("v2 type",subs)
  var cert = Pcert0
  var tls13 = PTls13
  var server = String(Base64.decode(subs.replace("vmess://", "")).trim()).split("\u0000")[0];
  var nss = [];
  if (server != "") {
    ss = JSON.parse(server);
    if(Pdbg) {$notify("Vmess-URI","",JSON.stringify(ss))}
    ip = "vmess=" + ss.add + ":" + ss.port;
    pwd = "password=" + ss.id;
    mtd = "method=aes-128-gcm"
    try {
      tag = "tag=" + decodeURIComponent(ss.ps);
    } catch (e) {
      tag = "tag=" + ss.ps;
    }
    udp = Pudp == 1 ? "udp-relay=false" : "udp-relay=false";
    tfo = Ptfo == 1 ? "fast-open=true" : "fast-open=false";
    obfs = Fobfs(ss, cert, tls13);
    caead = ss.aid && ss.aid != "0" ? "aead=false" : "aead=true"; //aead é€‰é¡¹
    if (obfs == "" || obfs == undefined) {
      nss.push(ip, mtd, pwd, tfo, udp, caead, tag)
    } else if(obfs != "NOT-SUPPORTTED"){
      nss.push(ip, mtd, pwd, obfs, tfo, udp, caead, tag);
    }
    QX = nss.join(", ");
  }
  return QX
}

// Vmess obfs å‚æ•°
function Fobfs(jsonl, Pcert0, PTls13) {
  var obfsi = [];
  var cert = Pcert0;
  tcert = cert == 0 ? "tls-verification=false" : "tls-verification=true";
  tls13 = PTls13 == 1 ? "tls13=true" : "tls13=false"
  if (jsonl.net == "ws" && jsonl.tls == "tls") {
    obfs0 = "obfs=wss, " + tcert + ", " + tls13 + ", ";
    uri0 = jsonl.path && jsonl.path != "" ? "obfs-uri=" + jsonl.path : "obfs-uri=/";
    uri0 = uri0.indexOf("uri=/")!=-1 ? uri0:uri0.replace("uri=","uri=/")
    host0 = jsonl.host && jsonl.host != "" ? "obfs-host=" + jsonl.host + ", " : "";
    obfsi.push(obfs0 + host0 + uri0)
    return obfsi.join(", ")
  } else if (jsonl.net == "ws") {
    obfs0 = "obfs=ws";
    uri0 = jsonl.path && jsonl.path != "" ? "obfs-uri=" + jsonl.path : "obfs-uri=/";
    uri0 = uri0.indexOf("uri=/")!=-1 ? uri0:uri0.replace("uri=","uri=/")
    host0 = jsonl.host && jsonl.host != "" ? "obfs-host=" + jsonl.host + ", " : "";
    obfsi.push(obfs0, host0 + uri0);
    return obfsi.join(", ")
  } else if (jsonl.tls == "tls" && (jsonl.net == "tcp" || jsonl.net == "none")) { // è¿‡æ»¤æ‰ h2/http ç­‰ç±»å‹ 
    obfs0 = "obfs=over-tls, " + tcert + ", " + tls13;
    uri0 = jsonl.path && jsonl.path != "" ? "obfs-uri=" + jsonl.path : "";
    uri0 = uri0.indexOf("uri=/")!=-1 ? uri0:uri0.replace("uri=","uri=/")
    host0 = jsonl.host && jsonl.host != "" ? ", obfs-host=" + jsonl.host : "";
    obfsi.push(obfs0 + host0)
    return obfsi.join(", ")
  } else if ((jsonl.net == "tcp" || jsonl.net == "none") && jsonl.type == "http"){
    obfs0 = "obfs=http";
    uri0 = jsonl.path && jsonl.path != "" ? "obfs-uri=" + jsonl.path : "obfs-uri=/";
    uri0 = uri0.indexOf("uri=/")!=-1 ? uri0:uri0.replace("uri=","uri=/")
    host0 = jsonl.host && jsonl.host != "" ? "obfs-host=" + jsonl.host + ", " : "";
    obfsi.push(obfs0, host0 + uri0);
    return obfsi.join(", ")
  } else if (jsonl.net !="tcp" && jsonl.net !="none" &&  jsonl.net != undefined){ // è¿‡æ»¤æ‰ h2/http ç­‰ç±»å‹
    Perror = 1
    $notify("âš ï¸ Quantumult X ä¸æ”¯æŒè¯¥ç±»å‹èŠ‚ç‚¹", "vmess + " + jsonl.net, JSON.stringify(jsonl))
    return "NOT-SUPPORTTED"
  } else if ((jsonl.net == "tcp" || jsonl.net == "none") && jsonl.type != undefined && jsonl.type != "none" && jsonl.type != "" && jsonl.type != "vmess") {
    return "NOT-SUPPORTTED"
  } else {return ""}
}

//å¯¹.çš„ç‰¹æ®Šå¤„ç†(in/out & renameä¸­)
function Dot2(cnt) {
    cnt = cnt ? cnt.replace(/\\\./g, "è¿™æ˜¯ä¸ªç‚¹") : ""
    return cnt
}

function ToDot(cnt) {
    cnt = cnt ? cnt.replace(/è¿™æ˜¯ä¸ªç‚¹/g, ".") : ""
    return cnt
}

//æ­£åˆ™ç­›é€‰, å®Œæ•´å†…å®¹åŒ¹é…
function Regex(content) {
    var Preg0 = RegExp(Preg, "i")
    cnt = content //.split("tag=")[1]
    if (Preg0.test(cnt)) {
        return content
    }
}

//æ­£åˆ™åˆ é™¤, å®Œæ•´å†…å®¹åŒ¹é…
function RegexOut(content) {
  var Preg0 = RegExp(Pregout, "i")
  cnt = content //.split("tag=")[1]
  if (!Preg0.test(cnt)) {
    return content
  } else {
    RegoutList.push(cnt)
  }
}

// åˆ¤æ–­èŠ‚ç‚¹è¿‡æ»¤çš„å‡½æ•°
function Scheck(content, param) {
    name = content.replace(/tag\s*\=/g,"tag=").split("tag=")[1].toUpperCase()
    param = param ? param.map(Dot2) : param // å¯¹ç¬¦å·.çš„ç‰¹æ®Šå¤„ç†
    if (param) {
        var flag = 0;
        for (var i = 0; i < param.length; i++) {
            var params = param[i].split(".").map(ToDot);
            const checkpara = (item) => name.indexOf(item.toUpperCase()) != -1;
            if (params.every(checkpara)) {
                flag = 1
            }
        }//for
        return flag
    } else { //if param
        return 2
    }
}

//èŠ‚ç‚¹è¿‡æ»¤ï¼Œä½¿ç”¨+è¿æ¥å¤šä¸ªå…³é”®è¯(é€»è¾‘"æˆ–"):in ä¸ºä¿ç•™ï¼Œout ä¸ºæ’é™¤, "ä¸"é€»è¾‘è¯·ç”¨ç¬¦å·"."è¿æ¥
function Filter(servers, Pin, Pout) {
    var Nlist = [];
    var Delist = [];
    var Nname = [];
    servers = servers.filter(Boolean)
    for (var i = 0; i < servers.length; i++) {
        if (Scheck(servers[i], Pin) != 0 && Scheck(servers[i], Pout) != 1) {
            Nlist.push(servers[i])
            Nname.push(servers[i].replace(/ /g, "").split("tag=")[1])
        } else { Delist.push(servers[i].replace(/ /g, "").split("tag=")[1]) } //è®°å½•æœªè¢«ä¿ç•™èŠ‚ç‚¹
    }//for
    var no = Delist.length <= 10 ? emojino[Delist.length] : Delist.length;
    var no1 = Nlist.length <= 10 ? emojino[Nlist.length] : Nlist.length;
    if (Pntf0 == 1 && Delist.length >= 1) {//é€šçŸ¥éƒ¨åˆ†
        if (Pin && no1 > 0) { //æœ‰ in å‚æ•°å°±é€šçŸ¥ä¿ç•™éƒ¨åˆ†
            $notify("ğŸ‘¥ å¼•ç”¨" + "âŸ¦" + subtag + "âŸ§" + " å¼€å§‹èŠ‚ç‚¹ç­›é€‰", "ğŸ•¹ ç­›é€‰å…³é”®å­—: " + pfi + pfo, "â˜ ï¸ å·²ä¿ç•™ä»¥ä¸‹ " + no1 + "ä¸ªèŠ‚ç‚¹\n" + Nname.join(", "), sub_link);
        } else if (Pout && no > 0) {
            $notify("ğŸ‘¥ å¼•ç”¨" + "âŸ¦" + subtag + "âŸ§" + " å¼€å§‹èŠ‚ç‚¹ç­›é€‰", "ğŸ•¹ ç­›é€‰å…³é”®å­—: " + pfi + pfo, "â˜ ï¸ å·²åˆ é™¤ä»¥ä¸‹ " + no + "ä¸ªèŠ‚ç‚¹\n" + Delist.join(", "), sub_link);
        }
    } else if (no1 == 0 || no1 == null) { //æ— å‰©ä½™èŠ‚ç‚¹æ—¶å¼ºåˆ¶é€šçŸ¥
        $notify("â€¼ï¸ âŸ¦" + subtag + "âŸ§" + "ç­›é€‰åèŠ‚ç‚¹æ•°ä¸º0ï¸âƒ£", "âš ï¸ è¯·è‡ªè¡Œæ£€æŸ¥åŸå§‹é“¾æ¥ä»¥åŠç­›é€‰å‚æ•°", link0, sub_link);
    }
    return Nlist
}

function FilterScript(servers, script) {
    $notify("ğŸ¤– å¯ç”¨è„šæœ¬è¿›è¡Œç­›é€‰", "", script);
    try {
        const $ = Tools();
        eval(script);
        // extract server tags
        const nodes = Tools().getNodeInfo(servers);
        const IN = filter(nodes);
        const res = servers.filter((_, i) => IN[i]);
        if (res.length === 0) {
            $notify("â€¼ï¸ âŸ¦" + subtag + "âŸ§" + "ç­›é€‰åèŠ‚ç‚¹æ•°ä¸º0ï¸âƒ£", "âš ï¸ è¯·è‡ªè¡Œæ£€æŸ¥åŸå§‹é“¾æ¥ä»¥åŠç­›é€‰å‚æ•°", link0, sub_link);
        }
        return res;
    } catch (err) {
        $notify("âŒ è„šæœ¬ç­›é€‰å‡ºç°é”™è¯¯", "", err);
        return servers;
    }
}

//a.c.com:0031:origin:aes-256-gcm:plain:pwdpwd/?obfsparam=&remarks=xxxx
//SSR ç±»å‹ URI è½¬æ¢ quanx æ ¼å¼
function SSR2QX(subs, Pudp, Ptfo) {
    var nssr = []
    var cnt = Base64.decode(subs.split("ssr://")[1].replace(/-/g, "+").replace(/_/g, "/")).split("\u0000")[0]
    var obfshost = '';
    var oparam = '';
    if(Pdbg==1) {$notify("ssr","content",cnt)}
    if (cnt.split(":").length <= 8) { //æ’é™¤éš¾æçš„ ipv6 èŠ‚ç‚¹
        type = "shadowsocks=";
        ip = cnt.split(":")[0] + ":" + cnt.split(":")[1];
        pwd = "password=" + Base64.decode(cnt.split("/?")[0].split(":")[5].replace(/-/g, "+").replace(/_/g, "/")).split("\u0000")[0];
        mtd = "method=" + cnt.split(":")[3];
        obfs =cnt.split(":")[4]!= "plain"? "obfs=" + cnt.split(":")[4] : ""; //plain?
        ssrp = cnt.split(":")[2] != "origin"? "ssr-protocol=" + cnt.split(":")[2] : ""; //origin?
        if (cnt.indexOf("obfsparam=") != -1 && obfs != "") {
            obfshost = cnt.split("obfsparam=")[1].split("&")[0] != "" ? "obfs-host=" + Base64.decode(cnt.split("obfsparam=")[1].split("&")[0].replace(/-/g, "+").replace(/_/g, "/")).split(",")[0].split("\u0000")[0] : ""
        }
        if (cnt.indexOf("protoparam=") != -1) {
            oparam = cnt.split("protoparam=")[1].split("&")[0] != "" ? "ssr-protocol-param=" + Base64.decode(cnt.split("protoparam=")[1].split("&")[0].replace(/-/g, "+").replace(/_/g, "/")).split(",")[0].split("\u0000")[0]  : ""
        }
        tag = "tag=" + (Base64.decode(cnt.split("remarks=")[1].split("&")[0].replace(/-/g, "+").replace(/_/g, "/"))).split("\u0000")[0]
        pudp = Pudp == 1 ? "udp-relay=true" : "udp-relay=false";
        ptfo = Ptfo == 1 ? "fast-open=true" : "fast-open=false";
        nssr.push(type + ip, pwd, mtd, obfs , obfshost, oparam, ssrp, pudp, ptfo, tag)
        QX = nssr.filter(Boolean).join(", ")
    } else { QX = "" }
    return QX;
}

// Vless uri è½¬æ¢æˆ QUANX æ ¼å¼
// vless://pwd@a.b.c.gq:443?encryption=none&security=tls&type=ws&host=a.b.c.d&path=dsjdaaaaj#VLESS_WSS
// Vless Shadowrocket URI
// vless://YXV0bzpkampkakAxLjEuMS4xOjY2NjY?remarks=vless&obfsParam=123.com&path=/jsjdj&obfs=websocket&tls=1&peer=abc.com&tfo=1
//;vless=example.com:443, method=none, password=23ad6b10-8d1a-40f7-8ad0-e3e35cd32291, obfs=wss, obfs-uri=/ws, fast-open=false, udp-relay=false, tag=vless-ws-tls-01
//vless://YXV0bzpkampkakAxLjEuMS4xOjY2NjY?remarks=vless&obfsParam=hshdh&path=/jsjdj&obfs=http&tls=1&peer=abc.com&tfo=1
//vls = VLESS,1.1.1.1,443,"b0dd64e4-0fbd-4038-9139-d1f32a68a0dc",transport=ws,path=patha,host=host.com,udp=true,over-tls=true,tls-name=sni.co
function VL2QX(subs, Pudp, Ptfo, Pcert0, PTls13) {
  var nvless = []
  var cnt = subs.split("vless://")[1]
  type = "vless=";
  mtd= "method=none"
  obfs=""
  thost=""
  if(cnt.indexOf("remarks=")==-1 && cnt.indexOf("@")!=-1) { // normal URI
  typeU = "URI"
  ip = cnt.split("@")[1].split("encry")[0].split("?")[0];
  pwd = cnt.split("@")[0]? "password=" + cnt.split("@")[0]:"";
  pcert = cnt.indexOf("allowInsecure=0") != -1 ? "tls-verification=true" : "tls-verification=false";
  thost = cnt.indexOf("sni=") != -1? "tls-host="+cnt.split("sni=")[1].split(/&|#/)[0]:""
  thost = cnt.indexOf("peer=") != -1? "tls-host="+cnt.split("peer=")[1].split(/&|#/)[0]:thost
  tag = cnt.indexOf("#") != -1 ? "tag=" + decodeURIComponent(cnt.split("#").slice(-1)[0]) : "tag= [vless]" + ip
  } else { // shadowrocket style
    typeU = "SR-URI"
    tag = cnt.indexOf("remarks=") != -1 ? "tag=" + decodeURIComponent(cnt.split("remarks=")[1].split("&")[0]) : "tag= [vless]" + ip
    b64part = Base64.decode(cnt.split("?")[0])
    ip = b64part.split("@")[1]
    pwd = "password=" + b64part.split("@")[0].split(":")[1]
  }
  
  puri = ""
 
  pudp = (Pudp == 1 || cnt.indexOf("udp=1")!=-1) ? "udp-relay=true" : "udp-relay=false";
  ptfo = (Ptfo == 1 || cnt.indexOf("tfo=1")!=-1)? "fast-open=true" : "fast-open=false";
  //ptfo = cnt.indexOf("tfo=1") != -1? "fast-open=true" : ptfo
  if (typeU == "SR-URI") {//å°ç«ç®­å†…çš„websocketå†™æ³•
    if(cnt.indexOf("obfs=none")!=-1 && cnt.indexOf("tls=1")==-1) {
      obfs = ""
    } else if(cnt.indexOf("obfs=none")!=-1 && cnt.indexOf("tls=1")!=-1) {
      obfs = "obfs=over-tls"
    } else if(cnt.indexOf("obfs=http")!=-1) {
      obfs = "obfs=http"
    } else if(cnt.indexOf("obfs=websocket")!=-1) {
      obfs = cnt.indexOf("tls=1") != -1? "obfs=wss" : "obfs=ws"
    } 
  thost=cnt.indexOf("obfsParam=") == -1? thost : "obfs-host=" + decodeURIComponent(cnt.split("obfsParam=")[1].split("&")[0].split("#")[0])
  puri = cnt.indexOf("path=") == -1? puri : "obfs-uri=" + decodeURIComponent(cnt.split("path=")[1].split("&")[0].split("#")[0])
  } else if (cnt.indexOf("&type=ws")!=-1 || cnt.indexOf("?type=ws")!=-1 || cnt.indexOf("type=http")!=-1 || cnt.indexOf("security=tls")!=-1) {//v2rayN uri
    if(cnt.indexOf("type=http") != -1) {
      obfs="obfs=http"
    } else if (cnt.indexOf("type=ws") != -1) {
      obfs = cnt.indexOf("security=tls") != -1? "obfs=wss" : "obfs=ws" 
    } else if(cnt.indexOf("security=tls")!=-1) {
      obfs = "obfs=over-tls"
    }
    thost=cnt.indexOf("&host=") == -1? thost : "obfs-host=" + decodeURIComponent(cnt.split("&host=")[1].split("&")[0].split("#")[0])
    puri = cnt.indexOf("&path=") == -1? puri : "obfs-uri=" + decodeURIComponent(cnt.split("&path=")[1].split("&")[0].split("#")[0])
  } else if(cnt.indexOf("security=xtls")!=-1) { //æš‚ä¸æ”¯æŒç±»å‹
    type="NS"
  } else if(cnt.indexOf("type=")!=-1 && cnt.indexOf("type=tcp")==-1) {//æš‚ä¸æ”¯æŒç±»å‹
    type="NS"
  }
if(obfs=="obfs=wss" && obfs=="obfs=over-tls"){
  ptls13 = PTls13 == 1 ? "tls13=true" : "tls13=false"
  if (Pcert0 == 0) { 
    pcert = "tls-verification=false" 
  } else if (Pcert0 == 1) {
    pcert = "tls-verification=true"
  }
} else {
  pcert=""
  ptls13=""
}

  nvless.push(type + ip, pwd, mtd, obfs, pcert, thost, puri, pudp, ptfo, tag)
  QX = type!="NS"? nvless.filter(Boolean).join(", ")  : ""
  //$notify("VLESS","subtitle",QX)
  return QX
}

//Trojan ç±»å‹ URI è½¬æ¢æˆ QX, åŒ…å«å°ç«ç®­ç±»å‹
function TJ2QX(subs, Pudp, Ptfo, Pcert0, PTls13) {
    var ntrojan = []
    var cnt = subs.split("trojan://")[1]
    type = "trojan=";
    if (cnt.indexOf(":443") != -1) {
        ip = cnt.split("@")[1].split(":443")[0] + ":443";
    } else {
        ip = cnt.split("@")[1].split("?")[0].split("\n")[0].split("#")[0].trim(); //é 443 ç«¯å£çš„å¥‡è‘©æœºåœºï¼Ÿ
    }
    pwd = cnt.split("@")[0]? "password=" + decodeURIComponent(cnt.split("@")[0]):"";
    obfs = "over-tls=true";
    pcert = cnt.indexOf("allowInsecure=0") != -1 ? "tls-verification=true" : "tls-verification=false";
    thost = cnt.indexOf("sni=") != -1? "tls-host="+cnt.split("sni=")[1].split(/&|#/)[0]:""
    thost = cnt.indexOf("peer=") != -1? "tls-host="+cnt.split("peer=")[1].split(/&|#/)[0]:thost
    ptls13 = PTls13 == 1 ? "tls13=true" : "tls13=false"
    puri = ""
    if (Pcert0 == 0) { 
      pcert = "tls-verification=false" 
    } else if (Pcert0 == 1) {
      pcert = "tls-verification=true"
    }
    pudp = (Pudp == 1 || cnt.indexOf("udp=1")!=-1) ? "udp-relay=true" : "udp-relay=false";
    ptfo = (Ptfo == 1 || cnt.indexOf("tfo=1")!=-1)? "fast-open=true" : "fast-open=false";
    //ptfo = cnt.indexOf("tfo=1") != -1? "fast-open=true" : ptfo
    tag = cnt.indexOf("#") != -1 ? "tag=" + decodeURIComponent(cnt.split("#").slice(-1)[0]) : "tag= [trojan]" + ip
    if (cnt.indexOf("&plugin=obfs-local")!=-1) {//å°ç«ç®­å†…çš„websocketå†™æ³•
    obfs = cnt.indexOf("obfs=websocket") != -1? "obfs=wss" : obfs 
    thost=cnt.indexOf("obfs-host=") == -1? thost : "obfs-host=" + decodeURIComponent(cnt.split("obfs-host=")[1].split(";")[0].split("#")[0])
    puri = cnt.indexOf("obfs-uri=") == -1? puri : "obfs-uri=" + decodeURIComponent(cnt.split("obfs-uri=")[1].split(";")[0].split("#")[0])
    } else if (cnt.indexOf("&type=ws")!=-1 || cnt.indexOf("?type=ws")!=-1) {//v2rayN uri
      obfs = cnt.indexOf("security=tls") != -1? "obfs=wss" : obfs 
      thost=cnt.indexOf("&host=") == -1? thost : "obfs-host=" + decodeURIComponent(cnt.split("&host=")[1].split("&")[0].split("#")[0])
      puri = cnt.indexOf("&path=") == -1? puri : "obfs-uri=" + decodeURIComponent(cnt.split("&path=")[1].split("&")[0].split("#")[0])
    }
    ntrojan.push(type + ip, pwd, obfs, pcert, thost, puri, pudp, ptfo, tag)
    QX = ntrojan.filter(Boolean).join(", ");
    //$notify("title","subtitle",QX)
    return QX;
}

function joinx(total,item) {
  return total+":"+item
}

//SS ç±»å‹ URI è½¬æ¢ quanx æ ¼å¼
function SS2QX(subs, Pudp, Ptfo) {
  var nssr = []
  var cnt = subs.split("ss://")[1]
  QX=""
  if (cnt.split(":").length <= 10) { //æ’é™¤éš¾æçš„ ipv6 èŠ‚ç‚¹
    type = "shadowsocks=";
    let cntt = cnt.split("#")[0]
    //console.log(cntt)
    if (cntt.indexOf("@") != -1 && cntt.indexOf(":") != -1) {
      ip = cnt.split("@")[1].split("#")[0].split("/")[0].split("?")[0];
      pwdmtd = Base64.decode(cnt.split("@")[0].replace(/-/g, "+").replace(/_/g, "/")).split("\u0000")[0].split(":")
    } else if (cntt.indexOf("?")==-1) { // åéƒ¨ b64 encode ç±»å‹
      var cnt0 = Base64.decode(cnt.split("#")[0].replace(/-/g, "+").replace(/_/g, "/").split("\u0000")[0]);
      ip = cnt0.split("@")[1].split("#")[0].split("/")[0];
      pwdmtd = cnt0.split("@")[0].split(":")
    } else if (cntt.indexOf("?") !=-1) { // ç«ç®­ç±»å‹ï¼Ÿ
      var cnt0 = Base64.decode(cnt.split("#")[0].split("?")[0].replace(/-/g, "+").replace(/_/g, "/").split("\u0000")[0]);
      var cnt1 = Base64.decode(cnt.split("#")[0].split("?")[1].split("=")[1].replace(/-/g, "+").replace(/_/g, "/").split("\u0000")[0]);
      ip = cnt0.split("@")[1].split("#")[0].split("/")[0];
      pwdmtd = cnt0.split("@")[0].split(":")
    }
    mtd = "method=" + pwdmtd[0];
    pwdmtd.splice(0,1) 
    pwd = "password=" + pwdmtd.reduce(joinx);
    if (cntt.indexOf("v2ray-plugin")==-1 && cntt.indexOf("plugin=v2ray")==-1) { //Shadowrocket style v2-plugin
      obfs = cnt.split("obfs%3D")[1] != null ? ", obfs=" + cnt.split("obfs%3D")[1].split("%3B")[0].split("#")[0] : "";
      obfshost = cnt.split("obfs-host%3D")[1] != null ? ", obfs-host=" + cnt.split("obfs-host%3D")[1].split("&")[0].split("#")[0] : "";
    } else if (cnt1 != undefined){
      cnt1 = JSON.parse(cnt1)
      obfs= cnt1.tls? ", obfs=wss" : ", obfs=ws"
      obfshost = cnt1.host? ", obfs-host="+cnt1.host+", tls-verification=false" : ""
    } else if (cntt.indexOf("v2ray-plugin")!=-1){
      cnt1 = decodeURIComponent(cntt.split("v2ray-plugin")[1])
      obfs= cnt1.indexOf("tls")!=-1? ", obfs=wss" : ", obfs=ws"
      obfshost = cnt1.indexOf("host=")!=-1? ", obfs-host="+cnt1.split("host=")[1].split(";")[0].split("#")[0].trim() : ""
      obfshost = obfshost != "obfs-host="? obfshost : ""
      //$notify("CNTT","",cnt1+obfs+obfshost)
    } else if (cntt.indexOf("plugin=v2ray")!=-1) {
      cnt1 = decodeURIComponent(cntt.split("plugin=v2ray")[1])
      obfs= cnt1.indexOf("tls")!=-1? ", obfs=wss" : ", obfs=ws"
      obfshost = cnt1.indexOf("host=")!=-1? ", obfs-host="+cnt1.split("host=")[1].split(";")[0].split("#")[0].trim() : ""
      obfshost = obfshost != "obfs-host="? obfshost : ""
      //$notify("CNTT","",cnt1+obfs+obfshost)

    }
    tag = decodeURIComponent(cnt.split("#")[1])!="undefined"? "tag=" + decodeURIComponent(cnt.split("#")[1]) : "tag=" + ip
    pudp = Pudp == 1 ? "udp-relay=true" : "udp-relay=false";
    ptfo = Ptfo == 1 ? "fast-open=true" : "fast-open=false";
    nssr.push(type + ip, pwd, mtd + obfs + obfshost, pudp, ptfo, tag)
    QX = nssr.join(", ")
    if(Pdbg==1) {$notify("SS","content",cnt+"\n"+QX)}
  }
  return QX;
}


//SSD ç±»å‹ URI è½¬æ¢ quanx æ ¼å¼
function SSD2QX(subs, Pudp, Ptfo) {
    var j = 0
    var QX = []
    var cnt = JSON.parse(Base64.decode(subs.split("ssd://")[1]))
    var type = "shadowsocks=";
    var pwd = "password=" + cnt.password;
    var mtd = "method=" + cnt.encryption;
    var obfs = ""
    var obfshost = ""
    var port = cnt.port ? ":" + cnt.port : ""
    if (cnt.plugin_options) {
        obfs = cnt.plugin_options.split(";")[0] != null ? ", " + cnt.plugin_options.split(";")[0] : "";
        obfshost = cnt.plugin_options.split(";")[1] != null ? ", " + cnt.plugin_options.split(";")[1] : "";
    }
    pudp = Pudp == 1 ? "udp-relay=true" : "udp-relay=false";
    ptfo = Ptfo == 1 ? "fast-open=true" : "fast-open=false";
    for (var i in cnt.servers) {
        ip = cnt.servers[i].server;
        if (cnt.servers[i].plugin_options) {
            obfs = cnt.servers[i].plugin_options.split(";")[0] != null ? ", " + cnt.servers[i].plugin_options.split(";")[0] : "";
            obfshost = cnt.servers[i].plugin_options.split(";")[1] != null ? ", " + cnt.servers[i].plugin_options.split(";")[1] : "";
        }
        if (cnt.servers[i].encryption) {  //ç‹¬ç«‹çš„åŠ å¯†æ–¹å¼
            mtd = "method=" + cnt.servers[i].encryption
        }
        if (cnt.servers[i].password) {  //ç‹¬ç«‹çš„å¯†ç 
            pwd = "password=" + cnt.servers[i].password
        }
        if (ip.indexOf(".") > 0) { //æ’é™¤éš¾æçš„ ipv6 èŠ‚ç‚¹
            port = cnt.servers[i].port ? ":" + cnt.servers[i].port : port;
            tag = "tag=" + cnt.servers[i].remarks;
            QX[j] = type + ip + port + ", " + pwd + ", " + mtd + obfs + obfshost + ", " + pudp + ", " + ptfo + ", " + tag;
            var j = j + 1;
        }
    }
    return QX;
}

// çº æ­£éƒ¨åˆ†ä¸è§„èŒƒçš„å†™æ³•(æ²¡æœ‰æŠŠ tag å†™åœ¨æœ€å)
function QXFix(cntf) {
var cnti = cntf.replace(/\s*tag\s*\=/g,"tag=").replace("chacha20-poly","chacha20-ietf-poly")
try {
  var hd = cnti.split(",tag=")[0]
  var tag = "tag="+cnti.split(",tag=")[1].split(",")[0].trim()
  var tail = cnti.split(tag+",")
  cnti = tail.length<=1?  cnti : String(hd + ","+tail[1].split("\r")[0] +"," + tag)
  cntis = cnti.split(",").filter(Boolean).map(item => item.trim()) //é˜²æ­¢èŠ‚ç‚¹åä¸­æœ‰,ç¬¦å·è€Œå¯¼è‡´çš„é”™è¯¯æƒ…å†µ
  tagfix = ""
  cntii = ""
  for (i in cntis) {
    if (cntis[i].indexOf("=") == -1 && cntis[i].trim() !="") {  // tag ä¸­å¤šå‡ºçš„é¡¹ç›®
      tagfix += ","+cntis[i]
    } else {
      cntis[i].indexOf("tag=") != 0? cntii += cntis[i]+", ": cntii=cntii
    }
  }
  cntii = cntii+tag+tagfix
  //$notify("tag-fix","Look","cntf:\n"+cntf+"\nhd:\n"+hd+"\ntag:\n"+tag+"\ntail:\n"+tail+"\ncnti: \n"+cnti +"\n\ncntii: \n"+cntii)
  return cntii
} catch (err) {
  if(Perror == 0) {
  $notify("âŒ è§£æå‡ºç°é”™è¯¯,å·²å¿½ç•¥è¯¥æ¡ç›®", "âš ï¸ è¯·ç‚¹å‡»é€šçŸ¥ï¼Œå‘é€è®¢é˜…é“¾æ¥è¿›è¡Œåé¦ˆ", cntf+"\n"+ err, bug_link);
}
}
  return ""
}

// ç”¨äºè¿‡æ»¤éèŠ‚ç‚¹éƒ¨åˆ†ï¼ˆæ¯”å¦‚æ•´ä»½é…ç½®ä¸­å…¶å®ƒå†…å®¹ï¼‰,åŒæ—¶çº æ­£éƒ¨åˆ†ä¸è§„èŒƒçš„å†™æ³•(æ²¡æœ‰æŠŠ tag å†™åœ¨æœ€å)
function isQuanX(content) {
    var cnts = content.split("\n");
    var nlist = []
    for (var i = 0; i < cnts.length; i++) {
        var cnti = cnts[i];
        if (cnti.indexOf("=") != -1 && cnti.indexOf("tag") != -1) {
            var cnt = cnti.split("=")[0].trim()
            if (cnt == "http" || cnt == "shadowsocks" || cnt == "trojan" || cnt == "vmess" || cnt == "socks5" || cnt == "vless") {
                nlist.push(QXFix(cnti))
            }
        }
    }
   return nlist
}

//surge script/quanx-rewrite - > quanx
function isQuanXRewrite(content) {
  cnt = content
  cnt0=[]
  var RuleK = ["host,", "-suffix,", "domain,", "-keyword,", "ip-cidr,", "ip-cidr6,",  "geoip,", "user-agent,", "ip6-cidr,","force-http", "ip-asn"];
  for (var i = 0; i< cnt.length; i++){
    if(cnt[i]){
      var cnti = cnt[i].trim()
      const RuleCheck = (item) => cnti.toLowerCase().indexOf(item) != -1;
      if (cnti.indexOf("pattern")!=-1 && cnti.indexOf("type")!=-1 || cnti.indexOf("http-r")!=-1) {
        cnti=SGMD2QX(cnti)[0]? SGMD2QX(cnti)[0]:""
        //console.log(cnti)
      }else if ((cnti.indexOf(" 302")!=-1 || cnti.indexOf(" 307")!=-1 || (/\s(_|-)\s(reject|REJECT)/.test(cnti)) || (/\sreject$/.test(cnti)) || (/\sreject-/.test(cnti))) && cnti.indexOf(" url ")==-1 && cnti.indexOf(" url-and-header ")==-1 ){
        cnti=SGMD2QX(cnti)[0]? SGMD2QX(cnti)[0]:""
        //console.log("sss",cnti)
      }else if(cnti.indexOf(" data=")!=-1){
        cnti = SGMD2QX("[Map Local]\n"+cnti)[0]? SGMD2QX("[Map Local]\n"+cnti)[0]:""
        //cnti=cnti.replace(/ /g, "").split("data=")[0] + " url " + "reject-dict"
      }else if(cnti.indexOf("URL-REGEX")!=-1 || cnti.indexOf(" header")!=-1 || cnti.replace(/ /g,"").indexOf("hostname=")!=-1){
        cnti=SGMD2QX(cnti)[0]? SGMD2QX(cnti)[0]:""
      }else if (cnti.indexOf(" url ")!=-1 && cnti.indexOf(" simple-response ")==-1 && cnti.indexOf(" url = ")==-1){ // 2023-03-09 å»æ‰ quanç±»å‹çš„ simple- response
        cnti = cnti.replace("^http","http") // å»æ‰ ^ ä»¥å»é‡
        cnti= cnti.split(" ")[1] == "url" ? cnti : ""
      } else if (cnti.indexOf(" url-and-header ")!=-1 ){ // url-and-header : ^https:xxx.com header-content url-and-header type-rule content
        cnti= cnti //cnti.split(" ")[2] == "url-and-header" ? cnti : ""
      } else {
        cnti=""
      }
      if (cnti!="" && cnti.trim()[0]!="[" && cnti.indexOf("RULE-SET")==-1 && !/cronexp\=|type\=cron/.test(cnti.replace(/ /g,"")) && !RuleK.some(RuleCheck)) {
        if (!(/\;$/.test(cnti))) { // æŸäº›ç‰¹æ®Šæƒ…å½¢ let url = xxx;
        cnt0.push(cnti) //  æ’é™¤å…¶å®ƒé¡¹ç›®åå†™å…¥
      }
      }
    }
  }
  //console.log(cnt0)
  //$notify("RWT","",cnt0)
  return cnt0
}



//æ ¹æ®èŠ‚ç‚¹åæ’åº(ä¸å«emoji éƒ¨åˆ†)
function QXSort(content, para) {
    var nlist = content;//.split("\n");
    if (para == 1) {
        return nlist.sort(ToTag)
    } else if (para == -1) {
        return nlist.sort(ToTagR)
    } else if(para == "x") {
        return shuffle(nlist)
    } else if(para == "0") {
        return nlist
    } else {
      return Sort_KWD (nlist,para) //å…³é”®è¯æ’åº
    }
}
//æ­£åº
function ToTag(elem1, elem2) {
    var tag1 = elem1.split("tag")[1].split("=")[1].trim()
    var tag2 = elem2.split("tag")[1].split("=")[1].trim()
    res = tag1 > tag2 ? 1 : -1
    return res
}
//é€†åº
function ToTagR(elem1, elem2) {
    var tag1 = elem1.split("tag")[1].split("=")[1].trim()
    var tag2 = elem2.split("tag")[1].split("=")[1].trim()
    res = tag1 > tag2 ? -1 : 1
    return res
}
// éšæœºæ´—ç‰Œæ’åº
function shuffle(arr) {
    var input = arr;
    for (var i = input.length - 1; i >= 0; i--) {
        var randomIndex = Math.floor(Math.random() * (i + 1));
        var itemAtIndex = input[randomIndex];
        input[randomIndex] = input[i];
        input[i] = itemAtIndex;
    }
    return input;
}

//æ ¹æ®æŒ‡å®šè§„åˆ™æ’åº
function Sort_KWD (cnt,strs) {
  strlist = strs.indexOf("<") != -1 ? strs.split("<"):strs.split(">")
  regj = strlist.map(item => RegExp(item, "i"))
  //dir = PsortX
  dir = strs.indexOf("<") != -1 ? -1:1
  var arr =  new Array(strlist.length+1);   //è¡¨æ ¼æœ‰nè¡Œ
  for(var i = 0;i < arr.length; i++){
    arr[i] = [];    //æ¯è¡Œæœ‰åˆ—
  }
  for (var i =0; i<cnt.length ; i++) {
    flag = 0
    for (var j=0; j<strlist.length ; j++){
      if(regj[j].test(cnt[i])) {
        arr[j].push(cnt[i])
        flag = 1
        break
      } 
    }
    if (flag != 1){
      arr[strlist.length].push(cnt[i]) } // ä¸åŒ¹é…é¡¹
  }
  //console.log(arr)
  arr = PsortX == -1? arr.map(item => item.sort(ToTagR)):arr
  arr = PsortX == 1? arr.map(item => item.sort(ToTag)):arr
  newarr = MixArr(arr,dir)
  return newarr
}

function MixArr(cnt,dir){
  var cnt0=[]
  for (i=0; i<cnt.length-1; i++){
    //console.log(dir)
    cnt0 = dir ==1? cnt0.concat(cnt[i]):cnt0.concat(cnt[cnt.length-2-i])
  }
  cnt0 = dir ==1? cnt0.concat(cnt[cnt.length-1].sort(ToTag)):(cnt[cnt.length-1].sort(ToTagR)).concat(cnt0)
  return cnt0
}


//æ­£åˆ™åˆ é™¤èŠ‚ç‚¹åå†…çš„å­—ç¬¦
function DelReg(content) {
    delreg = RegExp(delreg, "gmi")
    content=content.replace(/tag\s*\=\s*/,"tag=")
    cnt0 = content.split("tag=")[0]
    cnt1 = content.split("tag=")[1].split(",")[0]
    cnt2 = content.split("tag=")[1].split(",").length==1 ? "": content.split(cnt1)[1]
    cnt = cnt0 + "tag=" + cnt1.replace(delreg, "")+cnt2
    return cnt
}

//èŠ‚ç‚¹é‡å‘½å
function Rename(str) {
    var server = str;
    if (server.indexOf("tag=") != -1) {
        hd = server.split("tag=")[0] // é name éƒ¨åˆ†
        name = server.split("tag=")[1].split(",")[0].trim() // name éƒ¨åˆ†
        tail = server.split("tag=")[1].split(",").length <=1 ? "" : server.split("tag=")[1].split(name)[1]
        for (var i = 0; i < Prn.length; i++) {
            nname = Prn[i].split("@")[1] ? decodeURIComponent(Prn[i].split("@")[1]) : Prn[i].split("@")[1];
            oname = Prn[i].split("@")[0] ? decodeURIComponent(Prn[i].split("@")[0]) : Prn[i].split("@")[0];
            if (oname && nname) { //é‡å‘½å
                var rn = escapeRegExp(oname)
                name = name.replace(new RegExp(rn, "gm"), nname)
            } else if (oname && nname == "") {//å‰ç¼€
                var nemoji = emoji_del(name)
                if ((Pemoji == 1 || Pemoji == 2) && Prname ) { //åˆ¤æ–­æ˜¯å¦æœ‰é‡å¤ emojiï¼Œæœ‰åˆ™åˆ é™¤æ—§æœ‰
                    name = oname + nemoji //name.replace(name.split(" ")[0] + " ", name.split(" ")[0] + " " + oname)
                } else { name = oname + name.trim() }
            } else if (nname && oname == "") {//åç¼€
                name = name.trim() + nname
            } else if (oname && oname.indexOf("â˜ ï¸") != -1) { //åˆ é™¤ç‰¹å®šå­—ç¬¦ï¼Œå¤šå­—ç¬¦ç”¨.è¿æ¥
                hh = Dot2(oname.slice(0, oname.length - 2)).split(".") //ç¬¦å·.çš„ç‰¹æ®Šå¤„ç†
                for (j = 0; j < hh.length; j++) {
                    var nn = escapeRegExp(ToDot(hh[j]))
                    var del = new RegExp(nn, "gm");
                    name = name.replace(del, "")
                }
            } else if (oname == "" && nname == "") { //ä»…æœ‰@æ—¶ï¼Œåˆ é™¤@ç¬¦å·
                name = name.replace(/@/g, "")
            } else {
                name = name
            }
            nserver = hd + "tag=" + name + tail
        }
      return nserver
    } else {
      return server
    }
}

function RenameScript(servers, script) {
    $notify("ğŸ¤– å¯ç”¨è„šæœ¬è¿›è¡Œé‡å‘½å", "", script);
    try {
        const $ = Tools().rename;
        // extract server tags
        const nodes = Tools().getNodeInfo(servers);
        eval(script);
        const newNames = rename(nodes);
        // rename nodes
        return servers.map((s, i) => s.split("tag=")[0] + "tag=" + newNames[i]);
    } catch (err) {
        $notify("âŒ è„šæœ¬é‡å‘½åå‡ºç°é”™è¯¯", "", err);
        return servers;
    }

}

//åˆ é™¤ emoji 
function emoji_del(str) {
    return str.replace(/[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]/g, "").trim();//unescape(escape(str).replace(/\%uD.{3}/g, ''));
}

//ä¸ºèŠ‚ç‚¹åæ·»åŠ  emoji
function get_emoji(emojip, sname) {
   var Lmoji = { 
    "ğŸ³ï¸â€ğŸŒˆ": ["æµé‡", "å¥—é¤", "å‰©ä½™", "é‡ç½®", "åˆ°æœŸ" , "æ—¶é—´", "åº”æ€¥", "è¿‡æœŸ", "Bandwidth", "expire", "Traffic", "traffic"],
    "ğŸ‡´ğŸ‡²": ["é˜¿æ›¼", " OM "],
    "ğŸ‡¦ğŸ‡©": ["å®‰é“å°”","å®‰é“çˆ¾", "Andorra"],
    "ğŸ‡¦ğŸ‡´": ["å®‰å“¥æ‹‰"],
    "ğŸ‡¦ğŸ‡«": ["é˜¿å¯Œæ±—"],
    "ğŸ‡©ğŸ‡¿": ["é˜¿å°”åŠåˆ©äºš","é˜¿çˆ¾åŠåˆ©äº"],
    "ğŸ‡«ğŸ‡´": ["æ³•ç¾…ç¾¤å³¶","æ³•ç½—ç¾¤å²›"],
    "ğŸ‡§ğŸ‡²": ["ç™¾æ…•å¤§"],
    "ğŸ‡¦ğŸ‡½": ["å¥§è˜­ç¾¤å³¶", "å¥¥å…°ç¾¤å²›"],
    "ğŸ‡¦ğŸ‡¿": ["é˜¿å¡æ‹œç–†","Azerbaijan"],
    "ğŸ‡¦ğŸ‡¹": ["å¥¥åœ°åˆ©", "å¥§åœ°åˆ©", "Austria", "ç»´ä¹Ÿçº³"],
    "ğŸ‡¦ğŸ‡º": ["AU", "Australia", "Sydney", "æ¾³å¤§åˆ©äºš", "æ¾³æ´²", "å¢¨å°”æœ¬", "æ‚‰å°¼" ,"åœŸæ¾³", "äº¬æ¾³","å»£æ¾³","æ»¬æ¾³","æ²ªæ¾³","å¹¿æ¾³"],
    "ğŸ‡§ğŸ‡ª": ["BE", "æ¯”åˆ©æ™‚","æ¯”åˆ©æ—¶","Belgium"],
    "ğŸ‡§ğŸ‡¬": ["ä¿åŠ åˆ©äºš", "ä¿åŠ åˆ©äº","Bulgaria"],
    "ğŸ‡µğŸ‡°": ["å·´åŸºæ–¯å¦","Pakistan", "PAKISTAN"],
    "ğŸ‡§ğŸ‡­": ["å·´æ—","Bahrain"],
    "ğŸ‡µğŸ‡¾": ["å·´æ‹‰åœ­","Paraguay"],
    "ğŸ‡§ğŸ‡§": ["å·´å·´å¤šæ–¯"],
    "ğŸ‡¬ğŸ‡¶": ["èµ¤é“å‡ å†…äºš","èµ¤é“å¹¾å…§äº"],
    "ğŸ‡¹ğŸ‡±": ["ä¸œå¸æ±¶","æ±å¸æ±¶"],
    "ğŸ‡°ğŸ‡­": ["æŸ¬åŸ”å¯¨","Cambodia"],
    "ğŸ‡¿ğŸ‡¼": ["æ´¥å·´å¸ƒéŸ¦","æ´¥å·´å¸ƒéŸ‹"],
    "ğŸ‡ºğŸ‡¦": ["çƒå…‹è˜­","ä¹Œå…‹å…°","Ukraine"],
    "ğŸ‡ºğŸ‡¿": ["ä¹Œå…¹åˆ«å…‹æ–¯å¦", "çƒèŒ²åˆ¥å…‹æ–¯å¦","Uzbekistan"],
    "ğŸ‡­ğŸ‡·": ["å…‹ç½—åœ°äºš","HR","å…‹ç¾…åœ°äº", "Croatia"],
    "ğŸ‡¨ğŸ‡¦": ["CA", "Canada","CANADA", "CAN", "Waterloo", "åŠ æ‹¿å¤§", "è’™ç‰¹åˆ©å°”", "æ¸©å“¥å", "æ¥“è‘‰", "æ«å¶", "æ»‘é“å¢", "å¤šä¼¦å¤š"],
    "ğŸ‡¨ğŸ‡­": ["ç‘å£«", "è‹é»ä¸–", "Switzerland", "CH "],
    "ğŸ‡³ğŸ‡¬": ["å°¼æ—¥åˆ©äºš", "NG", "å°¼æ—¥åˆ©äº","æ‹‰å„æ–¯", "Nigeria"],
    "ğŸ‡¨ğŸ‡¿": ["Czechia", "æ·å…‹"],
    "ğŸ‡¸ğŸ‡°": ["æ–¯æ´›ä¼å…‹", "SK" , "Slovakia"],
    "ğŸ‡¸ğŸ‡®": ["æ–¯æ´›æ–‡å°¼äºš", "æ–¯æ´›æ–‡å°¼äº", "Slovenia"],
    "ğŸ‡¦ğŸ‡²": ["äºšç¾å°¼äºš", "äºç¾å°¼äº", "Armenia"],
    "ğŸ‡·ğŸ‡¸": ["RS ","RS_", "å¡å°”ç»´äºš", "å¡çˆ¾ç¶­äº", "Seville", "Sevilla"],
    "ğŸ‡²ğŸ‡©": ["æ‘©çˆ¾å¤šç“¦"," MD-","æ‘©å°”å¤šç“¦", "Moldova"," MD "],
    "ğŸ‡©ğŸ‡ª": ["DE ", "DE-", "DE_", "German", "GERMAN", "å¾·å›½", "å¾·åœ‹", "æ³•å…°å…‹ç¦","äº¬å¾·","æ»¬å¾·","å»£å¾·","æ²ªå¾·","å¹¿å¾·"],
    "ğŸ‡©ğŸ‡°": ["DK","DNK","ä¸¹éº¦","ä¸¹éº¥", "Denmark"],
    "ğŸ‡ªğŸ‡¸": ["ES", "è¥¿ç­ç‰™", "Spain"],
    "ğŸ‡ªğŸ‡º": ["EU", "æ¬§ç›Ÿ", "æ¬§ç½—å·´","æ¬§æ´²", "European"],
    "ğŸ‡«ğŸ‡®": ["Finland", "èŠ¬å…°","èŠ¬è˜­","èµ«å°”è¾›åŸº"],
    "ğŸ‡«ğŸ‡·": ["FR", "France", "æ³•å›½", "æ³•åœ‹", "å·´é»"],
    "ğŸ‡·ğŸ‡ª": ["ç•™å°¼æ±ª", "ç•™å°¼æ—º", "RÃ©union", "Reunion"],
    "ğŸ‡¨ğŸ‡¼": ["åº“æ‹‰ç´¢", "åº«æ‹‰ç´¢", "CuraÃ§ao"],
    "ğŸ‡¬ğŸ‡§": ["UK", "GB ", "England", "United Kingdom", "è‹±å›½", "ä¼¦æ•¦", "è‹±", "Britain"],
    "ğŸ‡²ğŸ‡´": ["MO", "Macao","Macau", "MAC", "æ¾³é—¨", "æ¾³é–€", "CTM"],
    "ğŸ‡°ğŸ‡¿": ["å“ˆè¨å…‹æ–¯å¦", "å“ˆè–©å…‹æ–¯å¦", "Kazakhstan"],
    "ğŸ‡±ğŸ‡¦": ["è€æŒ","è€æŒ", "Laos"],
    "ğŸ‡­ğŸ‡º": ["åŒˆç‰™åˆ©", "Hungary"],
    "ğŸ‡­ğŸ‡³": ["æ´ªéƒ½æ‹‰æ–¯"],
    "ğŸ‡±ğŸ‡¹": ["ç«‹é™¶å®›", "Lithuania"],
    "ğŸ‡±ğŸ‡°": ["æ–¯é‡Œå…°å¡", "æ–¯é‡Œè˜­å¡", "Sri Lanka"],
    "ğŸ‡§ğŸ‡¾": ["BY","ç™½ä¿„ç½—æ–¯","ç™½ä¿„ç¾…æ–¯", "White Russia", "Republic of Belarus", "Belarus"],
    "ğŸ‡·ğŸ‡º": ["RU ","RU-", "RU_", "RUS", "Russia", "ä¿„ç½—æ–¯", "æ¯›å­", "ä¿„å›½", "ä¿„ç¾…æ–¯", "ä¼¯åŠ›", "è«æ–¯ç§‘", "åœ£å½¼å¾—å ¡", "è¥¿ä¼¯åˆ©äºš", "æ–°è¥¿ä¼¯åˆ©äºš", "äº¬ä¿„", "æ­ä¿„","å»£ä¿„","æ»¬ä¿„","å¹¿ä¿„","æ²ªä¿„"],
    "ğŸ‡¸ğŸ‡¬": ["SG", "Singapore","SINGAPORE", "æ–°åŠ å¡", "ç‹®åŸ", "ç…åŸ", "æ²ªæ–°", "äº¬æ–°", "æ³‰æ–°", "ç©—æ–°", "æ·±æ–°", "æ­æ–°", "å¹¿æ–°","å»£æ–°","æ»¬æ–°"],
    "ğŸ‡ºğŸ‡¸": ["US", "USA", "America", "United States", "ç¾å›½", "ç¾", "äº¬ç¾", "æ³¢ç‰¹å…°", "è¾¾æ‹‰æ–¯", "ä¿„å‹’å†ˆ", "å‡¤å‡°åŸ", "è´¹åˆ©è’™", "ç¡…è°·", "çŸ½è°·", "æ‹‰æ–¯ç»´åŠ æ–¯", "æ´›æ‰çŸ¶", "åœ£ä½•å¡", "åœ£è·è¥¿", "åœ£å…‹æ‹‰æ‹‰", "è¥¿é›…å›¾", "èŠåŠ å“¥", "æ²ªç¾", "å“¥ä¼¦å¸ƒ", "çº½çº¦"],
    "ğŸ‡¹ğŸ‡¼": ["TW", "Taiwan","TAIWAN", "å°æ¹¾", "å°åŒ—", "å°ä¸­", "æ–°åŒ—", "å½°åŒ–", "CHT", "å°", "HINET"],
    "ğŸ‡®ğŸ‡©": ["ID ", "IDN ", "Indonesia", "å°å°¼", "å°åº¦å°¼è¥¿äºš", "é›…åŠ è¾¾"],
    "ğŸ‡®ğŸ‡ª": ["Ireland", "IRELAND", "IE ", "çˆ±å°”å…°", "æ„›çˆ¾è˜­", "éƒ½æŸæ—"],
    "ğŸ‡®ğŸ‡±": ["Israel", "ä»¥è‰²åˆ—"],
    "ğŸ‡®ğŸ‡³": ["India", "IND", "INDIA","å°åº¦", "å­Ÿä¹°", "Mumbai","IN "],
    "ğŸ‡®ğŸ‡¸": ["IS","ISL", "å†°å²›","å†°å³¶", "Iceland"],
    "ğŸ‡°ğŸ‡µ": ["KP", "æœé²œ", "North Korea","æœé®®"],
    "ğŸ‡°ğŸ‡·": ["KR", "Korea", "KOR", "éŸ©å›½", "é¦–å°”", "éŸ©", "éŸ“","æ˜¥å·"],
    "ğŸ‡¬ğŸ‡­": ["åŠ çº³", "Ghana", "è¿¦ç´"],
    "ğŸ‡±ğŸ‡º": ["å¢æ£®å ¡", "ç›§æ£®å ¡", "LU ", "Luxembourg"],
    "ğŸ‡±ğŸ‡»": ["Latvia", "Latvija", "æ‹‰è„±ç»´äºš"],
    "ğŸ‡§ğŸ‡©": ["å­ŸåŠ æ‹‰", "Bengal"],
    "ğŸ‡²ğŸ‡½ï¸": [" MEX", "MX", "å¢¨è¥¿å“¥", "Mexico", "MEXICO"],
    "ğŸ‡²ğŸ‡¾": [" MY", "Malaysia","MALAYSIA", "é©¬æ¥è¥¿äºš", "é©¬æ¥", "é¦¬ä¾†", "å¤§é©¬", "å¤§é¦¬", "é¦¬ä¾†è¥¿äº", "å‰éš†å¡"],
    "ğŸ‡²ğŸ‡²": ["ç¼…ç”¸","ç·¬ç”¸"],
    "ğŸ‡³ğŸ‡®": ["å°¼åŠ æ‹‰ç“œ"],
    "ğŸ‡³ğŸ‡±": [" NL", "Netherlands", "è·å…°", "è·è˜­", "å°¼å¾·è˜­", "é˜¿å§†æ–¯ç‰¹ä¸¹"],
    "ğŸ‡µğŸ‡­": [" PH", "Philippines", "è²å¾‹å®¾", "è²å¾‹è³“"],
    "ğŸ‡·ğŸ‡´": [" RO ", "ç½—é©¬å°¼äºš", "Rumania", "ç¾…é¦¬å°¼äº"],
    "ğŸ‡¸ğŸ‡¦": ["æ²™ç‰¹", "åˆ©é›…å¾—", "Saudi Arabia", "Saudi"],
    "ğŸ‡¸ğŸ‡ª": ["SE", "Sweden","ç‘å…¸"],
    "ğŸ‡¹ğŸ‡­": [" TH", "Thailand", "æ³°å›½", "æ³°åœ‹", "æ›¼è°·"],
    "ğŸ‡¹ğŸ‡·": ["TR ","TR-", "TR_", "TUR", "Turkey", "åœŸè€³å…¶", "ä¼Šæ–¯å¦å¸ƒå°”"],
    "ğŸ‡»ğŸ‡³": ["VN", "è¶Šå—", "èƒ¡å¿—æ˜å¸‚", "Vietnam"],
    "ğŸ‡®ğŸ‡¹": ["Italy", " IT ", "Nachash", "æ„å¤§åˆ©", "ç±³å…°", "ç¾©å¤§åˆ©"],
    "ğŸ‡¿ğŸ‡¦": ["South Africa", "å—é", "Johannesburg"],
    "ğŸ‡¦ğŸ‡ª": ["United Arab Emirates", "é˜¿è”é…‹","AE ", "è¿ªæ‹œ", "é˜¿è¯é…‹", "Dubai"],
    "ğŸ‡§ğŸ‡·": ["BR", "Brazil", "å·´è¥¿", "åœ£ä¿ç½—"],
    "ğŸ‡¯ğŸ‡µ": ["JP", "Japan","JAPAN", "æ—¥æœ¬", "ä¸œäº¬", "å¤§é˜ª", "åŸ¼ç‰", "äº¬æ—¥", "è‹æ—¥", "æ²ªæ—¥","ä¸Šæ—¥", "ç©—æ—¥", "å·æ—¥", "ä¸­æ—¥", "æ³‰æ—¥", "æ­æ—¥", "æ·±æ—¥", "è¾½æ—¥", "å¹¿æ—¥", "Tokyo"],
    "ğŸ‡¦ğŸ‡·": ["AR ", "Argentina", "é˜¿æ ¹å»·","AR-"],
    "ğŸ‡³ğŸ‡´": ["Norway", "æŒªå¨", "NO"],
    "ğŸ‡µğŸ‡±": [" PL", "POL", "æ³¢å…°","æ³¢è˜­", "Poland"],
    "ğŸ‡¨ğŸ‡±": ["æ™ºåˆ©","Chile","CHILE"],
    "ğŸ‡³ğŸ‡¿": ["æ–°è¥¿è˜­","æ–°è¥¿å…°", "New Zealand"],
    "ğŸ‡¬ğŸ‡·": ["å¸Œè…Š","å¸Œè‡˜", "Greece"],
    "ğŸ‡ªğŸ‡¬": ["åŸƒåŠ", "Egypt"],
    "ğŸ‡®ğŸ‡²": ["é©¬æ©å²›","é¦¬æ©å³¶", "Isle of Man", "Mannin"],
    "ğŸ‡µğŸ‡¹": ["è‘¡è„ç‰™", "Portugal"],
    "ğŸ‡²ğŸ‡³": ["è’™å¤", "Mongolia"],
    "ğŸ‡µğŸ‡ª": ["ç§˜é²","ç¥•é­¯", "Peru"],
    "ğŸ‡¨ğŸ‡´": ["å“¥ä¼¦æ¯”äºš", "å“¥å€«æ¯”äº", "Colombia"],
    "ğŸ‡ªğŸ‡ª": ["çˆ±æ²™å°¼äºš", "æ„›æ²™å°¼äº", "Estonia"],
    "ğŸ‡±ğŸ‡¾": ["åˆ©æ¯”äºš","åˆ©æ¯”äº", "Libya"],
    "ğŸ‡²ğŸ‡°": ["é©¬å…¶é¡¿","é¦¬å…¶é “", "Macedonia"],
    "ğŸ‡²ğŸ‡¹": ["é©¬è€³ä»–", "é¦¬å…¶ä»–", "Malta"],
    "ğŸ‡»ğŸ‡ª": ["å§”å†…ç‘æ‹‰", "Venezuela"],
    "ğŸ‡§ğŸ‡¦": ["æ³¢é»‘å…±å’Œå›½","æ³¢é»‘", "Bosnia and Herzegovina"],
    "ğŸ‡¬ğŸ‡ª": ["æ ¼é­¯å‰äº","æ ¼é²å‰äºš", "Georgia"],
    "ğŸ‡¦ğŸ‡±": ["é˜¿çˆ¾å·´å°¼äº","é˜¿å°”å·´å°¼äºš", "Albania"],
    "ğŸ‡¨ğŸ‡¾": ["CY","å¡æµ¦è·¯æ–¯", "Cyprus"],
    "ğŸ‡¨ğŸ‡·": ["å“¥æ–¯è¾¾é»åŠ ", "å“¥æ–¯é”å°¼åŠ ", "Costa Rica"],
    "ğŸ‡¹ğŸ‡³": ["çªå°¼æ–¯", "Tunisia"],
    "ğŸ‡»ğŸ‡¦": ["æ¢µè’‚å†ˆ","æ¢µè’‚å²¡"],
    "ğŸ‡·ğŸ‡¼": ["å¢æ—ºè¾¾","ç›§æ—ºé”"],
    "ğŸ‡µğŸ‡¦": ["å·´æ‹¿é©¬","å·´æ‹¿é¦¬", "Panama"],
    "ğŸ‡®ğŸ‡·": ["ä¼Šæœ—", "Iran"],
    "ğŸ‡¯ğŸ‡´": ["çº¦æ—¦", "ç´„æ—¦", "Jordan"],
    "ğŸ‡ºğŸ‡¾": ["ä¹Œæ‹‰åœ­" , "çƒæ‹‰åœ­", "Uruguay"],
    "ğŸ‡°ğŸ‡ª": ["è‚¯å°¼äºš", "è‚¯å°¼äº", "Kenya"],
    "ğŸ‡°ğŸ‡¬": ["å‰å°”å‰æ–¯å¦","å‰å°”å‰æ–¯æ–¯å¦", "Kyrghyzstan"],
    "ğŸ‡³ğŸ‡µ": ["å°¼æ³Šå°”", "å°¼æ³Šçˆ¾", "Nepal"],
    "ğŸ‡½ğŸ‡°": ["ç§‘ç´¢æ²ƒ", "Kosovo"],
    "ğŸ‡²ğŸ‡¦": ["æ‘©æ´›å“¥", "Morocco"],
    "ğŸ‡ªğŸ‡¨": ["å„ç“œå¤šå°”", "å„ç“œå¤šçˆ¾", "EC", "Ecuador"],
    "ğŸ‡²ğŸ‡º": ["æ¯›é‡Œæ±‚æ–¯", "Mauritius"],
    "ğŸ‡µğŸ‡·": ["æ³¢å¤šé»å„", "PR ","PR-", "Puerto Rico"],
    "ğŸ‡¬ğŸ‡¹": ["å±åœ°é©¬æ‹‰", "å±åœ°é¦¬æ‹‰", " GT "],
    "ğŸ‡­ğŸ‡°": ["HK", "Hongkong", "Hong Kong", "HongKong", "HONG KONG","é¦™æ¸¯", "æ·±æ¸¯", "æ²ªæ¸¯", "å‘¼æ¸¯", "HKT", "HKBN", "HGC", "WTT", "CMI", "ç©—æ¸¯", "äº¬æ¸¯", "æ¸¯"],
    "ğŸ‡¨ğŸ‡³": ["CN", "China", "å›å›½", "ä¸­å›½","ä¸­åœ‹", "æ±Ÿè‹", "åŒ—äº¬", "ä¸Šæµ·", "å¹¿å·", "æ·±åœ³", "æ­å·", "å¾å·", "é’å²›", "å®æ³¢", "é•‡æ±Ÿ", "back"],
    "ğŸ‡¨ğŸ‡º": ["å¤å·´"],
    "ğŸ‡¸ğŸ‡²": ["åœ£é©¬åŠ›è¯º","è–é¦¬åˆ©è«¾"],
    "ğŸ‡°ğŸ‡¾": ["å¼€æ›¼ç¾¤å²›","é–‹æ›¼ç¾¤å³¶"],
    "ğŸ‡«ğŸ‡¯": ["æ–æµ","æ–æ¿Ÿ"],
    "ğŸ‡¬ğŸ‡±": ["æ ¼é™µå…°","æ ¼é™µè˜­"],
    "ğŸ‡¬ğŸ‡®": ["ç›´å¸ƒç½—é™€","ç›´å¸ƒç¾…é™€"],
    "ğŸ‡²ğŸ‡ª": ["é»‘å±±"],
    "ğŸ‡±ğŸ‡®": ["åˆ—æ”¯æ•¦å£«ç™»"],
    "ğŸ‡¬ğŸ‡º": ["å…³å²›","é—œå³¶"],
    "ğŸ‡¦ğŸ‡¶": ["å—æ","å—æ¥µ"],
    "ğŸ‡§ğŸ‡¹": ["ä¸ä¸¹"], 
    "ğŸ‡²ğŸ‡»": ["é©¬å°”ä»£å¤«", "é¦¬çˆ¾ä»£å¤«"],
    "ğŸ‡®ğŸ‡¶": ["ä¼Šæ‹‰å…‹"],
    "ğŸ‡¸ğŸ‡¨": ["å¡èˆŒå°”","å¡èˆŒçˆ¾"],
    "ğŸ‡¶ğŸ‡¦": ["å¡å¡”å°”", "å¡å¡”çˆ¾", " QA "],
    "ğŸ‡¸ğŸ‡¾": ["å™åˆ©äºš", "æ•˜åˆ©äº", " SY "],
    "ğŸ‡±ğŸ‡§": ["é»å·´å«©","LB", "Lebanon"],
    "ğŸ‡§ğŸ‡³": ["æ–‡è±","æ±¶èŠ", "BRN","Negara Brunei Darussalam"],
    "ğŸ‡¨ğŸ‡»": ["ä½›å¾—è§’"],
    "ğŸ‡¸ğŸ‡·": ["è‹é‡Œå—","è˜‡é‡Œå—"],
    "ğŸ‡²ğŸ‡¨": ["æ‘©çº³å“¥","æ‘©ç´å“¥"],
    "ğŸ‡¯ğŸ‡²": ["ç‰™ä¹°åŠ ","ç‰™è²·åŠ  "],
    "ğŸŒ": ["äºšæ´²","Asia"],
    "ğŸ‡¹ğŸ‡¬": ["å¤šå“¥"],
    "ğŸ‡µğŸ‡¸": ["å·´å‹’æ–¯å¦"],
    "ğŸ‡¬ğŸ‡«": ["æ³•å±¬åœ­äºé‚£","æ³•å±åœ­äºšé‚£"],
    "ğŸ‡¹ğŸ‡¹": ["ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥","ç‰¹ç«‹å°¼é”å’Œå¤šå·´å“¥"]
  }
    str1 = JSON.stringify(Lmoji)
    aa = JSON.parse(str1)
    bb = JSON.parse(str1.replace(/ğŸ‡¹ğŸ‡¼/g, " ğŸ‡¨ğŸ‡³"))
    var cnt = emojip ==1? aa:bb;
    var flag = 0;
    for (var key in cnt) {
        dd = cnt[key]
        for (i in dd) {
            if (sname.indexOf(dd[i]) != -1) {
                flag = 1;
                nname = key + " " + sname.replace(/[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]/g, "").trim(); // use regex to remove the original flag
                return [nname,key]
            }
        }
    }
    if (flag == 0) { return ["ğŸ´â€â˜ ï¸ " + sname.replace(/[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]/g, "").trim(), "ğŸ´â€â˜ ï¸"] }
}

//emoji å¤„ç†
function emoji_handle(servers, Pemoji) {
    var nlist = []
    var ser0 = servers

    for (var i = 0; i < ser0.length; i++) {
        if (ser0[i].indexOf("tag=") != -1) {
            var oname = ser0[i].split("tag=")[1].trim();
            var hd = ser0[i].split("tag=")[0];
            var nname = oname;//emoji_del(oname);
            // Code: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2, Emoji: https://emojipedia.org/flags/
            if (Pemoji == 1) {
                var nname = get_emoji(1, nname)[0]
            } else if (Pemoji == 2) {
                var nname = get_emoji(2, nname)[0]
            } else if (Pemoji == -1) {
                nname = emoji_del(oname);
            }
            var nserver = hd + "tag=" + nname.replace("  ", " ").trim()
            nlist.push(nserver)
        }
    }
    return nlist
}

//Surge2QX è½¬æ¢ä¸»å‡½æ•°
function Surge2QX(conf) {
  var QXlist = conf.split("\n").map(isSurge).filter(Boolean)
  var Nlist = []
  var node=""
  for (var i = 0; i < QXlist.length; i++) {
    var cnt = QXlist[i];
    if (cnt.split("=")[1].split(",")[0].indexOf("trojan") != -1) {
      node = Strojan2QX(cnt)//surge 3çš„trojan
    } else if (cnt.split("=")[1].split(",")[0].indexOf("http") != -1) {
      node = Shttp2QX(cnt) //surge 3çš„http
    } else if (cnt.split("=")[1].split(",")[0].indexOf("vmess") != -1) {
      node = SVmess2QX(cnt) //surge 3çš„Vmess
    } else if (cnt.split("=")[1].split(",")[0].indexOf("ss") != -1) {
      node = SSS2QX(cnt) //surge 3çš„SS
    } else if (cnt.split("=")[1].split(",")[0].indexOf("socks5") != -1) {
      node = SS52QX(cnt) //surge 3çš„Socks5
    } else if (cnt.split("=")[1].split(",")[0].indexOf("custom") != -1) {
      node = SCT2QX(cnt) //surge2å†™æ³•
    }
    node = Pudp0 != 0 ? XUDP(node,Pudp0) : node
    node = Ptfo0 != 0 ? XTFO(node,Ptfo0) : node
    if (cnt.indexOf("test-url") !=-1) {
      var checkurl = ", server_check_url" + cnt.split("test-url")[1].split(",")[0]
      node = node.replace(/\,(\s)*tag/, checkurl + ", tag")
    }
    Nlist.push(node)
  }
  return (Nlist)
}


// surge2 ä¸­çš„ SS ç±»å‹å†™æ³•(custom)
//ğŸ‡·ğŸ‡º ä¿„ç½—æ–¯ GIA = custom, ip, 152, aes-128-gcm, password123, https://xxx/download/SSEncrypt.module, obfs=tls, obfs-host=xxx.windows.com, udp-relay=true
function SCT2QX(content) {
    var cnt = content;
    var tag = "tag=" + cnt.split("=")[0].trim();
    var ipport = cnt.split(",")[1].trim() + ":" + cnt.split(",")[2].trim();
    var pmtd = "method=" + cnt.split(",")[3].trim();
    var pwd = "password=" + cnt.split(",")[4].trim();
    if (cnt.indexOf("obfs") != -1) {
        pobfs = "obfs=" + cnt.replace(/obfs-host/, "").split("obfs")[1].split(",")[0].split("=")[1]
    } else { pobfs = "" }
    var phost = cnt.indexOf("obfs-host") != -1 ? "obfs-host" + cnt.split("obfs-host")[1].split(",")[0].trim() : "";
    if (phost != "") {
        pobfs = pobfs + ", " + phost
    }
    var ptfo = paraCheck(cnt, "tfo") == "true" ? "fast-open=true" : "fast-open=false";
    var pudp = paraCheck(cnt, "udp-relay") == "true" ? "udp-relay=true" : "udp-relay=false";
    var nserver = pobfs != "" ? "shadowsocks= " + [ipport, pmtd, pwd, pobfs, ptfo, pudp, tag].join(", ") : "shadowsocks= " + [ipport, pmtd, pwd, ptfo, pudp, tag].join(", ");
    return nserver
}


// surge3 ä¸­çš„ SS ç±»å‹
function SSS2QX(content) {
    var cnt = content;
    var tag = "tag=" + cnt.split("=")[0].trim();
    var ipport = cnt.split(",")[1].trim() + ":" + cnt.split(",")[2].trim();
    var pmtd = "method=" + cnt.split("encrypt-method")[1].split(",")[0].split("=")[1];
    var pwd = "password=" + cnt.split("password")[1].split(",")[0].split("=")[1];
    if (cnt.indexOf("obfs") != -1) {
        pobfs = "obfs=" + cnt.replace(/obfs-host/, "").split("obfs")[1].split(",")[0].split("=")[1]
    } else { pobfs = "" }
    var phost = cnt.indexOf("obfs-host") != -1 ? "obfs-host" + cnt.split("obfs-host")[1].split(",")[0].trim() : "";
    if (phost != "") {
        pobfs = pobfs + ", " + phost
    }
    var ptfo = paraCheck(cnt, "tfo") == "true" ? "fast-open=true" : "fast-open=false";
    var pudp = paraCheck(cnt, "udp-relay") == "true" ? "udp-relay=true" : "udp-relay=false";
    var nserver = pobfs != "" ? "shadowsocks= " + [ipport, pmtd, pwd, pobfs, ptfo, pudp, tag].join(", ") : "shadowsocks= " + [ipport, pmtd, pwd, ptfo, pudp, tag].join(", ");
    return nserver
}


// surge ä¸­çš„ Vmess ç±»å‹
function SVmess2QX(content) {
    var cnt = content;
    var tag = "tag=" + cnt.split("=")[0].trim();
    var ipport = cnt.split(",")[1].trim() + ":" + cnt.split(",")[2].trim();
    var puname = cnt.indexOf("username") != -1 ? "password=" + cnt.split("username")[1].split(",")[0].split("=")[1].trim() : "";
    var pmtd = "method=aes-128-gcm";
    var ptls13 = paraCheck(cnt, "tls13") == "true" ? "tls13=true" : "tls13=false";
    var pverify = cnt.replace(/ /g,"").indexOf("skip-cert-verify=false") != -1 ? "tls-verification=true" : "tls-verification=false";
    pvefify = Pcert0 == 1? "tls-verification=true" : pverify ;
    if (paraCheck(cnt.replace(/tls13/, ""), "tls") == "true" && paraCheck(cnt.replace(/ws-header/, ""), "ws") == "true") {
        pobfs = "obfs=wss" + ", " + ptls13 + ", " + pverify
    } else if (paraCheck(cnt.replace(/ws-header/, ""), "ws") == "true") {
        pobfs = "obfs=ws"
    } else if (paraCheck(cnt.replace(/tls13/, ""), "tls") != "false") {
        pobfs = "obfs=over-tls" + ", " + ptls13 + ", " + pverify
    } else if (paraCheck(cnt.replace(/ws-header/, ""), "ws") == "false") {
        pobfs = ""
    }
    var puri = paraCheck(cnt, "ws-path") != "false" ? "obfs-uri=" + cnt.split("ws-path")[1].split(",")[0].split("=")[1].trim() : "obfs-uri=/"
    var phost = cnt.indexOf("ws-headers") != -1 ? "obfs-host=" + cnt.split("ws-headers")[1].split(",")[0].split("=")[1].split(":")[1].trim() : "";
    if (pobfs.indexOf("ws" || "wss") != -1) {
        if (phost != "") {
            pobfs = pobfs + ", " + puri + ", " + phost
        } else { pobfs = pobfs + ", " + puri }
    }
    var ptfo = paraCheck(cnt, "tfo") == "true" ? "fast-open=true" : "fast-open=false";
    var nserver = pobfs != "" ? "vmess= " + [ipport, puname, pmtd, pobfs, ptfo, tag].join(", ") : "vmess= " + [ipport, puname, pmtd, ptfo, tag].join(", ");
    return nserver
}

// ç”¨äºè¿‡æ»¤éèŠ‚ç‚¹éƒ¨åˆ†ï¼ˆæ¯”å¦‚æ•´ä»½é…ç½®ä¸­å…¶å®ƒå†…å®¹ï¼‰
function isSurge(content) {
  if (content.indexOf("=") != -1) {
    cnt = content.split("=")[1].split(",")[0].trim()
    if (cnt == "http" || cnt == "ss" || cnt == "trojan" || cnt == "vmess" || cnt == "custom" || cnt == "https" || cnt == "socks5"|| cnt == "socks5-tls") {
        return content
    }
  }
}
// ç”¨äºå‚æ•°æ£€æŸ¥
function paraCheck(content, para) {
  content=content.replace(/ /g,"")
  if (content.indexOf(para+"=") == -1) {
    return "false"
  } else {
      //console.log(para)
    return content.split(para+"=")[1].split(",")[0].trim()
  }
}
//surgeä¸­ trojan ç±»å‹è½¬æ¢
function Strojan2QX(content) {
  var cnt = content;
  var tag = "tag=" + cnt.split("=")[0].trim();
  var ipport = cnt.split(",")[1].trim() + ":" + cnt.split(",")[2].trim();
  var pwd = "password=" + cnt.split("password")[1].split(",")[0].split("=")[1].trim();
  var ptls = "over-tls=true";
  var ptfo = paraCheck(cnt, "tfo") == "true" ? "fast-open=true" : "fast-open=false";
  var pverify = cnt.replace(/ /g,"").indexOf("skip-cert-verify=false") != -1 ? "tls-verification=true" : "tls-verification=false";
  var phost = cnt.indexOf("sni")!=-1? "tls-host="+cnt.split("sni")[1].split(",")[0].split("=")[1]:""
  pvefify = Pcert0 == 1? "tls-verification=true" : pverify ;
  var ptls13 = paraCheck(cnt, "tls13") == "true" ? "tls13=true" : "tls13=false";
  var nserver = "trojan= " + [ipport, pwd, ptls, ptfo, ptls13, phost,pverify, tag].filter(Boolean).join(", ");
  return nserver
}
// surge ä¸­çš„ http ç±»å‹
function Shttp2QX(content) {
  var cnt = content;
  var tag = "tag=" + cnt.split("=")[0].trim();
  var ipport = cnt.split(",")[1].trim() + ":" + cnt.split(",")[2].trim();
  var puname = cnt.indexOf("username") != -1 ? "username=" + cnt.split("username")[1].split(",")[0].split("=")[1].trim() : "";
  var pwd = cnt.indexOf("password") != -1 ? "password=" + cnt.split("password")[1].split(",")[0].split("=")[1].trim() : "";
  var ptls = cnt.split("=")[1].split(",")[0].trim() == "https" ? "over-tls=true" : "over-tls=false";
  var ptfo = paraCheck(cnt, "tfo") == "true" ? "fast-open=true" : "fast-open=false";
  if (ptls == "over-tls=true") {
    var pverify = cnt.replace(/ /g,"").indexOf("skip-cert-verify=false") != -1 ? "tls-verification=true" : "tls-verification=false";
    pvefify = Pcert0 == 1? "tls-verification=true" : pverify ;
    var ptls13 = paraCheck(cnt, "tls13") == "true" ? "tls13=true" : "tls13=false";
    ptls = ptls + ", " + pverify + ", " + ptls13
  }
  var nserver = puname != "" ? "http= " + [ipport, puname, pwd, ptls, ptfo, tag].join(", ") : "http= " + [ipport, ptls, ptfo, tag].join(", ");
  return nserver
}

// surge ä¸­çš„ socks5 ç±»å‹
function SS52QX(content) {
  var cnt = content;
  var tag = "tag=" + cnt.split("=")[0].trim();
  var ipport = cnt.split(",")[1].trim() + ":" + cnt.split(",")[2].trim();
  var puname = cnt.indexOf("username") != -1 ? "username=" + cnt.split("username")[1].split(",")[0].split("=")[1].trim() : "";
  var pwd = cnt.indexOf("password") != -1 ? "password=" + cnt.split("password")[1].split(",")[0].split("=")[1].trim() : "";
  var ptls = cnt.split("=")[1].split(",")[0].trim() == "socks5-tls" ? "over-tls=true" : "over-tls=false";
  var ptfo = paraCheck(cnt, "tfo") == "true" ? "fast-open=true" : "fast-open=false";
  if (ptls == "over-tls=true") {
    var pverify = cnt.replace(/ /g,"").indexOf("skip-cert-verify=false") != -1 ? "tls-verification=true" : "tls-verification=false";
    pvefify = Pcert0 == 1? "tls-verification=true" : pverify ;
    var ptls13 = paraCheck(cnt, "tls13") == "true" ? "tls13=true" : "tls13=false";
    ptls = ptls + ", " + pverify + ", " + ptls13
  }
  var nserver = puname != "" ? "socks5= " + [ipport, puname, pwd, ptls, ptfo, tag].join(", ") : "socks5= " + [ipport, ptls, ptfo, tag].join(", ");
  return nserver
}

function Loon2QX(cnt) {
  var type = cnt.split("=")[1].split(",")[0].trim()
  var node = ""
  if (type == "Shadowsocks") { //ss ç±»å‹
      node = LoonSS2QX(cnt)
  } else if (type == "ShadowsocksR") { //ssr ç±»å‹
      node = LoonSSR2QX(cnt)
  } else if (type == "VLESS") { // vless ç±»å‹
    node = LoonVL2QX(cnt)
  }
  return node
}
//Loon çš„ ss éƒ¨åˆ†
function LoonSS2QX(cnt) {
  var node = "shadowsocks="
  var ip = [cnt.split(",")[1].trim(), cnt.split(",")[2].trim()].join(":")
  var mtd = "method=" + cnt.split(",")[3].trim()
  var pwd = "password=" + cnt.split(",")[4].trim().split("\"")[1]
  var obfs = cnt.split(",").length == 7 ? ", " + ["obfs=" + cnt.split(",")[5].trim(), "obfs-host=" + cnt.split(",")[6].trim()].join(",") : ""
  var tag = ", tag=" + cnt.split("=")[0].trim()
  node = node + [ip, mtd, pwd].join(", ") + obfs + tag
  return node
}

//Loon çš„ ssr éƒ¨åˆ†
//# SSR æ ¼å¼ï¼šåç§°=åè®®ç±»å‹,åœ°å€,ç«¯å£,åŠ å¯†æ–¹å¼,å¯†ç ,åè®®ç±»å‹,{åè®®å‚æ•°},æ··æ·†ç±»å‹,{æ··æ·†å‚æ•°}
//3 = ShadowsocksR, 1.2.3.4, 443, aes-256-cfb,"password",auth_aes128_md5,{},tls1.2_ticket_auth,{}
function LoonSSR2QX(cnt) {
  var node = "shadowsocks="
  var ip = [cnt.split(",")[1].trim(), cnt.split(",")[2].trim()].join(":")
  var mtd = "method=" + cnt.split(",")[3].trim()
  var pwd = "password=" + cnt.split(",")[4].trim().split("\"")[1]
  var ssrp = "ssr-protocol=" + cnt.split(",")[5].trim()
  var ssrpara = "ssr-protocol-param=" + cnt.split(",")[6].replace(/\{|\}/g, "").trim()
  var obfs = "obfs=" + cnt.split(",")[7].trim()
  var obfshost = "obfs-host=" + cnt.split(",")[8].replace(/\{|\}/g, "").trim()
  var tag = ", tag=" + cnt.split("=")[0].trim()
  node = node + [ip, mtd, pwd, ssrp, ssrpara, obfs, obfshost].join(", ") + tag
  return node
}

//Loon çš„ VLESS éƒ¨åˆ†
//vls = VLESS,1.1.1.1,443,"b0dd64e4-0fbd-4038-9139-d1f32a68a0dc",transport=ws,path=patha,host=host.com,udp=true,over-tls=true,tls-name=sni.co
function LoonVL2QX(cnt) {
  var tag = ", tag=" + cnt.split("=")[0].trim()
  cnt=cnt.replace(" ","") //å»æ‰ç©ºæ ¼ ç®€åŒ– 
  var node = "vless="
  var ip = [cnt.split(",")[1].trim(), cnt.split(",")[2].trim()].join(":")
  var mtd = "method=none"
  var pwd = "password=" + cnt.split(",")[3].trim().split("\"")[1]
  if (cnt.indexOf("transport=tcp")!=-1) {
    obfs= cnt.indexOf("over-tls=true")=="-1"? "":"obfs=over-tls"
  } else if (cnt.indexOf("transport=http")!=-1) {
    obfs="obfs=http"
  } else if (cnt.indexOf("transport=ws")!=-1) {
    obfs= cnt.indexOf("over-tls=true")=="-1"? "obfs=ws":"obfs=wss"
  }
  vpath = cnt.indexOf("path=")==-1? "":"obfs-uri="+cnt.split("path=")[1].split(",")[0]
  if (cnt.indexOf("host=")!=-1) {
    obfshost="obfs-host="+cnt.split("host=")[1].split(",")[0]
  }  else if (cnt.indexOf("tls-name=")!=-1) {
    obfshost="obfs-host="+cnt.split("tls-name=")[1].split(",")[0]
  }
  node = node + [ip, mtd, pwd, obfs, obfshost, vpath].join(", ") + tag
  return node
}

////////////////////

function YAMLFix(cnt){
  cnt = cnt.replace(/\[/g,"yaml@bug1").replace(/\\r/g,"").replace(/\*/g,"yaml@bug2")
  //2022-08-08 å¢åŠ  .replace(/\*/g,"ğŸŒŸ@bug2") ä»¥è§£å†³åå­—ä»¥ * å¼€å§‹æ—¶å¼•èµ·çš„éƒ¨åˆ†é—®é¢˜
  if (cnt.indexOf("{") != -1 && /\{\s*\"*(name|type|server)/.test(cnt)){
    cnt = cnt.replace(/(^|\n)- /g, "$1  - ").replace(/    - /g,"  - ").replace(/:(?!\s)/g,": ").replace(/\,\"/g,", \"").replace(/: {/g, ": {,   ").replace(/, (Host|host|path|mux)/g,",   $1")
    //2022-04-11 remove tls|skip from replace(/, (Host|host|path|mux)/g,",   $1")
    console.log("1st:\n"+cnt)
    cnt = cnt.replace(/{\s*name: (.*?), (.*?):/g,"{name: \"$1\", $2:") //cnt.replace(/{\s*name: /g,"{name: \"").replace(/, (.*?):/,"\", $1:")
    cnt = cnt.replace(/{\s*|\s*}/g,"").replace(/,/g,"\n   ")
  }
  cnt = cnt.replace(/\n\s*\-\s*\n.*name/g,"\n  - name").replace(/\$|\`/g,"").split("proxy-providers:")[0].split("proxy-groups:")[0].replace(/\"(name|type|server|port|cipher|password|uuid|alterId|udp)(\"*)/g,"$1")
    if(Pdbg == 1) {
  $notify("part-fix0:","","part-fix0:\nproxies:\n"+cnt.split("proxies:")[1])}
  // 2023-03-23  ğŸ‘‡ä¿®æ­£éƒ¨åˆ†ç±»å‹
  cnt = cnt.replace(/\n\s{2}([a-zA-Z]+.*\:)/g,"\n    $1").replace(/\n(\-.*)/g,"\n  $1")
  if(Pdbg == 1) {
  $notify("part-fix1:","","part-fix1:\nproxies:\n"+cnt.split("proxies:")[1])}
  // cnt = cnt.indexOf("proxies:") == -1? "proxies:\n" + cnt :"proxies:"+cnt.split("proxies:")[1]
  cnt = cnt.replace(/name\:(.*?)\:(.*?)\n/gmi,"name:$1å†’å·$2\n").replace(/\s{6}Host\:/g,"      Host:")//.replace(/\{\s*(Host\:.*)\}/gmi,"$1") //ç½•è§bugæƒ…å†µ ä¿®å¤
  items=cnt.split("\n").map(yamlcheck)
  cnt=items.join("\n")
  //console.log(cnt.replace(/name\:(.*?)\:(.*?)\n/gmi,"name:$1å†’å·$2"))
  //2022-05-11 å¢åŠ â¬‡ï¸
  //cnt = cnt.replace(/\n\s{4}headers/g,"\n      headers").replace(/\n\s{6}(H|h)ost/g,"\n        Host").replace(/\t/g,"")
  //2022-06-07 ä¿®æ”¹ä¸ºğŸ‘‡ï¼Œè§£å†³éƒ¨åˆ†æ—  proxies å­—æ®µçš„
  //2022-09-01 remove host in s{6}(H|h)ost
  //cnt = cnt.indexOf("proxies:") != -1?cnt.replace(/\n\s{4}headers/g,"\n      headers").replace(/\n\s{6}Host/g,"\n        Host").replace(/\t/g,""):cnt
  //2022-11-29 ä¿®æ”¹
  cnt = cnt.indexOf("proxies:") != -1 && /\n\s{4}server/.test(cnt)  ? cnt.replace(/\n\s{4}(headers|path)/g,"\n      $1").replace(/\n\s{6}Host/g,"\n        Host").replace(/\t/g,""):cnt
  //console.log("part-fix:\n"+cnt.split("proxies:")[1])
  cnt = cnt.indexOf("proxies:") == -1? "proxies:\n" + cnt :"proxies:"+cnt.split("proxies:")[1]
  console.log("after-fix\n"+cnt)
  if(Pdbg == 1) {
  $notify("After-Fix","this is", "After-fix:\n"+cnt)}
  //$notify("After-Fix","this is", cnt)

  return cnt
}


function yamlcheck(cnt){
  if (cnt.indexOf("name") !=-1){ //åå­—ä»¥æŸäº›æ•°å­—ç»“å°¾æ—¶ï¼Œè§£ææœ‰ bug
    for (var i=0;i<10;i++) {
      cnt = cnt.replace(new RegExp(patn[0][i], "gmi"),patn[4][i])
    }
    
  }
  if (/(:|-)/.test(cnt)) {
    return cnt
  }
}

// Clash parser
function Clash2QX(cnt) {
  const yaml = new YAML()
  if (Pdbg==1) { $notify(" Before YAML Parse", "content", cnt)}
  var aa = JSON.stringify(yaml.parse(YAMLFix(cnt))).replace(/yaml@bugğŸ™/g,"[").replace(/å†’å·/gmi,":").replace(/yaml@bugğŸš/g,"*")
  for (var i=0;i<10;i++) {
    aa = aa.replace(new RegExp(patn[4][i], "gmi"),patn[0][i])
  }
  var bb = JSON.parse(aa).proxies
  if (Pdbg==1) { $notify("After YAML Parse", "content", JSON.stringify(bb))}
  //console.log(bb)
  var nl = bb.length
  var nodelist=[]
  var node=""
  for (i=0; i<nl; i++){
    try{
      node=bb[i]
      typecc = node.type
      if (typecc == "ss") {
        node = CSS2QX(node)
      } else if (typecc == "ssr"){
        node = CSSR2QX(node)
      } else if (typecc == "vmess"){
        node = CV2QX(node)
      } else if (typecc == "trojan"){
        node = CT2QX(node)
      } else if (typecc == "http"){
        node = CH2QX(node)
      } else if (typecc == "socks5"){
        node = CS52QX(node)
      }
      node = Pudp0 != 0 ? XUDP(node,Pudp0) : node
      node = Ptfo0 != 0 ? XTFO(node,Ptfo0) : node
      nodelist.push(node)
    }catch (e) {
      $notify(`âš ï¸è¯¥èŠ‚ç‚¹è§£æé”™è¯¯, æš‚æ—¶å·²å¿½ç•¥å¤„ç†`,`å¯ç‚¹å‡»é€šçŸ¥å¹¶å‘é€é“¾æ¥åé¦ˆè‡³ bot`,JSON.stringify(node),bug_link )
      $notify(`âš ï¸é”™è¯¯å†…å®¹å¦‚ä¸‹`,`å¯å¤åˆ¶é”™è¯¯å†…å®¹åˆ°åé¦ˆ bot`,JSON.stringify(node)+"\n\n"+e)
    }
  }
  return nodelist.join("\n")
}

//Clash ss type server
function CSS2QX(cnt) {
  tag = "tag="+cnt.name.replace(/\\U.+?\s{1}/gi,"")
  ipt = cnt.server+":"+cnt.port
  pwd = "password=" + cnt.password
  mtd = "method="+ cnt.cipher
  udp = cnt.udp ? "udp-relay=true" : "udp-relay=false"
  uot = cnt["udp-over-tcp"] ?  "udp-over-tcp=true" : "udp-over-tcp=false"
  tfo = cnt.tfo ? "fast-open=true" : "fast-open=false"
  obfs = cnt["plugin-opts"] ? "obfs=" + cnt["plugin-opts"].mode : ""
  ohost = cnt["plugin-opts"] ? "obfs-host=" + cnt["plugin-opts"].host : ""
  ouri = ""
  cert = ""
  if (obfs.indexOf("websocket") != -1) {
      obfs = cnt["plugin-opts"].tls? "obfs=wss" : "obfs=ws"
      ohost = cnt["plugin-opts"].host? "obfs-host=" + cnt["plugin-opts"].host:""
      ouri = cnt["plugin-opts"].path? "obfs-uri=" + cnt["plugin-opts"].path: ""
    if (obfs == "obfs=wss") { // tls verification
      cert = Pcert0 == 1? "" : "tls-verification =false"}
  }
  node = "shadowsocks="+[ipt, pwd, mtd, udp, uot, tfo, obfs, ohost, ouri, cert, tag].filter(Boolean).join(", ")
  return node
}

//Clash ssr type server
function CSSR2QX(cnt) {
  tag = "tag="+cnt.name.replace(/\\U.+?\s{1}/gi,"")
  ipt = cnt.server+":"+cnt.port
  pwd = "password=" + cnt.password
  mtd = "method="+ cnt.cipher
  udp = cnt.udp ? "udp-relay=true" : "udp-relay=false"
  tfo = cnt.tfo ? "fast-open=true" : "fast-open=false"
  prot = "ssr-protocol=" + cnt.protocol
  ohost=""
  ppara=""
  if(cnt["protocolparam"]) {
    cnt["protocol-param"] = cnt["protocolparam"]
  }
  if (typeof(cnt["protocol-param"]) == "string") {
    ppara = "ssr-protocol-param=" + cnt["protocol-param"]
  } else if (typeof(cnt["protocol-param"]) == "object") {
    console.log(typeof(cnt["protocol-param"]))
    ppara = "ssr-protocol-param=" + JSON.stringify(cnt["protocol-param"]).replace(/{|}|\s|"/g,"")
  }
  obfs = "obfs=" + cnt.obfs
  if ( cnt["obfs-param"]) {
     ohost = "obfs-host=" + cnt["obfs-param"]
  } else if (cnt["obfsparam"]) {
     ohost = "obfs-host=" + cnt["obfsparam"]
  }
 
  node = "shadowsocks="+[ipt, pwd, mtd, udp, tfo, prot, ppara, obfs, ohost, tag].filter(Boolean).join(", ")
  //console.log(node)
  return node
}


//Clash vmess type server
function CV2QX(cnt) {
  tag = "tag="+cnt.name.replace(/\\U.+?\s{1}/gi," ")
  ipt = cnt.server+":"+cnt.port
  pwd = "password=" + cnt.uuid
  mtd = "method="+ "aes-128-gcm" //cnt.cipher
  udp = cnt.udp ? "udp-relay=false" : "udp-relay=false" //æš‚ä¸æ”¯æŒ
  tfo = cnt.tfo ? "fast-open=true" : "fast-open=false"
  obfs = ""
  if (cnt.network == "ws" && cnt.tls) {
    obfs = "obfs=wss"
  } else if (cnt.network == "ws"){
    obfs = "obfs=ws"
  } else if (cnt.network == "http"){
    obfs = "obfs=http"
  } else if (cnt.tls){
    obfs = "obfs=over-tls"
  }
  console.log(obfs)
  const phost = getValue(()=>cnt["ws-opts"]["headers"]["Host"]) 
  ohost = cnt["ws-headers"]? "obfs-host=" + cnt["ws-headers"]["Host"] : ""
  ohost = phost ? "obfs-host="+phost : ohost
  //ohost= cnt["ws-opts"]? "obfs-host=" + cnt["ws-opts"]["headers"]["Host"] : ohost
  ohost = cnt["servername"]? "obfs-host=" + cnt["servername"] : ohost
  console.log(ohost)
  ouri = cnt["ws-path"]? "obfs-uri="+cnt["ws-path"] : ""
  ouri = cnt["ws-opts"]? "obfs-uri="+cnt["ws-opts"]["path"] : ouri
  cert = cnt["skip-cert-verify"] && cnt.tls ? "tls-verification=false" : ""
  caead = cnt["alterId"] && cnt["alterId"]!=0? "aead=false" : "" // aead é€‰é¡¹
  //caead = cnt["alterId"] == 0? "aead=true" : caead // aead é€‰é¡¹
  console.log(caead)
  //caead=""
  //$notify(cert)
  if (Pcert0 == 1 && cnt.tls) {
    cert = "tls-verification=true"
  } else if (Pcert0 != 1 && cnt.tls) {
    cert = "tls-verification=false"
  }
  node = "vmess="+[ipt, pwd, mtd, udp, tfo, obfs, ohost, ouri, cert, caead, tag].filter(Boolean).join(", ")
  //console.log(node)
  return node
}


//Clash Trojan
function CT2QX(cnt) {
  tag = "tag="+cnt.name.replace(/\\U.+?\s{1}/gi," ")
  ipt = cnt.server+":"+cnt.port
  pwd = "password=" + cnt.password
  otls = "over-tls=true"
  opath=""
  ohost=""
  cert = cnt["skip-cert-verify"] ? "tls-verification=false" : "tls-verification=true"
  cert = Pcert0 == 1 ? "tls-verification=true" : "tls-verification=false"
  tls13 = PTls13 == 1 ? "tls13=true" : "tls13=false"
  udp = cnt.udp ? "udp-relay=false" : "udp-relay=false"
  tfo = cnt.tfo ? "fast-open=true" : "fast-open=false"
  if (cnt.network=="ws") { //wssç±»å‹
    otls = "obfs=wss"
    //$notify("trojan","WS",JSON.stringify(cnt))
    if (cnt["ws-opts"]){
    opath = cnt["ws-opts"]["path"]? "obfs-uri="+cnt["ws-opts"]["path"] : ""
    ohost = cnt["ws-opts"]["headers"]? "obfs-host="+cnt["ws-opts"]["headers"]["Host"] : ""
    }
    //$notify("trojan","WS",opath+":"+ohost)
  }
  node = "trojan="+[ipt, pwd, otls, opath, ohost, cert, tls13, udp, tfo, tag].filter(Boolean).join(", ")
  //console.log(node)
  return node

}

// Clash http
function CH2QX(cnt){
    tag = "tag="+cnt.name.replace(/\\U.+?\s{1}/gi," ")
    ipt = cnt.server+":"+cnt.port
    uname = cnt.username ? "username=" + cnt.username : ""
    pwd = cnt.password && typeof(cnt.password) == "string" ? "password=" + cnt.password : ""
    tls = cnt.tls ? "over-tls=true" : ""
    cert = cnt["skip-cert-verify"] && cnt.tls ? "tls-verification=false" : ""
    if (Pcert0 == 1 && cnt.tls) {
      cert = "tls-verification=true"
    } else if (Pcert0 != 1 && cnt.tls) {
      cert = "tls-verification=false"
    }
    node = "http="+[ipt, uname, pwd, tls, cert, tag].filter(Boolean).join(", ")
    //console.log(node)
    return node
}

// Clash socks5
function CS52QX(cnt){
    tag = "tag="+cnt.name.replace(/\\U.+?\s{1}/gi," ")
    ipt = cnt.server+":"+cnt.port
    uname = cnt.username ? "username=" + cnt.username : ""
    pwd = cnt.password && typeof(cnt.password) == "string" ? "password=" + cnt.password : ""
    tls = cnt.tls ? "over-tls=true" : ""
    cert = cnt["skip-cert-verify"] && cnt.tls ? "tls-verification=false" : ""
    if (Pcert0 == 1 && cnt.tls) {
      cert = "tls-verification=true"
    } else if (Pcert0 != 1 && cnt.tls) {
      cert = "tls-verification=false"
    }
    node = "socks5="+[ipt, uname, pwd, tls, cert, tag].filter(Boolean).join(", ")
    //console.log(node)
    return node
}


// UDP/TFO å‚æ•° (å¼ºåˆ¶ surge/quanx ç±»å‹è½¬æ¢)
function XUDP(cnt,pudp) {
  var udp = pudp == 1 && /^(shadowsocks|trojan|vmess)/.test(cnt.trim()) ? "udp-relay=true, " : "udp-relay=false, "
  if(cnt.indexOf("udp-relay") != -1){
    var cnt0 = cnt.replace(RegExp("udp\-relay.*?\,", "gmi"), udp)
  }else{
    var cnt0 = cnt.replace(new RegExp("tag.*?\=", "gmi"), udp+"tag=")
  }
  //console.log("UDP-Handle","",cnt0)
  return cnt0
}

function XTFO(cnt,ptfo) {
    var tfo = ptfo == 1? "fast-open=true, " : "fast-open=false, "
    if(cnt.indexOf("fast-open") != -1){
        var cnt0 = cnt.replace(RegExp("fast\-open.*?\,", "gmi"), tfo)
    }else{
        var cnt0 = cnt.replace(RegExp("tag.*?\=", "gmi"), tfo+"tag=")
    }
    return cnt0
}


// udp-over-tcp=true  å¼€å¯
function UOT(cnt) {
  cnts=cnt.replace(/\s*/g,"")
  if(/^shadowsocks=/.test(cnts)) {
    cnt= cnts.indexOf("udp-over-tcp")!=-1? cnt.replace(/udp-over-tcp\s*\=\s*false/g,"udp-over-tcp=true") : cnt+", udp-over-tcp=true"
    
  }
  return cnt
}

//æ¯”è¾ƒå®Œç¾çš„ä¸€æ¬¾ base64 encode/decode å·¥å…·
/*
 *  base64.js: https://github.com/dankogai/js-base64#readme
 *
 *  Licensed under the BSD 3-Clause License.
 *    http://opensource.org/licenses/BSD-3-Clause
 *
 *  References:
 *    http://en.wikipedia.org/wiki/Base64
 */
//base64 å®Œæ¯•
function Base64Code() {
    // constants
    var b64chars
        = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
    var b64tab = function (bin) {
        var t = {};
        for (var i = 0, l = bin.length; i < l; i++) t[bin.charAt(i)] = i;
        return t;
    }(b64chars);
    var fromCharCode = String.fromCharCode;
    // encoder stuff
    var cb_utob = function (c) {
        if (c.length < 2) {
            var cc = c.charCodeAt(0);
            return cc < 0x80 ? c
                : cc < 0x800 ? (fromCharCode(0xc0 | (cc >>> 6))
                    + fromCharCode(0x80 | (cc & 0x3f)))
                    : (fromCharCode(0xe0 | ((cc >>> 12) & 0x0f))
                        + fromCharCode(0x80 | ((cc >>> 6) & 0x3f))
                        + fromCharCode(0x80 | (cc & 0x3f)));
        } else {
            var cc = 0x10000
                + (c.charCodeAt(0) - 0xD800) * 0x400
                + (c.charCodeAt(1) - 0xDC00);
            return (fromCharCode(0xf0 | ((cc >>> 18) & 0x07))
                + fromCharCode(0x80 | ((cc >>> 12) & 0x3f))
                + fromCharCode(0x80 | ((cc >>> 6) & 0x3f))
                + fromCharCode(0x80 | (cc & 0x3f)));
        }
    };
    var re_utob = /[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;
    var utob = function (u) {
        return u.replace(re_utob, cb_utob);
    };
    var cb_encode = function (ccc) {
        var padlen = [0, 2, 1][ccc.length % 3],
            ord = ccc.charCodeAt(0) << 16
                | ((ccc.length > 1 ? ccc.charCodeAt(1) : 0) << 8)
                | ((ccc.length > 2 ? ccc.charCodeAt(2) : 0)),
            chars = [
                b64chars.charAt(ord >>> 18),
                b64chars.charAt((ord >>> 12) & 63),
                padlen >= 2 ? '=' : b64chars.charAt((ord >>> 6) & 63),
                padlen >= 1 ? '=' : b64chars.charAt(ord & 63)
            ];
        return chars.join('');
    };
    var btoa = function (b) {
        return b.replace(/[\s\S]{1,3}/g, cb_encode);
    };
    // var _encode = function(u) {
    //  var isUint8Array = Object.prototype.toString.call(u) === '[object Uint8Array]';
    //  return isUint8Array ? u.toString('base64')
    //    : btoa(utob(String(u)));
    // }
    this.encode = function (u) {
        var isUint8Array = Object.prototype.toString.call(u) === '[object Uint8Array]';
        return isUint8Array ? u.toString('base64')
            : btoa(utob(String(u)));
    }
    var uriencode = function (u, urisafe) {
        return !urisafe
            ? _encode(u)
            : _encode(String(u)).replace(/[+\/]/g, function (m0) {
                return m0 == '+' ? '-' : '_';
            }).replace(/=/g, '');
    };
    var encodeURI = function (u) { return uriencode(u, true) };
    // decoder stuff
    var re_btou = /[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g;
    var cb_btou = function (cccc) {
        switch (cccc.length) {
            case 4:
                var cp = ((0x07 & cccc.charCodeAt(0)) << 18)
                    | ((0x3f & cccc.charCodeAt(1)) << 12)
                    | ((0x3f & cccc.charCodeAt(2)) << 6)
                    | (0x3f & cccc.charCodeAt(3)),
                    offset = cp - 0x10000;
                return (fromCharCode((offset >>> 10) + 0xD800)
                    + fromCharCode((offset & 0x3FF) + 0xDC00));
            case 3:
                return fromCharCode(
                    ((0x0f & cccc.charCodeAt(0)) << 12)
                    | ((0x3f & cccc.charCodeAt(1)) << 6)
                    | (0x3f & cccc.charCodeAt(2))
                );
            default:
                return fromCharCode(
                    ((0x1f & cccc.charCodeAt(0)) << 6)
                    | (0x3f & cccc.charCodeAt(1))
                );
        }
    };
    var btou = function (b) {
        return b.replace(re_btou, cb_btou);
    };
    var cb_decode = function (cccc) {
        var len = cccc.length,
            padlen = len % 4,
            n = (len > 0 ? b64tab[cccc.charAt(0)] << 18 : 0)
                | (len > 1 ? b64tab[cccc.charAt(1)] << 12 : 0)
                | (len > 2 ? b64tab[cccc.charAt(2)] << 6 : 0)
                | (len > 3 ? b64tab[cccc.charAt(3)] : 0),
            chars = [
                fromCharCode(n >>> 16),
                fromCharCode((n >>> 8) & 0xff),
                fromCharCode(n & 0xff)
            ];
        chars.length -= [0, 0, 2, 1][padlen];
        return chars.join('');
    };
    var _atob = function (a) {
        return a.replace(/\S{1,4}/g, cb_decode);
    };
    var atob = function (a) {
        return _atob(String(a).replace(/[^A-Za-z0-9\+\/]/g, ''));
    };
    // var _decode = buffer ?
    //  buffer.from && Uint8Array && buffer.from !== Uint8Array.from
    //  ? function(a) {
    //    return (a.constructor === buffer.constructor
    //        ? a : buffer.from(a, 'base64')).toString();
    //  }
    //  : function(a) {
    //    return (a.constructor === buffer.constructor
    //        ? a : new buffer(a, 'base64')).toString();
    //  }
    //  : function(a) { return btou(_atob(a)) };
    var _decode = function (u) {
        return btou(_atob(u))
    }
    this.decode = function (a) {
        return _decode(
            String(a).replace(/[-_]/g, function (m0) { return m0 == '-' ? '+' : '/' })
                .replace(/[^A-Za-z0-9\+\/]/g, '')
        ).replace(/&gt;/g, ">").replace(/&lt;/g, "<");
    };
}


/*
YAML parser for Javascript
Author: Diogo Costa

This program is released under the MIT License as follows:

Copyright (c) 2011 Diogo Costa (costa.h4evr@gmail.com)

*/

function YAML() {
        var errors = [],
                reference_blocks = [],
                processing_time = 0,
                regex =
                {
                        "regLevel" : new RegExp("^([\\s\\-]+)"),
                        "invalidLine" : new RegExp("^\\-\\-\\-|^\\.\\.\\.|^\\s*#.*|^\\s*$"),
                        "dashesString" : new RegExp("^\\s*\\\"([^\\\"]*)\\\"\\s*$"),
                        "quotesString" : new RegExp("^\\s*\\\'([^\\\']*)\\\'\\s*$"),
                        "float" : new RegExp("^[+-]?[0-9]+\\.[0-9]+(e[+-]?[0-9]+(\\.[0-9]+)?)?$"),
                        "integer" : new RegExp("^[+-]?[0-9]+$"),
                        "array" : new RegExp("\\[\\s*(.*)\\s*\\]"),
                        "map" : new RegExp("\\{\\s*(.*)\\s*\\}"),
                        "key_value" : new RegExp("([a-z0-9_-][ a-z0-9_-]*):( .+)", "i"),
                        "single_key_value" : new RegExp("^([a-z0-9_-][ a-z0-9_-]*):( .+?)$", "i"),
                        "key" : new RegExp("([a-z0-9_-][ a-z0-9_-]+):( .+)?", "i"),
                        "item" : new RegExp("^-\\s+"),
                        "trim" : new RegExp("^\\s+|\\s+$"),
                        "comment" : new RegExp("([^\\\'\\\"#]+([\\\'\\\"][^\\\'\\\"]*[\\\'\\\"])*)*(#.*)?")
                };
 
         /**
            * @class A block of lines of a given level.
            * @param {int} lvl The block's level.
            * @private
            */
        function Block(lvl) {
                return {
                        /* The block's parent */
                        parent: null,
                        /* Number of children */
                        length: 0,
                        /* Block's level */
                        level: lvl,
                        /* Lines of code to process */
                        lines: [],
                        /* Blocks with greater level */
                        children : [],
                        /* Add a block to the children collection */
                        addChild : function(obj) {
                                this.children.push(obj);
                                obj.parent = this;
                                ++this.length;
                        }
                };
        }

        // function to create an XMLHttpClient in a cross-browser manner

        function fromURL(src, ondone) {
                var client = createXMLHTTPRequest();
                client.onreadystatechange = function() {
                        if (this.readyState == 4 || this.status == 200) {
                                var txt = this.responseText;
                                ondone(YAML.eval0(txt));
                        }
                };
                client.open('GET', src);
                client.send();
        }

        function parser(str) {
                var regLevel = regex["regLevel"];
                var invalidLine = regex["invalidLine"];
                var lines = str.split("\n");
                var m;
                var level = 0, curLevel = 0;
                
                var blocks = [];
                
                var result = new Block(-1);
                var currentBlock = new Block(0);
                result.addChild(currentBlock);
                var levels = [];
                var line = "";
                
                blocks.push(currentBlock);
                levels.push(level);
                
                for(var i = 0, len = lines.length; i < len; ++i) {
                        line = lines[i];
                        
                        if(line.match(invalidLine)) {
                                continue;
                        }
                
                        if(m = regLevel.exec(line)) {
                                level = m[1].length;
                        } else
                                level = 0;
                        
                        if(level > curLevel) {
                                var oldBlock = currentBlock;
                                currentBlock = new Block(level);
                                oldBlock.addChild(currentBlock);
                                blocks.push(currentBlock);
                                levels.push(level);
                        } else if(level < curLevel) {                
                                var added = false;

                                var k = levels.length - 1;
                                for(; k >= 0; --k) {
                                        if(levels[k] == level) {
                                                currentBlock = new Block(level);
                                                blocks.push(currentBlock);
                                                levels.push(level);
                                                if(blocks[k].parent!= null)
                                                        blocks[k].parent.addChild(currentBlock);
                                                added = true;
                                                break;
                                        }
                                }
                                
                                if(!added) {
                                        errors.push("Error: Invalid indentation at line " + i + ": " + line);
                                        return;
                                }
                        }
                        
                        currentBlock.lines.push(line.replace(regex["trim"], ""));
                        curLevel = level;
                }
                
                return result;
        }
        
        function processValue(val) {
                val = val.replace(regex["trim"], "");
                var m = null;

                if(val == 'true') {
                        return true;
                } else if(val == 'false') {
                        return false;
                } else if(val == '.NaN') {
                        return Number.NaN;
                } else if(val == 'null') {
                        return null;
                } else if(val == '.inf') {
                        return Number.POSITIVE_INFINITY;
                } else if(val == '-.inf') {
                        return Number.NEGATIVE_INFINITY;
                } else if(m = val.match(regex["dashesString"])) {
                        return m[1];
                } else if(m = val.match(regex["quotesString"])) {
                        return m[1];
                } else if(m = val.match(regex["float"])) {
                        return parseFloat(m[0]);
                } else if(m = val.match(regex["integer"])) {
                        return parseInt(m[0]);
                } else if( !isNaN(m = Date.parse(val))) {
                        return new Date(m);
                } else if(m = val.match(regex["single_key_value"])) {
                        var res = {};
                        res[m[1]] = processValue(m[2]);
                        return res;
                } else if(m = val.match(regex["array"])){
                        var count = 0, c = ' ';
                        var res = [];
                        var content = "";
                        var str = false;
                        for(var j = 0, lenJ = m[1].length; j < lenJ; ++j) {
                                c = m[1][j];
                                if(c == '\'' || c == '"') {
                                        if(str === false) {
                                                str = c;
                                                content += c;
                                                continue;
                                        } else if((c == '\'' && str == '\'') || (c == '"' && str == '"')) {
                                                str = false;
                                                content += c;
                                                continue;
                                        }
                                } else if(str === false && (c == '[' || c == '{')) {
                                        ++count;
                                } else if(str === false && (c == ']' || c == '}')) {
                                        --count;
                                } else if(str === false && count == 0 && c == ',') {
                                        res.push(processValue(content));
                                        content = "";
                                        continue;
                                }
                                
                                content += c;
                        }
                        
                        if(content.length > 0)
                                res.push(processValue(content));
                        return res;
                } else if(m = val.match(regex["map"])){
                        var count = 0, c = ' ';
                        var res = [];
                        var content = "";
                        var str = false;
                        for(var j = 0, lenJ = m[1].length; j < lenJ; ++j) {
                                c = m[1][j];
                                if(c == '\'' || c == '"') {
                                        if(str === false) {
                                                str = c;
                                                content += c;
                                                continue;
                                        } else if((c == '\'' && str == '\'') || (c == '"' && str == '"')) {
                                                str = false;
                                                content += c;
                                                continue;
                                        }
                                } else if(str === false && (c == '[' || c == '{')) {
                                        ++count;
                                } else if(str === false && (c == ']' || c == '}')) {
                                        --count;
                                } else if(str === false && count == 0 && c == ',') {
                                        res.push(content);
                                        content = "";
                                        continue;
                                }
                                
                                content += c;
                        }
                        
                        if(content.length > 0)
                                res.push(content);
                                
                        var newRes = {};
                        for(var j = 0, lenJ = res.length; j < lenJ; ++j) {
                                if(m = res[j].match(regex["key_value"])) {
                                        newRes[m[1]] = processValue(m[2]);
                                }
                        }
                        
                        return newRes;
                } else 
                        return val;
        }
        
        function processFoldedBlock(block) {
                var lines = block.lines;
                var children = block.children;
                var str = lines.join(" ");
                var chunks = [str];
                for(var i = 0, len = children.length; i < len; ++i) {
                        chunks.push(processFoldedBlock(children[i]));
                }
                return chunks.join("\n");
        }
        
        function processLiteralBlock(block) {
                var lines = block.lines;
                var children = block.children;
                var str = lines.join("\n");
                for(var i = 0, len = children.length; i < len; ++i) {
                        str += processLiteralBlock(children[i]);
                }
                return str;
        }
        
        function processBlock(blocks) {
                var m = null;
                var res = {};
                var lines = null;
                var children = null;
                var currentObj = null;
                
                var level = -1;
                
                var processedBlocks = [];
                
                var isMap = true;
                
                for(var j = 0, lenJ = blocks.length; j < lenJ; ++j) {
                        
                        if(level != -1 && level != blocks[j].level)
                                continue;
                
                        processedBlocks.push(j);
                
                        level = blocks[j].level;
                        lines = blocks[j].lines;
                        children = blocks[j].children;
                        currentObj = null;
                
                        for(var i = 0, len = lines.length; i < len; ++i) {
                                var line = lines[i];

                                if(m = line.match(regex["key"])) {
                                        var key = m[1];
                                        
                                        if(key[0] == '-') {
                                                key = key.replace(regex["item"], "");
                                                if (isMap) { 
                                                        isMap = false;
                                                        if (typeof(res.length) === "undefined") {
                                                                res = [];
                                                        } 
                                                }
                                                if(currentObj != null) res.push(currentObj);
                                                currentObj = {};
                                                isMap = true;
                                        }
                                        
                                        if(typeof m[2] != "undefined") {
                                                var value = m[2].replace(regex["trim"], "");
                                                if(value[0] == '&') {
                                                        var nb = processBlock(children);
                                                        if(currentObj != null) currentObj[key] = nb;
                                                        else res[key] = nb;
                                                        reference_blocks[value.substr(1)] = nb;
                                                } else if(value[0] == '|') {
                                                        if(currentObj != null) currentObj[key] = processLiteralBlock(children.shift());
                                                        else res[key] = processLiteralBlock(children.shift());
                                                } else if(value[0] == '*') {
                                                        var v = value.substr(1);
                                                        var no = {};
                                                        
                                                        if(typeof reference_blocks[v] == "undefined") {
                                                                errors.push("Reference '" + v + "' not found!");
                                                        } else {
                                                                for(var k in reference_blocks[v]) {
                                                                        no[k] = reference_blocks[v][k];
                                                                }
                                                                
                                                                if(currentObj != null) currentObj[key] = no;
                                                                else res[key] = no;
                                                        }
                                                } else if(value[0] == '>') {
                                                        if(currentObj != null) currentObj[key] = processFoldedBlock(children.shift());
                                                        else res[key] = processFoldedBlock(children.shift());
                                                } else {
                                                        if(currentObj != null) currentObj[key] = processValue(value);
                                                        else res[key] = processValue(value);
                                                }
                                        } else {
                                                if(currentObj != null) currentObj[key] = processBlock(children);
                                                else res[key] = processBlock(children);                        
                                        }
                                } else if(line.match(/^-\s*$/)) {
                                        if (isMap) { 
                                                isMap = false;
                                                if (typeof(res.length) === "undefined") {
                                                        res = [];
                                                } 
                                        }
                                        if(currentObj != null) res.push(currentObj);
                                        currentObj = {};
                                        isMap = true;
                                        continue;
                                } else if(m = line.match(/^-\s*(.*)/)) {
                                        if(currentObj != null) 
                                                currentObj.push(processValue(m[1]));
                                        else {
                                                if (isMap) { 
                                                        isMap = false;
                                                        if (typeof(res.length) === "undefined") {
                                                                res = [];
                                                        } 
                                                }
                                                res.push(processValue(m[1]));
                                        }
                                        continue;
                                }
                        }
                        
                        if(currentObj != null) {
                                if (isMap) { 
                                        isMap = false;
                                        if (typeof(res.length) === "undefined") {
                                                res = [];
                                        } 
                                }
                                res.push(currentObj);
                        }
                }
                
                for(var j = processedBlocks.length - 1; j >= 0; --j) {
                        blocks.splice.call(blocks, processedBlocks[j], 1);
                }

                return res;
        }
                
        function semanticAnalysis(blocks) {
                var res = processBlock(blocks.children);
                return res;
        }
        
        function preProcess(src) {
                var m;
                var lines = src.split("\n");
                
                var r = regex["comment"];
                
                for(var i in lines) {
                        if(m = lines[i].match(r)) {
/*                var cmt = "";
                                if(typeof m[3] != "undefined")
                                        lines[i] = m[1];
                                else if(typeof m[3] != "undefined")
                                        lines[i] = m[3]; 
                                else
                                        lines[i] = "";
                                        */
                                if(typeof m[3] !== "undefined") {
                                        lines[i] = m[0].substr(0, m[0].length - m[3].length);
                                }
                        }
                }
                
                return lines.join("\n");
        }
        
        this.parse = function eval0(str) {
                errors = [];
                reference_blocks = [];
                processing_time = (new Date()).getTime();
                var pre = preProcess(str)
                var doc = parser(pre);
                var res = semanticAnalysis(doc);
                processing_time = (new Date()).getTime() - processing_time;
                
                return res;
        }

};


/***********************************************************************************************/
function Tools() {
    const filter = (src, ...regex) => {
        const initial = [...Array(src.length).keys()].map(() => false);
        return regex.reduce((a, expr) => OR(a, src.map(item => expr.test(item))), initial)
    }

    const rename = {
        replace: (src, old, now) => {
            return src.map(item => item.replace(old, now));
        },

        delete: (src, ...args) => {
            return src.map(item => args.reduce((now, expr) => now.replace(expr, ''), item));
        },

        trim: (src) => {
            return src.map(item => item.trim().replace(/[^\S\r\n]{2,}/g, ' '));
        }
    }

    const getNodeInfo = servers => {
        const nodes = {
            names: servers.map(s => s.split("tag=")[1]),
            types: servers.map(s => {
                const type = s.match(/^(vmess|trojan|shadowsocks|http)=/);
                return type ? type[1] : 'unknown';
            })
        };
        return nodes;
    }


    return {
        filter, rename, getNodeInfo
    }
}

function AND(...args) {
    return args.reduce((a, b) => a.map((c, i) => b[i] && c));
}

function OR(...args) {
    return args.reduce((a, b) => a.map((c, i) => b[i] || c))
}

function NOT(array) {
    return array.map(c => !c);
}
